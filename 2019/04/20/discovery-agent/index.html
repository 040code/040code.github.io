<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet"/><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous"/><style data-href="/styles.131b48b25a50eff60b34.css">code[class*=language-],pre[class*=language-]{color:#ccc;background:none;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.block-comment,.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#999}.token.punctuation{color:#ccc}.token.attr-name,.token.deleted,.token.namespace,.token.tag{color:#e2777a}.token.function-name{color:#6196cc}.token.boolean,.token.function,.token.number{color:#f08d49}.token.class-name,.token.constant,.token.property,.token.symbol{color:#f8c555}.token.atrule,.token.builtin,.token.important,.token.keyword,.token.selector{color:#cc99cd}.token.attr-value,.token.char,.token.regex,.token.string,.token.variable{color:#7ec699}.token.entity,.token.operator,.token.url{color:#67cdcc}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.token.inserted{color:green}</style><meta name="generator" content="Gatsby 2.4.2"/><style type="text/css">
    .anchor {
      float: left;
      padding-right: 4px;
      margin-left: -20px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var offset = element.offsetTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><link rel="preconnect dns-prefetch" href="https://www.google-analytics.com"/><link rel="alternate" type="application/rss+xml" href="/rss.xml"/><style data-styled="hTmxqc lcZENV lfoWPa hPmQYh dANmgz brBAvj hpDnww bWPqAN hwkicN iTdcdb jRHVYT kQWgFX itRnbT jNHeyA hFicPH" data-styled-version="4.3.2">
/* sc-component-id: SideMenu__StyledBurgerMenu-uekpe8-0 */
.hTmxqc .bm-burger-button{position:fixed;width:36px;height:30px;left:36px;top:36px;} .hTmxqc .bm-burger-bars{background:#ffffff;} .hTmxqc .bm-cross-button{height:24px;width:24px;} .hTmxqc .bm-cross{background:#ffffff;} .hTmxqc .bm-menu{background:rgb(0,0,0,0.5);padding:2.5em 1em 0;font-size:1.15em;} .hTmxqc .bm-morph-shape{fill:#373a47;} .hTmxqc .bm-item-list{padding-top:2em;} .hTmxqc .bm-item{display:inline-block;padding:0.5em;} .hTmxqc .bm-overlay{background:rgba(0,0,0,0.3);}
/* sc-component-id: SideMenu__MenuLink-uekpe8-1 */
.lcZENV{position:relative;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:#fff;border:0;margin:0;margin-right:0.5rem;padding-left:20px;padding-right:20px;min-width:42px;z-index:10;}
/* sc-component-id: Footer__FooterWrapper-sc-1oxe0wr-0 */
.hFicPH{text-align:left;padding-top:30px;padding-bottom:50px;background-color:rgba(32,35,42,0.85);color:#ffffff;padding-left:20px;padding-right:20px;margin:3.5em auto 0 0;} .hFicPH nav{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-flow:row wrap;-ms-flex-flow:row wrap;flex-flow:row wrap;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;max-width:900px;margin:0 auto;} .hFicPH nav .footer-col{-webkit-flex:1 auto;-ms-flex:1 auto;flex:1 auto;display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;margin-bottom:1em;padding-right:1em;} .hFicPH a{color:#ffffff;font-weight:bold;} .hFicPH a:hover{color:#e8e8e8;border-bottom:1px dotted #e8e8e8;} .hFicPH .footer-col > p{margin:0;} .hFicPH .footer-title{margin:0 0 1rem;} .hFicPH .footer-item{padding:0.25rem 0;color:#ffffff;} .hFicPH .footer-heart{color:red;} .hFicPH .footer-item-text{padding:0.1rem 0;color:#ffffff;} .hFicPH .footer-header{-webkit-order:1;-ms-flex-order:1;order:1;margin:0 0.25rem;margin-right:0.25rem;padding:0.25rem;} @media (max-width:564px){.hFicPH .footer-col:first-child{width:100%;}}
/* sc-component-id: sc-global-3886539976 */
*{box-sizing:border-box;margin:0;padding:0;} body{font-family:"Lato",sans-serif;color:#222222cc;background-color:#e8e8e8;} img{max-width:100%;height:auto;vertical-align:middle;border:0;} a{-webkit-text-decoration:none;text-decoration:none;color:rgba(34,34,34,0.8);} ul,ol{padding-left:2em;margin:1em 0 0 0;}
/* sc-component-id: Wrapper-aej7i5-0 */
.hwkicN{position:relative;border-radius:3px;width:80%;max-width:770px;border-bottom:1px solid #ebf2f6;word-wrap:break-word;background-color:#fff;margin:0px auto 30px auto;top:30px;padding:50px;box-shadow:0 0 0 0,0 6px 12px rgba(0,0,0,0.1);} @media (max-width:780px){.hwkicN{width:90%;padding:25px;}}
/* sc-component-id: Hero__HeroContainer-sc-1i1rqpz-0 */
.lfoWPa{position:relative;display:table;width:100%;height:340px;overflow:hidden;background-repeat:no-repeat;background-position:center;background-size:cover;}
/* sc-component-id: Hero__TitleContainer-sc-1i1rqpz-1 */
.hPmQYh{display:table-cell;vertical-align:middle;text-align:center;width:100%;}
/* sc-component-id: Hero__HeroTitle-sc-1i1rqpz-3 */
.dANmgz{font-size:3.5rem;margin:10px 60px;color:#fff;text-shadow:2px 2px #222222;font-weight:800;font-family:'Open Sans','Helvetica Neue',Helvetica,Arial,sans-serif;}
/* sc-component-id: Hero__HeroSubtitle-sc-1i1rqpz-4 */
.brBAvj{font-size:1.7rem;margin:10px 60px;color:#fff;text-shadow:2px 2px #222222;font-family:'Open Sans','Helvetica Neue',Helvetica,Arial,sans-serif;}
/* sc-component-id: Hero__DateAndAuthor-sc-1i1rqpz-5 */
.hpDnww{font-weight:500;font-size:1.2rem;color:#fff;text-shadow:2px 2px #222222;}
/* sc-component-id: Hero__AuthorLink-sc-1i1rqpz-6 */
.bWPqAN{margin-left:0.3rem;font-weight:500;font-size:1.2rem;color:#fff;text-shadow:2px 2px #222222;} .bWPqAN:hover{border-bottom:1px dotted #787676;} .bWPqAN:before{content:'@';}
/* sc-component-id: TagList__ListContainer-sc-1uj42o2-0 */
.kQWgFX{display:inline;margin:0 0.5rem 0 0;color:#787676;}
/* sc-component-id: TagList__TagListItem-sc-1uj42o2-1 */
.itRnbT{margin-left:0.3rem;display:inline-block;min-width:10px;padding:3px 7px;font-size:12px;font-weight:700;line-height:1;color:#fff;text-align:center;white-space:nowrap;vertical-align:middle;background-color:#777;border-radius:10px;} .itRnbT:hover{border-bottom:1px dotted #787676;}
/* sc-component-id: ContentHeader__Header-sc-1uw779c-0 */
.jRHVYT{margin-bottom:2rem;color:#787676;}
/* sc-component-id: Content__ContentBody-sc-1jppj8x-0 */
.jNHeyA{line-height:1.6;} .jNHeyA > *:first-child{padding-top:0;margin-top:0;} .jNHeyA > h1{margin-top:3rem;font-size:2em;} .jNHeyA > h2{margin-top:3rem;font-size:1.5em;} .jNHeyA > h3{padding-top:3rem;font-size:1.17em;} .jNHeyA > p{margin:1em 0 0 0;} .jNHeyA a{border-bottom:1px dotted rgba(162,162,162,0.8);} .jNHeyA a:hover{border-bottom-style:solid;} .jNHeyA a.anchor,.jNHeyA a.gatsby-resp-image-link{border:none;} .jNHeyA > blockquote{box-sizing:border-box;margin:1.75em 0 1.75em -2.2em;padding:0 0 0 1.75em;border-left:0.4em solid rgba(32,35,42,0.85);} .jNHeyA > blockquote p{margin:0.8em 0;font-style:italic;} .jNHeyA .gatsby-highlight{border-radius:5px;font-size:15px;line-height:1.7;background:#2d2d2d;color:#ffffff;border-radius:10px;overflow:auto;tab-size:1.5em;margin:1.5em 0em 1.5em 0;font-size:0.7em;} .jNHeyA .gatsby-highlight > pre{border:0;margin:0;padding:1;} .jNHeyA .gatsby-highlight-code-line{background-color:#022a4b;display:block;margin-right:-1em;margin-left:-1em;padding-right:1em;padding-left:0.75em;border-left:0.25em solid #ffa7c4;} .jNHeyA p > code.language-text,.jNHeyA li > code.language-text{background:rgba(255,229,100,0.2);color:#222222cc;padding:0 3px;font-size:0.94em;border-radius:0.3rem;} .jNHeyA table{margin-top:1em;border-collapse:collapse;border-radius:0.5em;overflow:hidden;} .jNHeyA table th,.jNHeyA table td{padding:0.5em;background:#e8e8e8;border-bottom:2px solid white;} .jNHeyA:not(pre) a code[class*='language-']{color:#222222cc;background-color:rgba(255,229,100,0.2);}
/* sc-component-id: Article__ArticleWrapper-sc-1nyoqfc-0 */
.iTdcdb{padding:0 30px 30px;} @media only screen and (max-width:500px){.iTdcdb{padding:0;}}</style><title data-react-helmet="true">Discover the exposed port | 040code</title><link data-react-helmet="true" rel="canonical" href="https://040code.github.io/2019/04/20/discovery-agent"/><meta data-react-helmet="true" name="description" content="Update 2018-02-14, since Amazon has introduced a feature to extract meta data at runtime in a container the discovery agent described in…"/><meta data-react-helmet="true" property="og:url" content="https://040code.github.io/2019/04/20/discovery-agent"/><meta data-react-helmet="true" property="og:type" content="article"/><meta data-react-helmet="true" property="og:title" content="Discover the exposed port | 040code"/><meta data-react-helmet="true" property="og:description" content="Update 2018-02-14, since Amazon has introduced a feature to extract meta data at runtime in a container the discovery agent described in…"/><meta data-react-helmet="true" property="og:image" content="https://040code.github.io/static/2019-04-20-discovery-agent-fb-36d76c188d5a19fe2c90f56d755a1ec7.png"/><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"/><meta data-react-helmet="true" name="twitter:creator" content="niekos77"/><meta data-react-helmet="true" name="twitter:title" content="Discover the exposed port | 040code"/><meta data-react-helmet="true" name="twitter:description" content="Update 2018-02-14, since Amazon has introduced a feature to extract meta data at runtime in a container the discovery agent described in…"/><meta data-react-helmet="true" name="twitter:image" content="https://040code.github.io/static/2019-04-20-discovery-agent-tw-d4a1fef152bac0814c246179261ca3c6.png"/><link rel="shortcut icon" href="/icons/icon-48x48.png?v=008654519ce705ac7bc44303a9014606"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#222222"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=008654519ce705ac7bc44303a9014606"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=008654519ce705ac7bc44303a9014606"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=008654519ce705ac7bc44303a9014606"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=008654519ce705ac7bc44303a9014606"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=008654519ce705ac7bc44303a9014606"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=008654519ce705ac7bc44303a9014606"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=008654519ce705ac7bc44303a9014606"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=008654519ce705ac7bc44303a9014606"/><link as="script" rel="preload" href="/component---src-templates-blog-post-js-196251b58308a4713b67.js"/><link as="script" rel="preload" href="/app-84bfed4ad145c677057d.js"/><link as="script" rel="preload" href="/3-07d97d9f6ddaf6089fbb.js"/><link as="script" rel="preload" href="/1-a64b98d1bd63886934eb.js"/><link as="script" rel="preload" href="/styles-347315f8df6c6f773751.js"/><link as="script" rel="preload" href="/webpack-runtime-a0839e02624f9be751ba.js"/><link as="fetch" rel="preload" href="/static/d/409/path---2019-04-20-discovery-agent-aba-f6c-L7HF4RhKEgydBGBWvG5a9I6WMc.json" crossorigin="use-credentials"/></head><body><noscript>This site runs best with JavaScript enabled.</noscript><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group"><div class="SideMenu__StyledBurgerMenu-uekpe8-0 hTmxqc"><div><div class="bm-overlay" style="position:fixed;z-index:1000;width:100%;height:100%;background:rgba(0, 0, 0, 0.3);opacity:0;-moz-transform:translate3d(100%, 0, 0);-ms-transform:translate3d(100%, 0, 0);-o-transform:translate3d(100%, 0, 0);-webkit-transform:translate3d(100%, 0, 0);transform:translate3d(100%, 0, 0);transition:opacity 0.3s, transform 0s 0.3s"></div><div id="" class="bm-menu-wrap" style="position:fixed;right:inherit;z-index:1100;width:300px;height:100%;-moz-transform:translate3d(-100%, 0, 0);-ms-transform:translate3d(-100%, 0, 0);-o-transform:translate3d(-100%, 0, 0);-webkit-transform:translate3d(-100%, 0, 0);transform:translate3d(-100%, 0, 0);transition:all 0.5s"><div class="bm-menu" style="height:100%;box-sizing:border-box;overflow:auto"><nav class="bm-item-list" style="height:100%"><a class="bm-item SideMenu__MenuLink-uekpe8-1 lcZENV" style="display:block" tabindex="-1" href="/">🏡 040 blog</a><a class="bm-item SideMenu__MenuLink-uekpe8-1 lcZENV" style="display:block" tabindex="-1" href="/about">About</a><a class="bm-item SideMenu__MenuLink-uekpe8-1 lcZENV" style="display:block" tabindex="-1" href="/authors/niek">Niek Palm</a><a class="bm-item SideMenu__MenuLink-uekpe8-1 lcZENV" style="display:block" tabindex="-1" href="/authors/maarten">Maarten Metz</a><a class="bm-item SideMenu__MenuLink-uekpe8-1 lcZENV" style="display:block" tabindex="-1" href="/authors/jeroen">Jeroen Knoops</a><a class="bm-item SideMenu__MenuLink-uekpe8-1 lcZENV" style="display:block" tabindex="-1" href="/authors/stefan">Stefan van den Oord</a></nav></div><div><div class="bm-cross-button" style="position:absolute;width:24px;height:24px;right:8px;top:8px"><span style="position:absolute;top:6px;right:14px"><span class="bm-cross" style="position:absolute;width:3px;height:14px;transform:rotate(45deg)"></span><span class="bm-cross" style="position:absolute;width:3px;height:14px;transform:rotate(-45deg)"></span></span><button style="position:absolute;left:0;top:0;width:100%;height:100%;margin:0;padding:0;border:none;font-size:0;background:transparent;cursor:pointer" tabindex="-1">Close Menu</button></div></div></div><div><div class="bm-burger-button" style="z-index:1000"><span><span class="bm-burger-bars" style="position:absolute;height:20%;left:0;right:0;top:0%;opacity:1"></span><span class="bm-burger-bars" style="position:absolute;height:20%;left:0;right:0;top:40%;opacity:1"></span><span class="bm-burger-bars" style="position:absolute;height:20%;left:0;right:0;top:80%;opacity:1"></span></span><button style="position:absolute;left:0;top:0;width:100%;height:100%;margin:0;padding:0;border:none;font-size:0;background:transparent;cursor:pointer">Open Menu</button></div></div></div></div><div style="margin:0 0"><div style="background-image:url(&quot;/static/silly-walk-this-way-dommeltunnel-fa8b1ac5e32852678cbc2c78aa5d244d.png&quot;)" class="Hero__HeroContainer-sc-1i1rqpz-0 lfoWPa"><div class="Hero__TitleContainer-sc-1i1rqpz-1 hPmQYh"><h1 class="Hero__HeroTitle-sc-1i1rqpz-3 dANmgz">Discover the exposed port</h1><h2 class="Hero__HeroSubtitle-sc-1i1rqpz-4 brBAvj">Enabling discovery for Spring Cloud on AWS ECS</h2><span class="Hero__DateAndAuthor-sc-1i1rqpz-5 hpDnww">by:<!-- --> <a class="Hero__AuthorLink-sc-1i1rqpz-6 bWPqAN" href="/authors/niek">niek</a>  on <!-- -->2017-04-20</span></div></div><main role="main" class="Wrapper-aej7i5-0 hwkicN"><article class="Article__ArticleWrapper-sc-1nyoqfc-0 iTdcdb"><section><header class="ContentHeader__Header-sc-1uw779c-0 jRHVYT"><div class="TagList__ListContainer-sc-1uj42o2-0 kQWgFX"><a class="w3-round-size TagList__TagListItem-sc-1uj42o2-1 itRnbT" href="/tags/docker">docker</a> <a class="w3-round-size TagList__TagListItem-sc-1uj42o2-1 itRnbT" href="/tags/aws">aws</a> <a class="w3-round-size TagList__TagListItem-sc-1uj42o2-1 itRnbT" href="/tags/spring">spring</a></div></header><div class="Content__ContentBody-sc-1jppj8x-0 jNHeyA"><p><em>Update 2018-02-14, since Amazon has introduced a feature to extract meta data at runtime in a container the discovery agent described in this post becomes obsolete for the ECS case, see more <a href="/2018/02/14/service-discovery">this</a> post for more details.</em></p>
<p>This post describes a solution for implementing the discovery of the unknown exposed port by a <a href="https://www.docker.com/">Docker</a> container. A specific situation where the problem occurs is when you deploy <a href="http://projects.spring.io/spring-cloud/">Spring Cloud</a> micro services as <a href="https://aws.amazon.com/ecs/">Amazon ECS</a> services to the cloud.</p>
<h3 id="the-problem"><a href="#the-problem" aria-label="the problem permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>The problem</h3>
<p>Setting up a micro services architecture requires that there is a way services can find each other. Spring Cloud provides a services discovery service out of the box: Eureka. Services running in the micro services landscape are responsible to register themselves to the discovery service. Then, any service running in the micro services landscape can locate them based on their name. Deploying those services to a docker based cloud, such as AWS, does however create some difficulties.</p>
<p>A service running in a container does not know the external exposed port. The port map can be fixed, for example by mapping the external port on the same port as the internal one but this will eventually cause port conflicts. Besides that, you are not able to scale the container on the same host. Therefore, it make sense to use automatic port assignment. But in that case, services must be able to discover the port, assigned by docker, for registration.</p>
<p>Running micro services in docker containers on AWS ECS looks as follows.</p>
<a href="#">
    <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 441px;">
    <span class="gatsby-resp-image-background-image" style="padding-bottom: 64.17233560090703%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsSAAALEgHS3X78AAACY0lEQVQ4y4VT+0/TUBTuf+cf5g8mijFRJJFEf9HoIDpYBppAlDD3CgKhMPag6wZ7wrZuXZ/0dT9P7+0WNCY2/XpPz+Prd8+5lRBfjNFNiO37LqJZCZFWBjNOEOnHHKH+C9H8GDBP4YzLsG4LgH1JdaGoY/wJaUEoSMkOB3DqKUy/P0EwLeO6kkGvvoNuLQtVTsO5y6FT/wZF3qaPE2EUAP8iZIkjdAdw70idLoNZVTDzEr5+Dlc7RUR2DDg1rs7RLqg2+kvhUp1weJ4HbTp7+FH4fgBNmwqfcCGMGEajcZLHlpAWScvEMIRlWcvExfqnjyU++2HHEkLOHHEs5NuOkySSDxHvk2XOsbySGuGL60KxxltmFvXEqlBfqrw3RukN3KEs6twOn2wwo2nbFTiVFNzKpogFBo+FetxbGf7wEGZxjRQaRxhe7aJ59pmOQg7q/gqGjZxQ4rZg9vb5dO9aexidf8J1+X1COEcwyfFT0KlmMWt9RfNglQhjdcYZwrnMJ9dWDjEdNwWhNxDqadpw65jenuCmdSRiEfWPVMOu8t2FRgUtpQDJoa2b1DjXj+B4IfyA4Z5ge4zeKdenWCBWCoPSyM9g3kPAE7DjOMWkk4MfUDaeodT0ULxyUGjYKDYcbsfI103ka8YSxYaFfMOF0h2i21fR6bc51HYDsjqCtPf2FZTHj7BZ0pHKa9jITwga2RNsFmdY36njdVrG6pczrG2dU2yMDz91DLunmKlpDGppTFT6ky5SOL6sQXqZ7eHF1jVWMn083+79H5kenm718fGghWxRwXZeQaagYLfcxLu9G/wGweDC6OBd6mEAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;"></span>
    <picture>
        <source srcset="/static/110c23341dfbfef4c9a08632a2d31764/cc182/ecs1.webp 148w,
/static/110c23341dfbfef4c9a08632a2d31764/f7e40/ecs1.webp 295w,
/static/110c23341dfbfef4c9a08632a2d31764/efddf/ecs1.webp 441w" sizes="(max-width: 441px) 100vw, 441px" type="image/webp">
        <source srcset="/static/110c23341dfbfef4c9a08632a2d31764/cf440/ecs1.png 148w,
/static/110c23341dfbfef4c9a08632a2d31764/d2d38/ecs1.png 295w,
/static/110c23341dfbfef4c9a08632a2d31764/98017/ecs1.png 441w" sizes="(max-width: 441px) 100vw, 441px" type="image/png">
        <img class="gatsby-resp-image-image" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;" src="/static/110c23341dfbfef4c9a08632a2d31764/98017/ecs1.png" alt="ECS" title>
      </picture>
  </span>
</a>
<p>Each micro service is defined as task which will run as service (a docker container). The docker container runs on a Amazon EC2 instance that also runs docker agent to manage the cluster. Unfortunately, the agent has no API to lookup the exposed port.</p>
<h3 id="solution"><a href="#solution" aria-label="solution permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Solution</h3>
<p>To lookup the exposed port an extra agent is added to the EC2 instance. The <a href="https://github.com/npalm/docker-discovery-agent">discovery agent</a> uses an API to discover the port for a given container id, internal port and protocol. The only drawback is that the discovery agent needs access to the docker socket which is a potential security risk.</p>
<a href="#">
    <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;">
    <span class="gatsby-resp-image-background-image" style="padding-bottom: 47.324414715719065%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsSAAALEgHS3X78AAACKElEQVQoz61QS2sTURgdO/XZhRtFXViCLaKiUMGtoG7cuekPEFQo1E0WQkURWlTETaXS0qIVKlg3iovgi0TzaDJJJ4mZPJqYaGaSTFPyfreTTF7He4UUpFs/ONzvfvfcc+85DLOzdlEYPy7soRu15HqKmh3NtFmt5x1dJWPrKFmu2yry7VqaQ6fs8lKe9s44g6p7h1gfQT/F1P2xfXRQTtuftGI6qOuGfDFpKWei+lpG1FfqWa5YkM2qWlhdpbypx/cY8si20EGCYwSHqCgABoiz9MBjWDji9n49C1SOoxs8IXBvzwHBITQEDSBqPr2fOaV7N8OiI/RtfLjL9gSPEpwh0JwcHmSZ/1WXL16gdplWib/eLvHP2hX3IyXw5nlqZfY0Wj9HyGxZKThfNiXdsuKcv0Gc7G7k7HOtsmuRZPyiIbya/Udwfnri7+/IRZ7YAZoBoGaF/8v0NSA8CiTRqbiJTgCSbVFHmr1oeAHVBzQ8qIs69PKj2R0eGDhAVxabvtF2LTQJJTIhSfykIxgdaiobg1C8WnRCY9WcU+tLxa50AVathG52lV+3G9XweCSycqsnSPM7TwSH6UCIFh5KcuyHGJfMcjJhictR4fd6VjCtbVmN/rLNHNqy+k3fnJFwNBBLyhzhWaWE6FhLlD9v22XZfvbqpZH9tP/O+/XtzSAyCSvySQdSMTNEWcRrUw5LhgSWjCk45h4gxJtRynqQk22Ex8HiCXf+AFIpa2+58wjGAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;"></span>
    <picture>
        <source srcset="/static/79183530a7cd706df5ac94b8fa05bc07/cc182/ecs2.webp 148w,
/static/79183530a7cd706df5ac94b8fa05bc07/f7e40/ecs2.webp 295w,
/static/79183530a7cd706df5ac94b8fa05bc07/1a2f4/ecs2.webp 590w,
/static/79183530a7cd706df5ac94b8fa05bc07/5eb91/ecs2.webp 598w" sizes="(max-width: 590px) 100vw, 590px" type="image/webp">
        <source srcset="/static/79183530a7cd706df5ac94b8fa05bc07/cf440/ecs2.png 148w,
/static/79183530a7cd706df5ac94b8fa05bc07/d2d38/ecs2.png 295w,
/static/79183530a7cd706df5ac94b8fa05bc07/b9e4f/ecs2.png 590w,
/static/79183530a7cd706df5ac94b8fa05bc07/16bf3/ecs2.png 598w" sizes="(max-width: 590px) 100vw, 590px" type="image/png">
        <img class="gatsby-resp-image-image" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;" src="/static/79183530a7cd706df5ac94b8fa05bc07/b9e4f/ecs2.png" alt="ECS" title>
      </picture>
  </span>
</a>
<p>Let’s explain the working of the discovery agent by example: First we have to start the agent as a docker container.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">docker run -d -v /var/run/docker.sock:/var/run/docker.sock \
  --name docker-discovery-agent -p 5555:8080 npalm/docker-discovery-agent:1.0.0</code></pre></div>
<p>Now the agent is running, it can be tested. For testing we start another container, remember the problem is that we need to find the exposed port from <strong>within</strong> a container. The local ip address will be added as extra host to the container. The test container is just a linux (CentOS) container containing the tool <code class="language-text">curl</code> and for which port 80 is exposed to a random port.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">export DOCKERHOST=$(ifconfig | grep -E &quot;([0-9]{1,3}\.){3}[0-9]{1,3}&quot; | \
  grep -v 127.0.0.1 | awk &#39;{ print $2 }&#39; | cut -f2 -d: | head -n1)
docker run -it -p 80 --add-host=&quot;dockerhost:$(DOCKERHOST)&quot; --rm centos /bin/bash</code></pre></div>
<p>We are now in the shell of the CentOS container, the host file contains a DNS entry that points to the host. First, we have to search for the id of the current container.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">CONTAINER_ID=$(cat /proc/self/cgroup | grep &quot;cpu:/&quot; | sed &#39;s/\([0-9]\):cpu:\/docker\///g&#39;)</code></pre></div>
<p>Then, we ask the discovery agent for our external mapped port by sending the container id and the internal port.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">curl &quot;http://dockerhost:5555/container/${CONTAINER_ID}/portbinding?port=80&amp;protocol=tcp&quot;</code></pre></div>
<p>The result is a JSON string container with the hostIp and hostPort, for example:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">{
	&quot;HostIp&quot;: &quot;0.0.0.0&quot;,
	&quot;HostPort&quot;: &quot;32779&quot;
}</code></pre></div>
<p>Alternative to passing the host ip address, it is possible to register a static ip address and use this to find the dicovery agent.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">sudo ifconfig lo0 alias 172.16.123.1</code></pre></div>
<p>Now we can discover the exposed port, let’s give some direction on how this can be combined with Spring Cloud on ECS. First deploy Eureka (service discover) as container. Register an ALB (internal) to the service. Now we have an endpoint that we can use to inject the service that needs to register itself. Next create a spring service that is aware of discovery. Before the services can be started, the exposed port needs to be found. Add the snippet below to the start script to start the services in the container.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">#!/bin/bash
export DOCKER_HOST=$(curl -s 169.254.169.254/latest/meta-data/local-ipv4)
export CONTAINER_ID=$(cat /proc/self/cgroup | grep &quot;cpu:/&quot; | \
  sed &#39;s/\([0-9]\):cpu:\/docker\///g&#39;)
export NETWORK_BINDING=\
  $(curl &quot;http://${DOCKER_HOST}:5555/container/${CONTAINER_ID}/portbinding?port=8080&amp;protocol=tcp&quot;)
export EXPOSED_PORT=$(echo ${NETWORK_BINDING} | jq -c &#39;.[0].HostPort&#39; | \
  sed -e &#39;s/^&quot;//&#39;  -e &#39;s/&quot;$//&#39;)

exec java -jar /service.jar</code></pre></div>
<p>The last step is to update the <code class="language-text">application.yml</code> and add a few lines to force the ip address and port during service registration.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">eureka:
  client:
    serviceUrl:
      defaultZone: ${EUREKA_URL} // Needs to be injected as environment variable
  instance:
    preferIpAddress: true
    ip-address: ${DOCKER_HOST}
    non-secure-port: ${EXPOSED_PORT}</code></pre></div>
<h3 id="alternatives"><a href="#alternatives" aria-label="alternatives permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Alternatives</h3>
<p>Discovery of the unknown exposed port is a highly discussed topic and there are many alternative solutions, Please see <a href="https://github.com/docker/docker/issues/3778">docker issue</a>, which is a good starting point for alternatives. The following alternatives came to my mind:</p>
<ul>
<li>Same approach, but run the discovery service directly on the host.</li>
<li>Implement the discovery capability in each servie as a library, but the drawback is that all the services need the docker socket.</li>
<li>Choose another discovery mechanism for example based on ALB.</li>
<li>Switch to <a href="https://github.com/hashicorp/consul">Consul</a> in combination with a <a href="https://github.com/gliderlabs/registrator">registrator</a></li>
</ul></div></section></article></main></div><footer class="Footer__FooterWrapper-sc-1oxe0wr-0 hFicPH"><nav><div class="footer-col"><h5 class="footer-title">040 code © 2019</h5><span class="footer-item">Build with <i></i><a class="footer-link" href="https://www.gatsbyjs.org/">Gatsby</a></span></div><div class="footer-col"><h5 class="footer-title">Blog</h5><span class="footer-item"><a class="footer-link" href="/">home</a></span><span class="footer-item"><a class="footer-link" href="/about">about</a></span></div><div class="footer-col"><h5 class="footer-title">Source</h5><span class="footer-item"><i></i><a class="footer-link" href="https://github.com/040code/">Github</a></span></div></nav></footer></div></div><script>
  
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-97020149-1', 'auto', {});
      
      
      
      }
      </script><script id="gatsby-script-loader">/*<![CDATA[*/window.page={"componentChunkName":"component---src-templates-blog-post-js","jsonName":"2019-04-20-discovery-agent-aba","path":"/2019/04/20/discovery-agent"};window.dataPath="409/path---2019-04-20-discovery-agent-aba-f6c-L7HF4RhKEgydBGBWvG5a9I6WMc";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-84bfed4ad145c677057d.js"],"component---node-modules-gatsby-plugin-offline-app-shell-js":["/component---node-modules-gatsby-plugin-offline-app-shell-js-2ab26a3ad4829aea965a.js"],"component---src-templates-blog-list-template-js":["/component---src-templates-blog-list-template-js-34e97edbb9f6316389aa.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-196251b58308a4713b67.js"],"component---src-templates-page-js":["/component---src-templates-page-js-d20dd4b47e1673e18d3b.js"],"component---src-templates-tags-js":["/component---src-templates-tags-js-c3171c7e450b158590c3.js"],"component---src-templates-authors-js":["/component---src-templates-authors-js-6897a14a7619c34af567.js"],"component---src-pages-404-js":["/component---src-pages-404-js-56f2800232dec8ad47ad.js"],"pages-manifest":["/pages-manifest-1c805638f81a770b426a.js"]};/*]]>*/</script><script src="/webpack-runtime-a0839e02624f9be751ba.js" async=""></script><script src="/styles-347315f8df6c6f773751.js" async=""></script><script src="/1-a64b98d1bd63886934eb.js" async=""></script><script src="/3-07d97d9f6ddaf6089fbb.js" async=""></script><script src="/app-84bfed4ad145c677057d.js" async=""></script><script src="/component---src-templates-blog-post-js-196251b58308a4713b67.js" async=""></script></body></html>