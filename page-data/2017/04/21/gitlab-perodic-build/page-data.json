{"componentChunkName":"component---src-templates-blog-post-js","path":"/2017/04/21/gitlab-perodic-build","webpackCompilationHash":"5922713c92655645bc49","result":{"data":{"markdownRemark":{"id":"4ce4f810-d663-5ba3-b090-a39c88a1a22f","excerpt":"I am using GitLab CI now for more than a year and I really love the features in GitLab. GitLab provides a complete and powerful tool for day…","html":"<p>I am using GitLab CI now for more than a year and I really love the features in GitLab. GitLab provides a complete and powerful tool for day to day development. And of course, there are always feature that you miss. Until now there is no support for periodic builds, in the coming release the <a href=\"https://gitlab.com/gitlab-org/gitlab-ce/issues/2989\">feature</a> will be shipped as experimental feature and in the next one is should be general available. But in case you must deal for some reason with an older version, a work around is described below as I used last year.</p>\n<p>You could argue why you should need a feature as a periodic build. Ideally a build should be immutable and only trigger by a change in GIT, a commit. But the world is not always perfect, project build are sometime not of the quality that you are expect or tools are not that reliable as you hope. For example, dependencies resolving could break over the time, to avoid you find the problem once your boss is watching you when fixing a critical bug, a periodic build can alert you earlier. Another and much better reason to argue for the feature is that the GitLab build are so powerful that is handy to use them for a scenario based health check.</p>\n<h2 id=\"the-build-trigger\"><a href=\"#the-build-trigger\" aria-label=\"the build trigger permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>The build trigger</h2>\n<p>To setup a periodic build you first need to be able to trigger a build in some way. GitLab provides an <a href=\"https://docs.gitlab.com/ce/ci/triggers/\">API</a> to trigger a build. Setting up the trigger is simple and complete guided in GitLab, just execute the steps below:</p>\n<ul>\n<li>Go to your GitLab projects</li>\n<li>Navigate to Settings -> CI/CD Pipelines</li>\n<li>Scroll down to the trigger section and create a trigger</li>\n<li>Make a note of the TOKEN and trigger URL. An curl example for trigger is shown as well.</li>\n</ul>\n<a href=\"#\">\n    <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 33.3889816360601%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAAA8klEQVQoz51Ry2oDMQz0j/af+k+9lOZe6CEll/U+ym725cfasqeSmkDprREMI4uZQcjGthZd16Fn2KZBjBE5J6SUkP8B1bPPjMMVx0GIuaAAOJgfQWI4zjGnywc+2xbXxSGk8jAkdHIZ5untGS9f75DKhVBqRb3hXvUPa19/91V9qAUmxPAzKIW5KAuIMrz32LaNT3JoL+yc0zvLzfZ9RwhBtcR5xOFmGAZ4FolRICIxExH6voe1Vmdt16tZ3uM4anDDn7izR8LidEFuTzDrumKeZ8aivCyLiqW8DxpMVOBDvM28BsuGsrGUfGaazqjdK74BXekgB/Lm0qIAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;\"></span>\n  <picture>\n        <source srcset=\"/static/b3a83e80a7d7dd93b35da7f9921e9cb1/cc182/gitlabtrigger.webp 148w,\n/static/b3a83e80a7d7dd93b35da7f9921e9cb1/f7e40/gitlabtrigger.webp 295w,\n/static/b3a83e80a7d7dd93b35da7f9921e9cb1/1a2f4/gitlabtrigger.webp 590w,\n/static/b3a83e80a7d7dd93b35da7f9921e9cb1/4837b/gitlabtrigger.webp 885w,\n/static/b3a83e80a7d7dd93b35da7f9921e9cb1/2f819/gitlabtrigger.webp 1180w,\n/static/b3a83e80a7d7dd93b35da7f9921e9cb1/75e7c/gitlabtrigger.webp 1797w\" sizes=\"(max-width: 590px) 100vw, 590px\" type=\"image/webp\">\n        <source srcset=\"/static/b3a83e80a7d7dd93b35da7f9921e9cb1/cf440/gitlabtrigger.png 148w,\n/static/b3a83e80a7d7dd93b35da7f9921e9cb1/d2d38/gitlabtrigger.png 295w,\n/static/b3a83e80a7d7dd93b35da7f9921e9cb1/b9e4f/gitlabtrigger.png 590w,\n/static/b3a83e80a7d7dd93b35da7f9921e9cb1/f9b6a/gitlabtrigger.png 885w,\n/static/b3a83e80a7d7dd93b35da7f9921e9cb1/2d849/gitlabtrigger.png 1180w,\n/static/b3a83e80a7d7dd93b35da7f9921e9cb1/85af7/gitlabtrigger.png 1797w\" sizes=\"(max-width: 590px) 100vw, 590px\" type=\"image/png\">\n        <img class=\"gatsby-resp-image-image\" src=\"/static/b3a83e80a7d7dd93b35da7f9921e9cb1/b9e4f/gitlabtrigger.png\" alt=\"GitLab trigger\" title=\"GitLab trigger\" loading=\"lazy\">\n      </picture>\n    </span>\n</a>\n<p>Next we test that we are able to trigger the build remotely be executing the <code class=\"language-text\">curl</code> command below.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">curl -X POST \\\n     -F token=&lt;TOKEN&gt; \\\n     -F ref=&lt;REF_NAME&gt; \\\n     &lt;URL&gt;</code></pre></div>\n<p>Verify in GitLab the build is triggered</p>\n<h2 id=\"periodic-trigger-the-build-in-a-docker-container\"><a href=\"#periodic-trigger-the-build-in-a-docker-container\" aria-label=\"periodic trigger the build in a docker container permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Periodic trigger the build in a Docker container</h2>\n<p>The next step is to execute the trigger periodic. A standard way of running a job periodic is by defining crontab. We will use a docker container to execute the crontab so we can deploy it anywhere.</p>\n<p>I have createe a base docker image containing a script to trigger GitLab by executing a curl command as shown above. The crontab will be copied to the image <code class=\"language-text\">ONBUILD</code>. In the crontab we point to the script that can be executed as follow:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">trigger-gitlab.sh -t &lt;token&gt; -r &lt;ref&gt; -u &lt;gitlab_trigger_url&gt;</code></pre></div>\n<p>For the sources see <a href=\"https://github.com/npalm/gitlab-periodic-trigger\">npalm/gitlab-periodic-trigger</a> on GitHub.</p>\n<p>Now all peace’s are ready we only have to build our docker image and run it to trigger the build. First, we create a Dockerfile and only extend the base image <code class=\"language-text\">npalm/gitlab-periodic-trigger</code>. Create a new directory, and add a Dockerfile with only the line:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">FROM npalm/gitlab-periodic-trigger:1.0.0</code></pre></div>\n<p>This image expects a file <code class=\"language-text\">gitlabcrontab</code> containing the <a href=\"https://en.wikipedia.org/wiki/Cron\">crontab</a> and will copy it to the image once build. Create a file named <code class=\"language-text\">gitlabcrontab</code>, and add one ore more triggers, an example is below.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># Example of job definition:\n# .---------------- minute (0 - 59)\n# |  .------------- hour (0 - 23)\n# |  |  .---------- day of month (1 - 31)\n# |  |  |  .------- month (1 - 12) OR jan,feb,mar,apr ...\n# |  |  |  |  .---- day of week (0 - 6) (Sunday=0 or 7)\n# |  |  |  |  |\n22 11 * * * trigger-gitlab.sh -t &lt;token&gt; -r &lt;ref&gt; -u &lt;gitlab_trigger_url&gt;</code></pre></div>\n<p>Now we build the container <code class=\"language-text\">docker build -t periodic-trigger .</code> and finally start the container <code class=\"language-text\">docker run -d periodic-trigger</code></p>\n<p>To enable the feature for your teams you could set up a build to build the docker image as described below and push it automated to an environment.</p>","frontmatter":{"title":"Periodic builds in GitLab","subtitle":"Trigger builds based on a crontab","date":"2017-04-21","slug":"2017/04/21/gitlab-perodic-build","language":null,"tags":["gitlab","docker"],"authors":["niek"],"comments":null,"cover":{"publicURL":"/static/lichtjesroute-b9f97017c35783cec4ac4584f1f70e7b.jpg"},"coverLink":null,"coverDescription":null,"imageTw":{"publicURL":"/static/2017-04-21-gitlab-perodic-build-tw-6e4896750472192647d1727368587e9e.png"},"imageFb":{"publicURL":"/static/2017-04-21-gitlab-perodic-build-fb-369bcaec54d95129cc31681c66a464b1.png"},"asciinema":null}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"2017/04/21/gitlab-perodic-build","previous":{"frontmatter":{"title":"Discover the exposed port","slug":"2019/04/20/discovery-agent","type":"post","tags":["docker","aws","spring"],"authors":["niek"]}},"next":{"frontmatter":{"title":"Docker Multi Stage Builds","slug":"2017/05/07/docker-multi-stage-builds","type":"post","tags":["docker"],"authors":["niek"]}}}}}