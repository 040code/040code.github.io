{"componentChunkName":"component---src-templates-blog-post-js","path":"/2017/12/09/runners-on-the-spot","webpackCompilationHash":"e438c96074ba29909476","result":{"data":{"markdownRemark":{"id":"22a0420c-16c4-5e31-943e-905f861b1560","excerpt":"Introduction GitLab CI is a first class citizen in GitLab to enable continuous integration and delivery to your project. Builds areâ€¦","html":"<h2 id=\"introduction\"><a href=\"#introduction\" aria-label=\"introduction permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Introduction</h2>\n<p><a href=\"https://about.gitlab.com/features/gitlab-ci-cd/\">GitLab CI</a> is a first class citizen in GitLab to enable continuous integration and delivery to your project. Builds are orchestrated via <a href=\"https://docs.gitlab.com/runner/\">GitLab Runners</a>, which are agents registered to your GitLab account. An agent runs builds using a local shell or a container. Runnings these builds requires a well-defined infrastructure, both with respect to the type of server and the server capacity. Would it not be great if you can scale the infrastructure based on your needs? Indeed, GitLabs runner supports out of the box auto scaling using docker machine, which is discussed in the GitLab blog article: <a href=\"https://about.gitlab.com/2017/11/23/autoscale-ci-runners/\">Autoscale GitLab CI runners and save 90% on EC2 costs</a>.</p>\n<p>The GitLab blog article nicely explains how to create your infrastructure in a manual way. However, we rather automate all things. Thus, we will automate the set up described in the blog article. In this post I will discuss how to create the infrastructure needed to run the build on AWS spot instances with <a href=\"https://www.terraform.io/\">Hashicorp Terraform</a>. The GitLab Runner module discussed in the post is available in the <a href=\"https://registry.terraform.io/modules/npalm/gitlab-runner/aws/0.1.0\">Terraform Registery</a>.</p>\n<a href=\"#\">\n    <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 42.07650273224044%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAAsSAAALEgHS3X78AAABVElEQVQY001RS1KDQBTkGt7HhVfyHF7BhTtX2ZmyKvuoVYGEgDPABDAQ5RMKGIb52GAlZS+GrvfmTXc/rL7vOe/tzWa9Xn+lqRgnKKW6rhuGgXMuhDifz7ZtM3YAR4UPUwfcwrAxxnGc1WqVZRk4uhhGXWsNgrNpmuXyxfN9dJWSZipPFyxcNf8gpcSTOKGcZxkhBDxJYkpoxFgUUP+Q75PaaAkDFh9H09bd8yN/++gXT8qYYfbVtq2aAeUgoO5uRym+xKUJTQqIQxXKozHN+HBX3d6Y13sMV2VZFD/A6fRd1xU8B0GwdZxPQrz9zvYTklSX4TmzblK1WRgzKqlhGI2iKLbOlkXR8XiM45jMoJSEYeSF6TDjklnra2ZUsfA8zyFeliW2yBhzXRexw4B6lL2TEj/ozzaftiqlGgUSCjFiYRhGvYbpqrqGn7tCDIPWEhwXfgFUEL7p2geODAAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;\"></span>\n  <picture>\n        <source srcset=\"/static/fd91ecffb8159f85b66f5b526bb498f5/cc182/gitlab-runner.webp 148w,\n/static/fd91ecffb8159f85b66f5b526bb498f5/f7e40/gitlab-runner.webp 295w,\n/static/fd91ecffb8159f85b66f5b526bb498f5/1a2f4/gitlab-runner.webp 590w,\n/static/fd91ecffb8159f85b66f5b526bb498f5/7dd13/gitlab-runner.webp 732w\" sizes=\"(max-width: 590px) 100vw, 590px\" type=\"image/webp\">\n        <source srcset=\"/static/fd91ecffb8159f85b66f5b526bb498f5/cf440/gitlab-runner.png 148w,\n/static/fd91ecffb8159f85b66f5b526bb498f5/d2d38/gitlab-runner.png 295w,\n/static/fd91ecffb8159f85b66f5b526bb498f5/b9e4f/gitlab-runner.png 590w,\n/static/fd91ecffb8159f85b66f5b526bb498f5/7ec06/gitlab-runner.png 732w\" sizes=\"(max-width: 590px) 100vw, 590px\" type=\"image/png\">\n        <img class=\"gatsby-resp-image-image\" src=\"/static/fd91ecffb8159f85b66f5b526bb498f5/b9e4f/gitlab-runner.png\" alt=\"GitLab Runner\" title=\"GitLab Runner\" loading=\"lazy\">\n      </picture>\n    </span>\n</a>\n<h2 id=\"prerequisites\"><a href=\"#prerequisites\" aria-label=\"prerequisites permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Prerequisites</h2>\n<p>Before we start, we need to briefly discuss the GitLab runners. To execute the builds, GitLab uses an agent to orchestrate the build with a docker machine. A docker machine creates instances with docker engine to run docker containers. The first step for setting up a runner is to register a new runner. Because GitLab currently does not provide a fully automated way for this, we will do this manually.</p>\n<p>Open you GitLab project and lookup the token to register a runner. Be aware that there are project tokens and a GitLab global token. Next, we use a docker container to register a runner. The command will ask a few details.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">docker run -it --rm gitlab/gitlab-runner register</code></pre></div>\n<p><asciinema-player src=\"/2017/12/09/runners-on-the-spot/register.json\"\n  cols=\"166\" rows=\"15\" autoplay=\"true\" loop=\"true\" speed=\"1.5\">\n</asciinema-player></p>\n<p>Provide the requested details and consult the GitLab manual for more details. Once done, you should see a new runner registered at your project or globally. Open the runner settings in edit mode and record the token. This token is needed later for connecting the agent.</p>\n<h2 id=\"creating-infrastructure-for-the-runners\"><a href=\"#creating-infrastructure-for-the-runners\" aria-label=\"creating infrastructure for the runners permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Creating infrastructure for the runners</h2>\n<p>Now the runner is configured in GitLab, we can start creating the infrastructure on AWS. For setting up the network layers, we use <a href=\"http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/VPC_Scenario2.html\">Amazon networking scenario 2</a> to build a VPC with a public and private subnets. For more details see this <a href=\"2017/06/18/terraform-aws-vpc/\">post</a> about creating a VPC in terraform. You can also simply use the <a href=\"https://registry.terraform.io/modules/terraform-aws-modules/vpc/aws/1.7.0\">official terraform module</a>.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">module &quot;vpc&quot; {\n  source  = &quot;terraform-aws-modules/vpc/aws&quot;\n  version = &quot;1.5.1&quot;\n\n  name = &quot;vpc-${var.environment}&quot;\n  cidr = &quot;10.0.0.0/16&quot;\n\n  azs             = [&quot;eu-west-1a&quot;, &quot;eu-west-1b&quot;, &quot;eu-west-1c&quot;]\n  private_subnets = [&quot;10.0.1.0/24&quot;, &quot;10.0.2.0/24&quot;, &quot;10.0.3.0/24&quot;]\n  public_subnets  = [&quot;10.0.101.0/24&quot;, &quot;10.0.102.0/24&quot;, &quot;10.0.103.0/24&quot;]\n\n  enable_nat_gateway = true\n\n  tags = {\n    Environment = &quot;${var.environment}&quot;\n  }\n}</code></pre></div>\n<p>Next, we create a <code class=\"language-text\">t2.micro</code> instance using an autoscaling group in the private network. On this instance we install and configure the GitLab runner. Configuration of GitLab runners is done via the <code class=\"language-text\">config.toml</code> file. Below the parameterized version of this configuration file. In the Terraform module you will find that the configuration file is loaded via a data template.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">concurrent = ${runner_concurrent}\ncheck_interval = 0\n\n[[runners]]\n  name = &quot;${runners_name}&quot;\n  url = &quot;${gitlab_url}&quot;\n  token = &quot;${runners_token}&quot;\n  executor = &quot;docker+machine&quot;\n  limit = ${runners_limit}\n  [runners.docker]\n    tls_verify = false\n    image = &quot;docker:17.11.0-ce&quot;\n    privileged = ${runners_privilled}\n    disable_cache = false\n    volumes = [&quot;/cache&quot;]\n    shm_size = 0\n  [runners.cache]\n    Type = &quot;s3&quot;\n    ServerAddress = &quot;s3-${aws_region}.amazonaws.com&quot;\n    AccessKey = &quot;${bucket_user_access_key}&quot;\n    SecretKey = &quot;${bucket_user_secret_key}&quot;\n    BucketName = &quot;${bucket_name}&quot;\n    Insecure = false\n  [runners.machine]\n    IdleCount = ${runners_idle_count}\n    IdleTime = ${runners_idle_time}\n    MachineDriver = &quot;amazonec2&quot;\n    MachineName = &quot;runner-%s&quot;\n    MachineOptions = [\n      &quot;amazonec2-access-key=${access_key}&quot;,\n      &quot;amazonec2-secret-key=${secret_key}&quot;,\n      &quot;amazonec2-instance-type=${instance_type}&quot;,\n      &quot;amazonec2-region=${aws_region}&quot;,\n      &quot;amazonec2-vpc-id=${vpc_id}&quot;,\n      &quot;amazonec2-subnet-id=${subnet_id}&quot;,\n      &quot;amazonec2-private-address-only=true&quot;,\n      &quot;amazonec2-request-spot-instance=true&quot;,\n      &quot;amazonec2-spot-price=${spot_price_bid}&quot;,\n      &quot;amazonec2-security-group=${security_group_name}&quot;\n    ]</code></pre></div>\n<p>All variables can be configured and most of them have default values. Only the name of the runner, the token and the GitLab URL need to be configured. The configuration contains a shared cache in S3 which will expire at the end of the next day (after creation) by default. Files will be deleted via S3 lifecycle management once expired, but the number of expiration days can be changed to your needs. You can find all the available variables in the <code class=\"language-text\">variables.tf</code> file of the module. Next we add the module to our Terraform file and define a minimal set of variables.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">module &quot;gitlab-runner&quot; {\n  source = &quot;npalm/gitlab-runner/aws&quot;\n\n  aws_region     = &quot;&lt;region-to-use&gt;&quot;\n  environment    = &quot;ci-runners&quot;\n  ssh_public_key = &quot;&lt;contains-public-key&quot;\n\n  vpc_id                  = &quot;${module.vpc.vpc_id}&quot;\n  subnet_id_gitlab_runner = &quot;${element(module.vpc.private_subnets, 0)}&quot;\n  subnet_id_runners       = &quot;${element(module.vpc.private_subnets, 0)}&quot;\n\n  # Values below are created during the registration process of the runner.\n  runner_name       = &quot;&lt;name-of-the-runner&quot;\n  runner_gitlab_url = &quot;&lt;gitlab-url&gt;&quot;\n  runner_token      = &quot;&lt;token-of-the-runner&quot;\n}</code></pre></div>\n<p>The complete example is in <a href=\"https://github.com/npalm/terraform-aws-gitlab-runner/tree/master/example\">GitHub</a>. Now it is time to execute the scripts to create the actual infrastructure. Be aware that you need to configure AWS keys and have Terraform installed. The steps below should guide you through the setup.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">git clone https://github.com/npalm/terraform-aws-gitlab-runner.git\ncd tf-aws-gitlab-runner/example</code></pre></div>\n<p>The example directory contains the example as described above, so the properties for your newly registered runner in GitLab need to be configured. Please register a runner in GitLab (see docker command above) and update the <code class=\"language-text\">terraform.tfvars</code> file. That is all, now execute the Terraform code.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># genere SSH key pair\n./init.sh\n\n# initialize terraform\nterraform init\n\n# apply, or plan first\nterraform apply</code></pre></div>\n<p><asciinema-player src=\"/2017/12/09/runners-on-the-spot/terraform.json\"\n  cols=\"166\" rows=\"15\" autoplay=\"true\" loop=\"true\" speed=\"1.5\">\n</asciinema-player></p>\n<p>After a few minutes the runner should be running and you should see it in your AWS console.\n<a href=\"#\">\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 15.377358490566037%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAIAAAAcOLh5AAAACXBIWXMAAAsSAAALEgHS3X78AAAAlUlEQVQI1zWNOw7CMBBEc3lqLsApqCg5AS3ExrGytuMP/sWiSJHYbJDyqnm7Gk13uavzbTxd+ePtviUBiFJKa63W2g4qWtt1Xddt25Zlmec5hNBZ56RU2lhzgFfsxxgxpJS893EHYzTaAABjrO97Kacu58z5YK0tf/BHCEHlnGutlVKUUvexr+EphQQ1UkpwQAjwfvoB56ij6wuRaagAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;\"></span>\n  <picture>\n        <source srcset=\"/static/da22dc7ce8a7f28e3d3a087312726989/cc182/ec2.webp 148w,\n/static/da22dc7ce8a7f28e3d3a087312726989/f7e40/ec2.webp 295w,\n/static/da22dc7ce8a7f28e3d3a087312726989/1a2f4/ec2.webp 590w,\n/static/da22dc7ce8a7f28e3d3a087312726989/4837b/ec2.webp 885w,\n/static/da22dc7ce8a7f28e3d3a087312726989/2f819/ec2.webp 1180w,\n/static/da22dc7ce8a7f28e3d3a087312726989/2c53d/ec2.webp 2120w\" sizes=\"(max-width: 590px) 100vw, 590px\" type=\"image/webp\">\n        <source srcset=\"/static/da22dc7ce8a7f28e3d3a087312726989/cf440/ec2.png 148w,\n/static/da22dc7ce8a7f28e3d3a087312726989/d2d38/ec2.png 295w,\n/static/da22dc7ce8a7f28e3d3a087312726989/b9e4f/ec2.png 590w,\n/static/da22dc7ce8a7f28e3d3a087312726989/f9b6a/ec2.png 885w,\n/static/da22dc7ce8a7f28e3d3a087312726989/2d849/ec2.png 1180w,\n/static/da22dc7ce8a7f28e3d3a087312726989/6ecdf/ec2.png 2120w\" sizes=\"(max-width: 590px) 100vw, 590px\" type=\"image/png\">\n        <img class=\"gatsby-resp-image-image\" src=\"/static/da22dc7ce8a7f28e3d3a087312726989/b9e4f/ec2.png\" alt=\"Running EC2 instances\" title=\"Running EC2 instances\" loading=\"lazy\">\n      </picture>\n    </span>\n</a>\n<br>\nThe runner should be active as well in GitLab. Check the runner pages which should now indicate the latest moment of contact.\n<a href=\"#\">\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 76.30573248407643%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAIAAABr+ngCAAAACXBIWXMAAAsSAAALEgHS3X78AAABDklEQVQoz5WT3XKDIBCFef9H6kxfoulML3OXQFFAEZBfc1DHTC9M6F4o6h7Px+5CKGOc89vtTild/hlETxoy6K118V2EEJSU3vvtkVhrh2HAKqWUcy4vAzla6yONOOe6rksptnBCDLMnNsRSKSFE3/fzPOPVufECQGNdLnsOmZ2DDOaM0k38IgqIfXUuh/M0TbnuJ9afn8nWa0jl43v4/Bl3bGusMaaxNymXr2t3uXLw78561KUtUDBvdclhK3gVK6WWc+A/8KWgugdp7TNK3YgNw3HUR10JVqIXMcQW7CoexueQQMx/OeamERt9PeakYjPGjJnWb/mts5ASQ4FqV2fcYGuda9w2WouzMK/5D52sc2TxHp2fAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;\"></span>\n  <picture>\n        <source srcset=\"/static/d9ff5713181f96b5c776524cd5081007/cc182/runner.webp 148w,\n/static/d9ff5713181f96b5c776524cd5081007/f7e40/runner.webp 295w,\n/static/d9ff5713181f96b5c776524cd5081007/1a2f4/runner.webp 590w,\n/static/d9ff5713181f96b5c776524cd5081007/4837b/runner.webp 885w,\n/static/d9ff5713181f96b5c776524cd5081007/2f819/runner.webp 1180w,\n/static/d9ff5713181f96b5c776524cd5081007/1752f/runner.webp 1570w\" sizes=\"(max-width: 590px) 100vw, 590px\" type=\"image/webp\">\n        <source srcset=\"/static/d9ff5713181f96b5c776524cd5081007/cf440/runner.png 148w,\n/static/d9ff5713181f96b5c776524cd5081007/d2d38/runner.png 295w,\n/static/d9ff5713181f96b5c776524cd5081007/b9e4f/runner.png 590w,\n/static/d9ff5713181f96b5c776524cd5081007/f9b6a/runner.png 885w,\n/static/d9ff5713181f96b5c776524cd5081007/2d849/runner.png 1180w,\n/static/d9ff5713181f96b5c776524cd5081007/a0d55/runner.png 1570w\" sizes=\"(max-width: 590px) 100vw, 590px\" type=\"image/png\">\n        <img class=\"gatsby-resp-image-image\" src=\"/static/d9ff5713181f96b5c776524cd5081007/b9e4f/runner.png\" alt=\"GitLab Runner details\" title=\"GitLab Runner details\" loading=\"lazy\">\n      </picture>\n    </span>\n</a>\n<br></p>\n<p>The modules also enable CloudWatch logging, all <code class=\"language-text\">systemd</code> logging is streamed. Go to CloudWatch to inspect the logging and you will see that the installation process was logged as well.</p>\n<a href=\"#\">\n    <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 16.97401508801341%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAIAAAAcOLh5AAAACXBIWXMAAAsSAAALEgHS3X78AAAAjUlEQVQI1zWMXQ+CMAxF+f9/z0jXjn24BxPcFDVsHbCIjcSTm5M+9N4uxsTM+76LrbWllFqr956IQgjGGDnEzjn7I+e8/Olu49haO8rGDDnPzEWeFIBMaK0BABFlAlGlFFvb1mU96K7pFZ+8bJ/CTHp4z3kudbCuB2WcV6hP514hIWlAcpdwn57pMYklX9i7o8CqzzMNAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;\"></span>\n  <picture>\n        <source srcset=\"/static/1111ac4745032de3c599fdfa409cd4b1/cc182/cloudwatch.webp 148w,\n/static/1111ac4745032de3c599fdfa409cd4b1/f7e40/cloudwatch.webp 295w,\n/static/1111ac4745032de3c599fdfa409cd4b1/1a2f4/cloudwatch.webp 590w,\n/static/1111ac4745032de3c599fdfa409cd4b1/4837b/cloudwatch.webp 885w,\n/static/1111ac4745032de3c599fdfa409cd4b1/2f819/cloudwatch.webp 1180w,\n/static/1111ac4745032de3c599fdfa409cd4b1/7c78f/cloudwatch.webp 2386w\" sizes=\"(max-width: 590px) 100vw, 590px\" type=\"image/webp\">\n        <source srcset=\"/static/1111ac4745032de3c599fdfa409cd4b1/cf440/cloudwatch.png 148w,\n/static/1111ac4745032de3c599fdfa409cd4b1/d2d38/cloudwatch.png 295w,\n/static/1111ac4745032de3c599fdfa409cd4b1/b9e4f/cloudwatch.png 590w,\n/static/1111ac4745032de3c599fdfa409cd4b1/f9b6a/cloudwatch.png 885w,\n/static/1111ac4745032de3c599fdfa409cd4b1/2d849/cloudwatch.png 1180w,\n/static/1111ac4745032de3c599fdfa409cd4b1/26fc7/cloudwatch.png 2386w\" sizes=\"(max-width: 590px) 100vw, 590px\" type=\"image/png\">\n        <img class=\"gatsby-resp-image-image\" src=\"/static/1111ac4745032de3c599fdfa409cd4b1/b9e4f/cloudwatch.png\" alt=\"CloudWatch logging\" title=\"CloudWatch logging\" loading=\"lazy\">\n      </picture>\n    </span>\n</a>\n<h2 id=\"verify\"><a href=\"#verify\" aria-label=\"verify permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Verify</h2>\n<p>Finally we can verify that the runner is working properly by executing a build. The <code class=\"language-text\">.gitlab-ci.yml</code> below is an example to verify the runner is working properly. The build contains two stages. In the first stage an ascii art image is generated, stored in a file which is cached in S3. In the second stage the file is retrieved from the build cache.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">stages:\n  - build\n  - verify\n\ncache:\n  key: &quot;$CI_BUILD_REF&quot;\n  untracked: true\n\nimage: npalm/cowsay\n\nbuild:\n  stage: build\n\n  script:\n    - cowsay -f ghostbusters building &quot;$CI_BUILD_NAME&quot; @ stage &quot;$CI_BUILD_STAGE&quot; &gt; ghosts.txt\n\n  tags:\n     - docker.m3\n\nverify:\n  stage: verify\n\n  script:\n    - cat ghosts.txt\n\n  tags:\n    - docker.m3</code></pre></div>\n<p>Add the file above to the GitLab repository that has the created runner attached. Once you commit the file a build should triggered. The logging of the verification step should contain the ascii art image.</p>\n<a href=\"#\">\n    <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 47.993705743509054%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsSAAALEgHS3X78AAABv0lEQVQoz12R3WriQBTHk0mIHzVFE7u4sKltDb0UIdFFKFu6L+KVDyB4KZtSWiz4KIJWfQWhj9DC7o0IlSKbSaL5mDjqHrVlW/+ESeDMb35nTpjpdEopfX5+ajavm/c3t3fXhvFrF8MwGo1GvV6v1WrVarXValmWFQZ+SMjMI5ZLGMdx1ut1r/8Qi3GiGOV5xLIs8zkIIVjz+bxp4j+jyfQvpnQRhuEbPBgMEOIEIRKDxOMcx8ER3DY8zwuCAHCpVLJs5/E3fsXekoYE4Pl8vjH3elAWRRFQSZJzuVwikdgz67qOsQnB2CaEbMyTySvAnU4Hdhxns7Amk0lFUTKZzB6s6brt2KZlm7ZrO64fEOblZQLHtNvtSCT65egonU6nJAl6lWV5x3w0z9xZEJDlcknhoZQZjUZBEAAMZVVVoWf4gOYV5XjfrGlzz/V8b7FY0G2Y8XgMr263C2VJls7P1ZPTrKqeHR4eIMSibWBmOzNoYPPuwps7wwBWq1V/0PumpDJfk6nUQTzOR6MAMCz6ZC4UCr7vg/Y/jDGGgQ2Hw6ufFz8uL3StqMFk9GKxCL+m9H2bcrkMZKVSATPA4Xv+AdGoBSyConzvAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;\"></span>\n  <picture>\n        <source srcset=\"/static/d4b535fa8f201439b10aa5e2ce199557/cc182/ghost.webp 148w,\n/static/d4b535fa8f201439b10aa5e2ce199557/f7e40/ghost.webp 295w,\n/static/d4b535fa8f201439b10aa5e2ce199557/1a2f4/ghost.webp 590w,\n/static/d4b535fa8f201439b10aa5e2ce199557/4837b/ghost.webp 885w,\n/static/d4b535fa8f201439b10aa5e2ce199557/2f819/ghost.webp 1180w,\n/static/d4b535fa8f201439b10aa5e2ce199557/87621/ghost.webp 2542w\" sizes=\"(max-width: 590px) 100vw, 590px\" type=\"image/webp\">\n        <source srcset=\"/static/d4b535fa8f201439b10aa5e2ce199557/cf440/ghost.png 148w,\n/static/d4b535fa8f201439b10aa5e2ce199557/d2d38/ghost.png 295w,\n/static/d4b535fa8f201439b10aa5e2ce199557/b9e4f/ghost.png 590w,\n/static/d4b535fa8f201439b10aa5e2ce199557/f9b6a/ghost.png 885w,\n/static/d4b535fa8f201439b10aa5e2ce199557/2d849/ghost.png 1180w,\n/static/d4b535fa8f201439b10aa5e2ce199557/6de9f/ghost.png 2542w\" sizes=\"(max-width: 590px) 100vw, 590px\" type=\"image/png\">\n        <img class=\"gatsby-resp-image-image\" src=\"/static/d4b535fa8f201439b10aa5e2ce199557/b9e4f/ghost.png\" alt=\"Build log\" title=\"Build log\" loading=\"lazy\">\n      </picture>\n    </span>\n</a>\n<h2 id=\"warning\"><a href=\"#warning\" aria-label=\"warning permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Warning</h2>\n<p>Be aware that prices of a spot instance can change over the time and instances can be terminated without a warning. Last black Friday prices of spot instances went up to over 2 dollar occasionally.</p>","frontmatter":{"title":"Runners on the Spot","subtitle":"Auto scaling GitLab runners on AWS with Terraform","date":"2017-12-09","slug":"2017/12/09/runners-on-the-spot","language":null,"tags":["gitlab","docker","aws","terraform"],"authors":["niek"],"comments":null,"cover":{"publicURL":"/static/blob_glow-fbdbbca72604c9ad67cb9e4af73dcbce.jpg"},"coverLink":"https://goo.gl/maps/xSdR9b5xnzu","coverDescription":"Blob","imageTw":{"publicURL":"/static/2017-12-09-runners-on-the-spot-tw-6722873f2d4ed28f373d12d84d49ddad.png"},"imageFb":{"publicURL":"/static/2017-12-09-runners-on-the-spot-fb-b1bbbf8f054dbb6905be8c32e83a5735.png"},"asciinema":true}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"2017/12/09/runners-on-the-spot","previous":{"frontmatter":{"title":"GraphQL","slug":"2017/10/19/graphql-geecon","type":"post","tags":["graphql"],"authors":["niek"]}},"next":{"frontmatter":{"title":"MicroHack Fargate","slug":"2018/01/30/microhack-fargate","type":"post","tags":["aws","terraform","docker","microhack"],"authors":["niek"]}}}}}