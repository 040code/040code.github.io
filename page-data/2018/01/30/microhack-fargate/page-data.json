{"componentChunkName":"component---src-templates-blog-post-js","path":"/2018/01/30/microhack-fargate","result":{"data":{"markdownRemark":{"id":"d0d945da-40ce-5624-bda0-66a9448522a0","excerpt":"Last December at the AWS re:invent, AWS announced the new container service platform Fargate. Fargate is integrated to ECS. The key…","html":"<p>Last December at the AWS re:invent, AWS announced the new container service platform Fargate. Fargate is integrated to ECS. The key difference is that Fargate does not require you to have EC2 instances running to host your containers, which means we have serverless containers. A drawback is that Fargate is not globally available yet, today Fargate is only available in <code class=\"language-text\">us-east-1</code>, see also the <a href=\"https://aws.amazon.com/about-aws/global-infrastructure/regional-product-services/\">list</a> of supported regions. Later in December Fargate also become available in <a href=\"https://www.terraform.io/\">Terraform</a> so time to see how it works.</p>\n<p>In this post I will show how to deploy containers to Fargate using Terraform. As example docker image I will use the blog itself. The complete example in available on <a href=\"https://github.com/npalm/blog_terraform_aws_fargate\">GitHub</a>. First I show how you can deploy a container using Terraform to Fargate. In case you would like to experiment with AWS console instead of Terraform you should be able to execute the same steps direct in AWS. Only the VPC part could be a bit tricky, but even that part can be skipped and replaced with the default VPC. In that case you don’t have private subnets available.</p>\n<p>Finally I will discuss how a deployment with Fargate in ECS compares to a deployment with EC2 in ECS. And show what steps have to be taken to move the deployment from Fargate to EC2 instances.</p>\n<h2 id=\"prerequisites\" style=\"position:relative;\"><a href=\"#prerequisites\" aria-label=\"prerequisites permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Prerequisites</h2>\n<p>Before you start you need to have programmatically access to an AWS account and Terraform (0.11+) installed. The tool <a href=\"http://brewformulas.org/Tfenv\">tfenv</a> let you manage multiple terraform version on your system.</p>\n<h2 id=\"deploy-serverless-containers-on-fargate\" style=\"position:relative;\"><a href=\"#deploy-serverless-containers-on-fargate\" aria-label=\"deploy serverless containers on fargate permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Deploy serverless containers on Fargate</h2>\n<p>Before we can create our containers, we have to create a few infrastructural components. For this example we create an own VPC including public and private subnets. An ECS cluster for our containers, and a CloudWatch log group for centralized logging. The diagram below shows an abstract view of the deployment we are going to create, this view contains two in instead of the 3 availability zones we use.</p>\n<a href=\"#\">\n    <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 56.08108108108109%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAACr0lEQVQoz21ST0zTcBT+dbAEvYgxIUE0AWO86I3EePRqjF4lGk0MCScPnPRgojEe9CImaoygUTMScHEBphB0G7Cxjs12rlu3tR3buu5v11a2FQaMRXiWygig3+m9L9/78r7f+yGkwWQeR4WCuF2iwY+jqCiKTQCg9wDrrSVFfCrL0qqyVPrGLfLd2/wvOd2saQxJPokuXOpB23o+JSCUEtKotKTowxUpjQ27Uwa0gxTP907gXFpUa1D0ft5SwjiUl6ugKFIv2gOATcONvn40NvkdoUm7c4dUsYZgWcldLBRlT622Ds6QAA9HyC0nyUFeSK4EAiRMWUcYScrfyebF20dOnGpCB9GItyKnzk37YmY6KUG9tgq5glivqqXNpJCpOgj2mT8cbTd9Gn/CsCzU1pahXFFhqVTCtZSXX701tbgXCAOi6Cg2+GHYqPkZpBx/3eMn1edfaTC7tI3yeRByRXCRESkaDl1RxGw/HuJzAxOh385AfEOWFaiuroH2dmPzHt/pL9P2ZkQEQkYyQHfNuPB2fduq41hykXw06SKCVJC+NmV33YwwsQ21XIKKugyqWgGSScP7aQqisQTFcVzP44E3Lfsip7O5ZjrKdVB0pPO1aaLD5pi757NZOu2WoVaaCVuHbAw4g6l6JpvdKmumsvYN5Hz6vtvjbWt4xOMJNGKxIvQzGNk15uL8ITrCdNpn5u4Oj1q6zQ72cDbh75vzLTAvrH7wULFaLiO8s8/7zjZm1qormBP3IYcT370FYmMJFGZi+44U4eInHU73cb2vE0fzAvuApMJX92gwP0VjjlmX3nsJP8K9P5Bu5PIQOhnl4sjt/VuzLGeIsPG2QDB0xmpzd52/9dK4Gy+RxKZss3qtJdLmff/8nH0bHqiNVJDSzZhEBiNIUudFUUTz/zH6A5311DMw1KRlAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;\"></span>\n  <picture>\n        <source srcset=\"/static/2701f076404b39a83e017aadc9c77c86/cbe2e/ecs-fargate-diagram.webp 148w,\n/static/2701f076404b39a83e017aadc9c77c86/3084c/ecs-fargate-diagram.webp 295w,\n/static/2701f076404b39a83e017aadc9c77c86/5ca24/ecs-fargate-diagram.webp 590w,\n/static/2701f076404b39a83e017aadc9c77c86/dad35/ecs-fargate-diagram.webp 885w,\n/static/2701f076404b39a83e017aadc9c77c86/2baf0/ecs-fargate-diagram.webp 1180w,\n/static/2701f076404b39a83e017aadc9c77c86/af3f0/ecs-fargate-diagram.webp 1280w\" sizes=\"(max-width: 590px) 100vw, 590px\" type=\"image/webp\">\n        <source srcset=\"/static/2701f076404b39a83e017aadc9c77c86/12f09/ecs-fargate-diagram.png 148w,\n/static/2701f076404b39a83e017aadc9c77c86/e4a3f/ecs-fargate-diagram.png 295w,\n/static/2701f076404b39a83e017aadc9c77c86/fcda8/ecs-fargate-diagram.png 590w,\n/static/2701f076404b39a83e017aadc9c77c86/efc66/ecs-fargate-diagram.png 885w,\n/static/2701f076404b39a83e017aadc9c77c86/c83ae/ecs-fargate-diagram.png 1180w,\n/static/2701f076404b39a83e017aadc9c77c86/21b4d/ecs-fargate-diagram.png 1280w\" sizes=\"(max-width: 590px) 100vw, 590px\" type=\"image/png\">\n        <img class=\"gatsby-resp-image-image\" src=\"/static/2701f076404b39a83e017aadc9c77c86/fcda8/ecs-fargate-diagram.png\" alt=\"Fargate\" title=\"Fargate\" loading=\"lazy\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\">\n      </picture>\n    </span>\n</a>\n<p>We start with defining the VPC, we choose <code class=\"language-text\">us-east-1</code> since Fargate is only available in this region. In the blog post <a href=\"/2017/06/18/terraform-aws-vpc/\">Coding a VPC in Terraform</a> you find more details about how this VPC module is structured.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">provider &quot;aws&quot; {\n  region  = &quot;us-east-1&quot;\n  version = &quot;1.7.1&quot;\n}\n\nprovider &quot;template&quot; {\n  version = &quot;1.0&quot;\n}\n\nmodule &quot;vpc&quot; {\n  source  = &quot;npalm/vpc/aws&quot; // https://registry.terraform.io/modules/npalm/vpc/aws\n  version = &quot;1.1.0&quot;\n\n  environment = &quot;blog&quot;\n  aws_region  = &quot;us-east-1&quot;\n\n  create_private_hosted_zone = &quot;false&quot;\n\n  // us-east-1 is the only region that supports Fargate\n  availability_zones = {\n    us-east-1 = [&quot;us-east-1a&quot;, &quot;us-east-1b&quot;, &quot;us-east-1c&quot;]\n  }\n}</code></pre></div>\n<p>Next we define the ECS cluster, and CloudWatch log group. Since we will deploy to Fargate we don’t have to attache EC2 instances to our cluster.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">resource &quot;aws_ecs_cluster&quot; &quot;cluster&quot; {\n  name = &quot;blog-ecs-cluster&quot;\n}\n\nresource &quot;aws_cloudwatch_log_group&quot; &quot;log_group&quot; {\n  name = &quot;blog&quot;\n}</code></pre></div>\n<p>Now the first part is defined we execute a <code class=\"language-text\">terraform apply</code> and inpect the results.</p>\n<p><asciinema-player src=\"/2018/01/30/microhack-fargate/fargate-terraform-1.json\"\n  cols=\"166\" rows=\"15\" autoplay=\"true\" loop=\"true\" speed=\"1.5\">\n</asciinema-player></p>\n<p>The next step is to deploy the docker image with the blog. In ECS you deploy a docker container with a task. And your task will be managed by a service. First we create the task definition which contains the container deployment definition as well. Fargate is using <a href=\"https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task-networking.html\">awsvpc as networking mode</a>, in this mode each task definiton gets its own private ip address. This network mode requires a role for the task execution. In case you create your definition through the Amazon console a service linked role will be created for you. We will create this role also via code.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">data &quot;aws_iam_policy_document&quot; &quot;ecs_tasks_execution_role&quot; {\n  statement {\n    actions = [&quot;sts:AssumeRole&quot;]\n\n    principals {\n      type        = &quot;Service&quot;\n      identifiers = [&quot;ecs-tasks.amazonaws.com&quot;]\n    }\n  }\n}\n\nresource &quot;aws_iam_role&quot; &quot;ecs_tasks_execution_role&quot; {\n  name               = &quot;blog-ecs-task-execution-role&quot;\n  assume_role_policy = &quot;${data.aws_iam_policy_document.ecs_tasks_execution_role.json}&quot;\n}\n\nresource &quot;aws_iam_role_policy_attachment&quot; &quot;ecs_tasks_execution_role&quot; {\n  role       = &quot;${aws_iam_role.ecs_tasks_execution_role.name}&quot;\n  policy_arn = &quot;arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy&quot;\n}</code></pre></div>\n<p>We have defined the execution rol for the task, next we define the task definion. This task definition consist of two parts. First we define a container definition via a <code class=\"language-text\">template_file</code>. In this container definition you see container port 80 is mapped to host port 80, the task will get its own private IP. And after that we define the task definition self. The following settings are required for a task that will run in Fargate: requires<em>compatibilities, network</em>mode, cpu and memory.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">data &quot;template_file&quot; &quot;blog&quot; {\n  template = &lt;&lt;EOF\n  [\n    {\n      &quot;essential&quot;: true,\n      &quot;image&quot;: &quot;npalm/040code.github.io:latest&quot;,\n      &quot;name&quot;: &quot;blog&quot;,\n      &quot;portMappings&quot;: [\n        {\n          &quot;hostPort&quot;: 80,\n          &quot;protocol&quot;: &quot;tcp&quot;,\n          &quot;containerPort&quot;: 80\n        }\n      ],\n      &quot;logConfiguration&quot;: {\n        &quot;logDriver&quot;: &quot;awslogs&quot;,\n        &quot;options&quot;: {\n          &quot;awslogs-group&quot;: &quot;blog&quot;,\n          &quot;awslogs-region&quot;: &quot;us-east-1&quot;,\n          &quot;awslogs-stream-prefix&quot;: &quot;040code&quot;\n        }\n      }\n    }\n  ]\n\n  EOF\n}\n\nresource &quot;aws_ecs_task_definition&quot; &quot;task&quot; {\n  family                   = &quot;blog-blog&quot;\n  container_definitions    = &quot;${data.template_file.blog.rendered}&quot;\n  network_mode             = &quot;awsvpc&quot;\n  cpu                      = &quot;256&quot;\n  memory                   = &quot;512&quot;\n  requires_compatibilities = [&quot;FARGATE&quot;]\n  execution_role_arn       = &quot;${aws_iam_role.ecs_tasks_execution_role.arn}&quot;\n}</code></pre></div>\n<p>Time to verify the code is working by executing a <code class=\"language-text\">terraform apply</code></p>\n<p><asciinema-player src=\"/2018/01/30/microhack-fargate/fargate-terraform-2.json\"\n  cols=\"166\" rows=\"15\" autoplay=\"true\" loop=\"true\" speed=\"1.0\">\n</asciinema-player></p>\n<a href=\"#\">\n    <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 67.56756756756756%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAIAAACgpqunAAAACXBIWXMAAAsSAAALEgHS3X78AAAB0klEQVQoz1VSXZOjIBD0//+ze7uH29tNYjR+goACCgrG6DUxl3WruiylZ3p6WiJSlXme9Vo5N3nv5tm7abJmwBNv1hozmDE8w8ns3DhawDsHRL/+xGlW11x9nJNTnCU5SQt6uuYFbXF4uZXnpAD+Xm5ZxQhXn+cUNaCA6ET7/r6JcWNmodoT7cW4Sr91bqP9nAtDtNP3DZBzOOx8QDtt0m1RyVWjxn7eXrhvyq3SPbRbu2mJS3rJSaPHjHYFKvV0o203LqjRfo3OGanaAUel6Im0OVMgAiBvl6QWKRXczsIuwt4BNnj5ZLXfoowpqqeUttzM3HiiLIjAzRsf/I2Igut2XFjv0KmfPbt6aMbAnMm6MzDT2rv6z6lg+3Gt2EecV50phIYvKO7Sr8kQTmpetj1RI8a+6X1yJXr9/EQWSOSt+5oM7VqGsahGBm9h4DmZ0xBSV0uLGU0/fauHnZsOnqmykNAHz6CxZFJxLIWF8Smnxx7VdzP0qrbvfhK7bcwBG5cNEt4jOCbyss0GB7ruBjmtx61QysycNRJtMI90fqij+etWwxj+PvKUB24fnhLx+zN+xmmvJQtX6Ni856Tndb9bR2BJ3C2AD641nulJ/7C9/gPVxBkrM0wQsQAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;\"></span>\n  <picture>\n        <source srcset=\"/static/97f5936174c67199672f40abfcc13a0d/cbe2e/container-definition.webp 148w,\n/static/97f5936174c67199672f40abfcc13a0d/3084c/container-definition.webp 295w,\n/static/97f5936174c67199672f40abfcc13a0d/5ca24/container-definition.webp 590w,\n/static/97f5936174c67199672f40abfcc13a0d/dad35/container-definition.webp 885w,\n/static/97f5936174c67199672f40abfcc13a0d/2baf0/container-definition.webp 1180w,\n/static/97f5936174c67199672f40abfcc13a0d/53698/container-definition.webp 2116w\" sizes=\"(max-width: 590px) 100vw, 590px\" type=\"image/webp\">\n        <source srcset=\"/static/97f5936174c67199672f40abfcc13a0d/12f09/container-definition.png 148w,\n/static/97f5936174c67199672f40abfcc13a0d/e4a3f/container-definition.png 295w,\n/static/97f5936174c67199672f40abfcc13a0d/fcda8/container-definition.png 590w,\n/static/97f5936174c67199672f40abfcc13a0d/efc66/container-definition.png 885w,\n/static/97f5936174c67199672f40abfcc13a0d/c83ae/container-definition.png 1180w,\n/static/97f5936174c67199672f40abfcc13a0d/7831d/container-definition.png 2116w\" sizes=\"(max-width: 590px) 100vw, 590px\" type=\"image/png\">\n        <img class=\"gatsby-resp-image-image\" src=\"/static/97f5936174c67199672f40abfcc13a0d/fcda8/container-definition.png\" alt=\"Fargate\" title=\"Fargate\" loading=\"lazy\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\">\n      </picture>\n    </span>\n</a>\n<p>We have still nothing running but you can already see the different parts in de AWS console. We have now a VPC, CloudWatch log group, ECS cluster and task definition available. The next logical step in de AWS console would be to create the service, and find out at the latest step that you need to create a load balancer first. So in code we will define the load balancer first. The load balancer will route traffic via HTTP to the container.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">resource &quot;aws_security_group&quot; &quot;alb_sg&quot; {\n  name   = &quot;blog-blog-alb-sg&quot;\n  vpc_id = &quot;${module.vpc.vpc_id}&quot;\n\n  ingress {\n    protocol    = &quot;tcp&quot;\n    from_port   = 80\n    to_port     = 80\n    cidr_blocks = [&quot;0.0.0.0/0&quot;]\n  }\n\n  egress {\n    from_port = 0\n    to_port   = 0\n    protocol  = &quot;-1&quot;\n\n    cidr_blocks = [&quot;0.0.0.0/0&quot;]\n  }\n}\n\nresource &quot;aws_alb&quot; &quot;main&quot; {\n  internal        = &quot;false&quot;\n  subnets         = [&quot;${module.vpc.public_subnets}&quot;]\n  security_groups = [&quot;${aws_security_group.alb_sg.id}&quot;]\n}\n\nresource &quot;aws_alb_listener&quot; &quot;main&quot; {\n  load_balancer_arn = &quot;${aws_alb.main.id}&quot;\n  port              = 80\n  protocol          = &quot;HTTP&quot;\n\n  default_action {\n    target_group_arn = &quot;${aws_alb_target_group.main.id}&quot;\n    type             = &quot;forward&quot;\n  }\n}</code></pre></div>\n<p>We connect a target group to the load balancer. The same target group will be used later in the service, the service can register itself to the target group with the actual IP address once up and running. For the target group we have to specify the target type <code class=\"language-text\">ip</code> and not <code class=\"language-text\">instance</code> since containers running in Fargate will get their own IP. Actually this not Fargate but <code class=\"language-text\">awsvpc</code> behavior.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">resource &quot;aws_alb_target_group&quot; &quot;main&quot; {\n  port        = &quot;80&quot;\n  protocol    = &quot;HTTP&quot;\n  vpc_id      = &quot;${module.vpc.vpc_id}&quot;\n  target_type = &quot;ip&quot;\n}\n\noutput &quot;blog_url&quot; {\n  value = &quot;http://${aws_alb.main.dns_name}&quot;\n}</code></pre></div>\n<p>Again we verify our new code by executing a <code class=\"language-text\">terraform apply</code>.</p>\n<p><asciinema-player src=\"/2018/01/30/microhack-fargate/fargate-terraform-3.json\"\n  cols=\"166\" rows=\"15\" autoplay=\"true\" loop=\"true\" speed=\"1.5\">\n</asciinema-player></p>\n<p>We are almost there, next we define the service. A task running in in network mode <code class=\"language-text\">awsvpc</code>, requires a service that defines a network configuration. In the networking configuration we define a security group to control access to our containers, and we define the subnets in which the containers are hosted.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">resource &quot;aws_security_group&quot; &quot;awsvpc_sg&quot; {\n  name   = &quot;blog-awsvpc-cluster-sg&quot;\n  vpc_id = &quot;${module.vpc.vpc_id}&quot;\n\n  ingress {\n    protocol  = &quot;tcp&quot;\n    from_port = 0\n    to_port   = 65535\n\n    cidr_blocks = [\n      &quot;${module.vpc.vpc_cidr}&quot;,\n    ]\n  }\n\n  egress {\n    from_port   = 0\n    to_port     = 65535\n    protocol    = &quot;tcp&quot;\n    cidr_blocks = [&quot;0.0.0.0/0&quot;]\n  }\n\n  tags {\n    Name        = &quot;blog-ecs-cluster-sg&quot;\n    Environment = &quot;blog&quot;\n  }\n}</code></pre></div>\n<p>The last resource to create is the service. In the service we connect the task, load balancer and security group together. By setting the launch type to <code class=\"language-text\">FARGATE</code> we tell Amazon to deploy the container to Fargate.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">resource &quot;aws_ecs_service&quot; &quot;service&quot; {\n  name            = &quot;blog&quot;\n  cluster         = &quot;${aws_ecs_cluster.cluster.id}&quot;\n  task_definition = &quot;${aws_ecs_task_definition.task.arn}&quot;\n  desired_count   = 1\n\n  load_balancer = {\n    target_group_arn = &quot;${aws_alb_target_group.main.arn}&quot;\n    container_name   = &quot;blog&quot;\n    container_port   = 80\n  }\n\n  launch_type = &quot;FARGATE&quot;\n\n  network_configuration {\n    security_groups = [&quot;${aws_security_group.awsvpc_sg.id}&quot;]\n    subnets         = [&quot;${module.vpc.private_subnets}&quot;]\n  }\n\n  depends_on = [&quot;aws_alb_listener.main&quot;]\n}</code></pre></div>\n<p>That is the last part of coding, run <code class=\"language-text\">terraform apply</code> and inspect the result.</p>\n<p><asciinema-player src=\"/2018/01/30/microhack-fargate/fargate-terraform-4.json\"\n  cols=\"166\" rows=\"15\" autoplay=\"true\" loop=\"true\" speed=\"1.5\">\n</asciinema-player></p>\n<p>That is all, we have now our blog running as serverless container in AWS Fargate.</p>\n<a href=\"#\">\n    <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 51.35135135135135%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsSAAALEgHS3X78AAABD0lEQVQoz42Ra27DIBCEuf9BepNKvUNSVyG8zCsmxhjsOO4E1P5rk+/HCsme2dldoqSSUva95lwopTjnt9vt/jf7vuecIbHWkjQ9SCldK+EaIN7/BRZLhWzbVpaCCr9xinlb9pch67qioRSCMXa5XOIYEeS+318StxhnSruuwxhSSK11m+25eCvjkgJk0KCz934YhpRmgFmeiJVxX9w654wxfd+HECDWFUzUcmGFMGq1sVbI+yG8fWiMPc+p1vlXgwcEpZQpxnYR0B7WGMQkOUWreNsWmh8PR5zaOyfr2Rk7CynxVf5UUaGnE8KSnAtXMDK4cYyxmifjLdNiCNdPqqyDlcMuHtV5Sil+ZpwjwjfzCD7rxWEvrwAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;\"></span>\n  <picture>\n        <source srcset=\"/static/05b2cf60a35d313afb24fcc3ffa029f7/cbe2e/ecs-fargate.webp 148w,\n/static/05b2cf60a35d313afb24fcc3ffa029f7/3084c/ecs-fargate.webp 295w,\n/static/05b2cf60a35d313afb24fcc3ffa029f7/5ca24/ecs-fargate.webp 590w,\n/static/05b2cf60a35d313afb24fcc3ffa029f7/dad35/ecs-fargate.webp 885w,\n/static/05b2cf60a35d313afb24fcc3ffa029f7/9c2f0/ecs-fargate.webp 1085w\" sizes=\"(max-width: 590px) 100vw, 590px\" type=\"image/webp\">\n        <source srcset=\"/static/05b2cf60a35d313afb24fcc3ffa029f7/12f09/ecs-fargate.png 148w,\n/static/05b2cf60a35d313afb24fcc3ffa029f7/e4a3f/ecs-fargate.png 295w,\n/static/05b2cf60a35d313afb24fcc3ffa029f7/fcda8/ecs-fargate.png 590w,\n/static/05b2cf60a35d313afb24fcc3ffa029f7/efc66/ecs-fargate.png 885w,\n/static/05b2cf60a35d313afb24fcc3ffa029f7/6d74e/ecs-fargate.png 1085w\" sizes=\"(max-width: 590px) 100vw, 590px\" type=\"image/png\">\n        <img class=\"gatsby-resp-image-image\" src=\"/static/05b2cf60a35d313afb24fcc3ffa029f7/fcda8/ecs-fargate.png\" alt=\"Fargate\" title=\"Fargate\" loading=\"lazy\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\">\n      </picture>\n    </span>\n</a>\n<h2 id=\"mixing-ec2-and-fargate-on-ecs\" style=\"position:relative;\"><a href=\"#mixing-ec2-and-fargate-on-ecs\" aria-label=\"mixing ec2 and fargate on ecs permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Mixing EC2 and Fargate on ECS</h2>\n<p>Great we have now our container running in ECS with Fargate but what if we would like to move the container to a dedicated EC2 instances in ECS. Or what if we need that are not available in in Fargate, such as a volume mount? How difficult would it be to move our containers to an ECS cluster with dedicated EC2 instances? Time to do an experiment to see how difficult is is.</p>\n<p>First we refactor the above code to some <a href=\"https://github.com/npalm/terraform-aws-ecs-service\">generic ecs service modules</a> to be able to define our services with just a few lines of code. This module replaces all code of defining the load balancer, service and task. It still requires a VPC, ECS cluster, CloudWatch logging group, awsvpc security group and execution role. In the code you see a similar deployment of the blog but now with a generic ECS service module.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">locals {\n  fg_container_name = &quot;blog&quot;\n  fg_container_port = &quot;80&quot;\n}\n\ndata &quot;template_file&quot; &quot;blog&quot; {\n  template = &quot;${file(&quot;${path.root}/task-definition/blog.json&quot;)}&quot;\n\n  vars {\n    container_name   = &quot;${local.fg_container_name}&quot;\n    container_port   = &quot;${local.fg_container_port}&quot;\n    log_group_name   = &quot;${aws_cloudwatch_log_group.log_group.name}&quot;\n    log_group_region = &quot;${var.aws_region}&quot;\n    log_group_prefix = &quot;blog&quot;\n  }\n}\n\nmodule &quot;blog-fg&quot; {\n  source = &quot;npalm/ecs-service/aws&quot; // https://registry.terraform.io/modules/npalm/ecs-service/aws\n\n  service_launch_type  = &quot;FARGATE&quot;\n  service_name          = &quot;${local.fg_container_name}&quot;\n\n  vpc_id       = &quot;${module.vpc.vpc_id}&quot;\n  vpc_cidr     = &quot;${module.vpc.vpc_cidr}&quot;\n  lb_subnetids = &quot;${module.vpc.public_subnets}&quot;\n  ecs_cluster_id = &quot;${aws_ecs_cluster.cluster.id}&quot;\n  lb_internal = false\n\n  task_definition = &quot;${data.template_file.blog.rendered}&quot;\n  task_cpu        = &quot;256&quot;\n  task_memory     = &quot;512&quot;\n\n  awsvpc_task_execution_role_arn = &quot;${aws_iam_role.ecs_tasks_execution_role.arn}&quot;\n  awsvpc_service_security_groups = [&quot;${aws_security_group.awsvpc_sg.id}&quot;]\n  awsvpc_service_subnetids       = &quot;${module.vpc.private_subnets}&quot;\n\n  lb_target_group = {\n    container_name = &quot;${local.fg_container_name}&quot;\n    container_port = &quot;${local.fg_container_port}&quot;\n  }\n\n  lb_listener = {\n    port     = 80\n    protocol = &quot;HTTP&quot;\n  }\n}</code></pre></div>\n<p>We still have our container not running in ECS on EC2 instances. For that we first have to create EC2 instances that will be attached to the same ECS cluster. For more details about create the EC2 instances see the <a href=\"https://github.com/npalm/terraform-aws-ecs-instances\">ecs instance repo</a> on GitHub.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">locals {\n  key_name = &quot;blog&quot;\n  environment = &quot;dev&quot;\n}\n\nresource &quot;aws_key_pair&quot; &quot;key&quot; {\n  key_name   = &quot;${local.key_name}&quot;\n  public_key = &quot;${file(&quot;id_rsa&quot;)}&quot;\n}\n\nmodule &quot;ecs_instances&quot; {\n  source  = &quot;npalm/ecs-instances/aws&quot; // https://registry.terraform.io/modules/npalm/ecs-instances/aws\n\n  ecs_cluster_name = &quot;${aws_ecs_cluster.cluster.name}&quot;\n  aws_region       = &quot;${local.aws_region}&quot;\n  environment      = &quot;${local.environment}&quot;\n  key_name         = &quot;${local.key_name}&quot;\n  vpc_id           = &quot;${module.vpc.vpc_id}&quot;\n  vpc_cidr         = &quot;${module.vpc.vpc_cidr}&quot;\n  subnets          = &quot;${module.vpc.private_subnets}&quot;\n}</code></pre></div>\n<p>Now we have our EC2 instances available we only have to copy the the blog module above and change the launch type to <code class=\"language-text\">EC2</code>, and our container will be deployed to a dedicated EC2 instance.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">module &quot;blog-ec&quot; {\n  source = &quot;npalm/ecs-service/aws&quot; // https://registry.terraform.io/modules/npalm/ecs-service/aws\n\n  service_launch_type  = &quot;FARGATE&quot;\n  service_name          = &quot;blog-ec2&quot;\n\n  ... SAME AS ABOVE ...\n}</code></pre></div>\n<p>That is all, all sample code is available at <a href=\"https://github.com/npalm/blog_terraform_aws_fargate\">GitHub</a> see subdir <code class=\"language-text\">fargate-ec2</code>. Time to run a <code class=\"language-text\">terraform apply</code> to see if it works.</p>\n<p><asciinema-player src=\"/2018/01/30/microhack-fargate/fargate-ec2.json\"\n  cols=\"166\" rows=\"15\" autoplay=\"true\" loop=\"true\" speed=\"1.5\">\n</asciinema-player></p>\n<p>In the output you will find the two endpoint links to the blogs. After a few minutes both links will be active. You can also see the service running on the Amazon console, simply navigate to the ECS console and select the cluster. You should see now one service on Fargate and the second one on EC2.</p>\n<a href=\"#\">\n    <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 53.37837837837838%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsSAAALEgHS3X78AAABHUlEQVQoz5VSW3KEIBDk/nfIZXIPk1peykNU2IJVYUkvJPlKJZuuckqEHrubIZyLaZoopUopRllKqdZ6/xVGGyllCIHEGEG4NvirP8+z/oVSSs4ZXchxHOX+WHgfbnmv/wFZ15VROgwDZHvvt21D42fJ+DtolDHn3GytMQYqniWX/WoMOHb5Qmp4pgUZmLJ21lojc9dgrR3H8cfY4ajX/kJeXicfQooJ0e/7/m24b+dcYoodKfV6Q7RaKRwmapKcs7kBsXEh3OKgQmkthYAEDAJuVYhH7eCcYy5wTYRJNVwkrCJn3wDyu7ws6/pGpRiV0RpGECq6gzNKtONYYiLIFg8bjnuTCp14zpLd7nMpxh/h9jkzj61aEUTzkvuXD/s6ejsZi8g0AAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;\"></span>\n  <picture>\n        <source srcset=\"/static/9bf9eac181171c2eb608b40db7953d4c/cbe2e/ecs-fargate-2.webp 148w,\n/static/9bf9eac181171c2eb608b40db7953d4c/3084c/ecs-fargate-2.webp 295w,\n/static/9bf9eac181171c2eb608b40db7953d4c/5ca24/ecs-fargate-2.webp 590w,\n/static/9bf9eac181171c2eb608b40db7953d4c/dad35/ecs-fargate-2.webp 885w,\n/static/9bf9eac181171c2eb608b40db7953d4c/d30cc/ecs-fargate-2.webp 1092w\" sizes=\"(max-width: 590px) 100vw, 590px\" type=\"image/webp\">\n        <source srcset=\"/static/9bf9eac181171c2eb608b40db7953d4c/12f09/ecs-fargate-2.png 148w,\n/static/9bf9eac181171c2eb608b40db7953d4c/e4a3f/ecs-fargate-2.png 295w,\n/static/9bf9eac181171c2eb608b40db7953d4c/fcda8/ecs-fargate-2.png 590w,\n/static/9bf9eac181171c2eb608b40db7953d4c/efc66/ecs-fargate-2.png 885w,\n/static/9bf9eac181171c2eb608b40db7953d4c/2cffa/ecs-fargate-2.png 1092w\" sizes=\"(max-width: 590px) 100vw, 590px\" type=\"image/png\">\n        <img class=\"gatsby-resp-image-image\" src=\"/static/9bf9eac181171c2eb608b40db7953d4c/fcda8/ecs-fargate-2.png\" alt=\"Fargate\" title=\"Fargate\" loading=\"lazy\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\">\n      </picture>\n    </span>\n</a>","frontmatter":{"title":"MicroHack Fargate","subtitle":"Running serverless containers with Terraform","date":"2018-01-30","slug":"2018/01/30/microhack-fargate","language":null,"tags":["aws","terraform","docker","microhack"],"authors":["niek"],"comments":null,"cover":{"publicURL":"/static/5f274d2e7f9dd77747d836a11b317709/strijps-containers.jpg"},"coverLink":"https://goo.gl/maps/frNLw6shgEP2","coverDescription":"Containers Leidingstraat - Strijp S","imageTw":{"publicURL":"/static/225197210f0ca93bedfa6b7d64f6c671/2018-01-30-microhack-fargate-tw.png"},"imageFb":{"publicURL":"/static/b956a385493c3a547571f1e1965863ac/2018-01-30-microhack-fargate-fb.png"},"asciinema":true}}},"pageContext":{"slug":"2018/01/30/microhack-fargate","previous":{"frontmatter":{"title":"Runners on the Spot","slug":"2017/12/09/runners-on-the-spot","type":"post","tags":["gitlab","docker","aws","terraform"],"authors":["niek"]}},"next":{"frontmatter":{"title":"Service Discovery on AWS","slug":"2018/02/14/service-discovery-on-aws","type":"post","tags":["aws","spring","docker"],"authors":["niek"]}}}}}