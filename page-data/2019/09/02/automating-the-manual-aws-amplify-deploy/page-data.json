{"componentChunkName":"component---src-templates-blog-post-js","path":"/2019/09/02/automating-the-manual-aws-amplify-deploy","webpackCompilationHash":"e8a7e3726cd38540600c","result":{"data":{"markdownRemark":{"id":"bc7aa395-f9ad-52f9-9bc1-d8898d43a774","excerpt":"This post explain how to deploy a branch from a self hosted Git server to AWS Amplify Console for a web application. Introduction Last year…","html":"<p><em>This post explain how to deploy a branch from a self hosted Git server to AWS Amplify Console for a web application.</em></p>\n<p style=\"text-align: right\">\n  <a href=\"https://github.com/npalm/aws-amplify-deploy\" target=\"sourcecode\">\n  <i class=\"fab fa-github\" style=\"font-size: 200%\">&nbsp;</i>Source code for this post</a></p>\n<h2 id=\"introduction\"><a href=\"#introduction\" aria-label=\"introduction permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Introduction</h2>\n<p>Last year Amazon released Amplify Console, a feature to easily deploy any branch for your web application to the cloud. Connected Git systems are, GitHub, GitLab, BitBucket and CodeCommit. Which limitted the usage if you code resides in a self hosted Git. Later Amazon added a manual deploy option to deploy based on a zip file. The zip archive can be uploaded via the web interface, an HTTP link or via an S3 bucket. Would be handy if we can automate this process to utilize this AWS feature in a self hosted Git server. </p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 55.06607929515418%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsSAAALEgHS3X78AAABRUlEQVQoz5VRTU+DQBDdv82vsL+BuxcvHkyMiSSaeDAxJi00gTaphQW1LB8F9gN8uwuW4MnJ28kw7L6ZN0Oi3T6KdmEY+cF2s/HXaz8ItmVZcSG6ruMA552F/h69NcKKIs+ZQc4Y4rwoCiGEmpuUSi0S2siJMZpl2efX9ylvDSv8uWmb9gKTaQDENVzX9YM2wqUQUthOkMaPv7CMFo32XJrixLwSw2T9ZMsMgllGGZCcFeiYG250JY08HFvwIr7vESOJlH5sjICvqqrD4YOmWZxQ3YaUAMYQYgvR3tKBA5qPxxjbgWrUxx2Cg4hS6jjO6mqFGAWVaTum6evbO6WZvir0NRDd3T9e39za4uPjJElc1/U8b3ysFIKyqpM0retzr3uW2kvpPb08eM9WDpkUjeOwgn+3CyJMZr7l3g7Mal5MdfiP/QAir3nOaAvzoQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n        <source\n          srcset=\"/static/ba2bb350bafdf1aa4d0ce56d98bec743/cc182/manual.webp 148w,\n/static/ba2bb350bafdf1aa4d0ce56d98bec743/f7e40/manual.webp 295w,\n/static/ba2bb350bafdf1aa4d0ce56d98bec743/1a2f4/manual.webp 590w,\n/static/ba2bb350bafdf1aa4d0ce56d98bec743/4837b/manual.webp 885w,\n/static/ba2bb350bafdf1aa4d0ce56d98bec743/2f819/manual.webp 1180w,\n/static/ba2bb350bafdf1aa4d0ce56d98bec743/fb2f9/manual.webp 1362w\"\n          sizes=\"(max-width: 590px) 100vw, 590px\"\n          type=\"image/webp\"\n        />\n        <source\n          srcset=\"/static/ba2bb350bafdf1aa4d0ce56d98bec743/cf440/manual.png 148w,\n/static/ba2bb350bafdf1aa4d0ce56d98bec743/d2d38/manual.png 295w,\n/static/ba2bb350bafdf1aa4d0ce56d98bec743/b9e4f/manual.png 590w,\n/static/ba2bb350bafdf1aa4d0ce56d98bec743/f9b6a/manual.png 885w,\n/static/ba2bb350bafdf1aa4d0ce56d98bec743/2d849/manual.png 1180w,\n/static/ba2bb350bafdf1aa4d0ce56d98bec743/c20f6/manual.png 1362w\"\n          sizes=\"(max-width: 590px) 100vw, 590px\"\n          type=\"image/png\"\n        />\n        <img\n          class=\"gatsby-resp-image-image\"\n          src=\"/static/ba2bb350bafdf1aa4d0ce56d98bec743/b9e4f/manual.png\"\n          alt=\"manual\"\n          title=\"manual\"\n          loading=\"lazy\"\n        />\n      </picture>\n    </span></p>\n<p>Let’s explore how we can automate the manual option for a self hosted Git server.</p>\n<h2 id=\"step-1---create-your-app\"><a href=\"#step-1---create-your-app\" aria-label=\"step 1   create your app permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Step 1 - Create your app</h2>\n<p>The first step is to create you app in Amplify, you can do this in the web console but, we don’t like manual steps. Creating your app is as simple as the the one liner below.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">APP_ID</span><span class=\"token operator\">=</span><span class=\"token punctuation\">$(</span>aws amplify create-app --name blog <span class=\"token operator\">|</span> jq -r <span class=\"token string\">'.app.appId'</span></code></pre></div>\n<p>The output we capture in a variable <code class=\"language-text\">APP_ID</code> for later use. </p>\n<h2 id=\"step-2---create-branch\"><a href=\"#step-2---create-branch\" aria-label=\"step 2   create branch permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Step 2 - Create branch</h2>\n<p>Before you can deploy a branch, we need to create a branch in Amplify. To avoid we run the command if a the branch already exists we do a quick check. You can also add a password to protect our web app via basic authentication. </p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">BRANCH_NAME</span><span class=\"token operator\">=</span>test\n<span class=\"token assign-left variable\">branch_count</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span>aws amplify list-branches --app-id $APP_ID <span class=\"token operator\">|</span> <span class=\"token punctuation\">\\</span>\n  jq -r <span class=\"token string\">'[.branches[] | select(.branchName | contains(\"'</span>$BRANCH_NAME'\"<span class=\"token punctuation\">)</span> <span class=\"token variable\">)</span></span><span class=\"token punctuation\">]</span> <span class=\"token operator\">|</span> length'<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span> <span class=\"token variable\">$branch_count</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n    <span class=\"token assign-left variable\">basic_auth</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token builtin class-name\">echo</span> -n blog:somebetterpwd <span class=\"token operator\">|</span> openssl base64<span class=\"token variable\">)</span></span>\n    aws amplify create-branch --app-id <span class=\"token variable\">$APP_ID</span> <span class=\"token punctuation\">\\</span> \n    --branch-name <span class=\"token variable\">$BRANCH_NAME</span> <span class=\"token punctuation\">\\</span> \n    --enable-basic-auth --basic-auth-credentials <span class=\"token variable\">$basic_auth</span>\n<span class=\"token keyword\">fi</span></code></pre></div>\n<h2 id=\"step-3---deployment\"><a href=\"#step-3---deployment\" aria-label=\"step 3   deployment permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Step 3 - deployment</h2>\n<p>Finally we can deploy our app. Finding a way to deploy automated in the case Amazon was call manually, was a bit hard due to the lack of documentation and posts. For doing a deployment from a non connected Git (aka manual deployment) you have the option in we web console to provide a public link, upload file, or ink to file in S3. The AWS CLI docs does not mention the S3 option. The post <a href=\"https://aws.amazon.com/blogs/mobile/deploy-files-s3-dropbox-amplify-console/\">Deploy files stored on Amazon S3, Dropbox, or your Desktop to the AWS Amplify Console</a> suggest to upload the file ot a S3 and create a lambda that will a deployment for a new file. We choose a slightly different approach. First we send our app as zip to S3.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">yarn</span> build <span class=\"token operator\">&amp;&amp;</span> <span class=\"token builtin class-name\">cd</span> build\n<span class=\"token function\">zip</span> -r <span class=\"token variable\">$BRANCH_NAME</span>.zip <span class=\"token builtin class-name\">.</span>\naws s3 <span class=\"token function\">cp</span> <span class=\"token variable\">$BRANCH_NAME</span>.zip s3://<span class=\"token variable\">$S3_BUCKET_NAME</span></code></pre></div>\n<p>Now we need to find a way to trigger the deployment. The option <code class=\"language-text\">--source-url</code> for starting a deployment does not mention that a S3 url is an option as well. So we tried it and it works perfect.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">aws amplify start-deployment --app-id <span class=\"token variable\">$APP_ID</span> <span class=\"token punctuation\">\\</span> \n  --branch-name <span class=\"token variable\">$BRANCH_NAME</span> <span class=\"token punctuation\">\\</span> \n  --source-url s3://<span class=\"token variable\">$S3_BUCKET_NAME</span>/<span class=\"token variable\">$BRANCH_NAME</span>.zip</code></pre></div>\n<p>Another option to do a deployment is via sending the zip archive to a signed S3 link which will be provided if you leave out the <code class=\"language-text\">--source-url</code> option. </p>\n<p>So that is all we have to do for automating a manual deployment. A script based on the snippets shown above a available on <a href=\"https://github.com/npalm/aws-amplify-deploy\">GitHub</a>.</p>\n<p><asciinema-player src=\"/2019/09/02/automating-the-manual-aws-amplify-deploy/deploy.json\"\n  cols=\"180\" rows=\"15\" autoplay=\"true\" loop=\"true\" speed=\"2.0\">\n</asciinema-player></p>","frontmatter":{"title":"Micro Hack - AWS Amplify","subtitle":"Automating the manual deployment","date":"2019-09-02","slug":"2019/09/02/automating-the-manual-aws-amplify-deploy","language":null,"tags":["aws","cicd","amplify","cloud"],"authors":["niek"],"comments":false,"cover":{"publicURL":"/static/watertoren-78b444e964a5c0cd2e0dfbe34c302fba.jpg"},"coverLink":"https://goo.gl/maps/SM34eDmZL1apETVx6","coverDescription":"Watertoren","imageTw":{"publicURL":"/static/2019-09-02-automating-the-manual-aws-amplify-deploy-tw-cfa21aa2d9f378993faa6b24bdf362d5.png"},"imageFb":{"publicURL":"/static/2019-09-02-automating-the-manual-aws-amplify-deploy-fb-263a1372284be8e4d5d327a5943cdaf2.png"},"asciinema":true}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"2019/09/02/automating-the-manual-aws-amplify-deploy","previous":{"frontmatter":{"title":"Service Mesh","slug":"2019/07/01/cross-cluster-service-mesh","type":"post","tags":["kubernetes","service mesh","cloud","aws","google","docker"],"authors":["niek"]}},"next":{"frontmatter":{"title":"Full Stack Fest 2019","slug":"2019/09/12/full-stack-fest-2019","type":"post","tags":["fullstack","frontend","backend","conference"],"authors":["jeroen"]}}}}}