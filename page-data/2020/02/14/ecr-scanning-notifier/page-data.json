{"componentChunkName":"component---src-templates-blog-post-js","path":"/2020/02/14/ecr-scanning-notifier","result":{"data":{"markdownRemark":{"id":"1131070b-5e9a-5407-9e36-22675441dccc","excerpt":"This post explains how to scan docker images on AWS ECR and get notified when a new vulnerability is found. Introduction On October 201…","html":"<p><em>This post explains how to scan docker images on AWS ECR and get notified when a new vulnerability is found.</em></p>\n<p style=\"text-align: right\">\n  <a href=\"https://github.com/philips-labs/aws-ecr-scanning-slack-notifications\" target=\"sourcecode\">\n  <i class=\"fab fa-github\" style=\"font-size: 200%\">&nbsp;</i>Source code for this post</a></p>\n<h2 id=\"introduction\" style=\"position:relative;\"><a href=\"#introduction\" aria-label=\"introduction permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Introduction</h2>\n<p>On October 2019, AWS released a nice <a href=\"https://aws.amazon.com/about-aws/whats-new/2019/10/announcing-image-scanning-for-amazon-ecr/\">feature</a> on AWS ECR (Elastic Container Registry). They introduced the ability to scan docker images hosted within ECR in order to detect vulnerabilities.</p>\n<p>ECR scanning is free of charge, but you can only scan the same image every 24 hours. You get throttled if you make more than 1 request within 1 day. Naturally, scans are only triggered when an image is pushed. This blog explains how to trigger the scans at your own pace (for example, on a daily basis).</p>\n<p>Since we love automation, we have decided to automate scanning task using a full serverless application that sends via slack a notification when there is a change in the scanning results.</p>\n<h2 id=\"why\" style=\"position:relative;\"><a href=\"#why\" aria-label=\"why permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Why?</h2>\n<p>Docker images are pulled left and right. You find yourself constantly looking for that new image which solves the majority of your problems. You find it. You pull it. You execute it. You like it. You decide to push it to your own ECR Registry because you’re afraid the original publisher eventually deletes it from DockerHub, or you simply need a private docker registry. But did you really check what was inside it? Are you aware of all the libraries and packages this image is using? What if there are critical security issues with that image that may compromise the software you’re running? What if your company loses tens of thousands (or maybe millions) of dollars just because a vulnerability that was never known?</p>\n<p>It may sound scary, and it actually is! Vulnerabilities are everywhere and there’s very little you can do to mitigate the problem on your own. Usually, responsible publishers fix these vulnerabilities as soon as they are detected. However, not using a compromised image already is a step in the right direction. Automating this process is even nicer because you can react on it and decide what path to take: whether tailoring your own Docker images or just temporarily suspending the use for a compromised one.</p>\n<h2 id=\"how\" style=\"position:relative;\"><a href=\"#how\" aria-label=\"how permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>How?</h2>\n<p>There are mainly two ways which you can scan your Docker images for vulnerabilities:</p>\n<ol>\n<li>Enabling <em>Scan on push</em> for a given ECR registry, which will scan every image and output the results within the ECR console.</li>\n<li>Using the AWS SDK to invoke the APIs in an automated way.</li>\n</ol>\n<p>We like #2 because the more automated a process is the better. For example using Terraform:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">resource &quot;aws_ecr_repository&quot; &quot;my_repo&quot; {\n  name                 = &quot;my-image&quot;\n\n  image_scanning_configuration {\n    scan_on_push = true\n  }\n}</code></pre></div>\n<h2 id=\"notifying-changes\" style=\"position:relative;\"><a href=\"#notifying-changes\" aria-label=\"notifying changes permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Notifying Changes</h2>\n<p>You don’t want to be notified every single time a image was scanned, do you? You only want to be notified when there were vulnerabilities detected for a new image or if the vulnerabilities for a previously scanned image have changed. This means that this state must be stored somewhere. DynamoDB is a great choice here because we can easily store such state there and we can also react to any Table changes using DynamoDB Streams. Do you smell an Event Driven Architecture already?</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 89.1891891891892%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAAAsSAAALEgHS3X78AAADbklEQVQ4y2NgQAJ8DKwgiimF1xDM2C0cZrBZKEgHxA7hUGNiIBXwMbJzACnW6ew2/McEw40OCYVbrufzUQZZws/Ezg2kGUkykJeBhRNEVyv6SS4RDwpeKRYU2CftrwISE2JgYWdkYmIm1ZHsooraLGp6dmIqQKyqZyeopmsrqmjhDgoCNiZmVsLe/tpqAmczMjJy4FIHlGMHeZ2wgb1OYPr/uxgGVxN1rlWJukxCmj4M5roOjA56jgysYgZgeX9jBa48e1kWENteQ4Lha4sJbkMPxEuhBPb//+/g7Jm+Ygyocv/hbNMjb6H0C0aDXYsgrv/aZgo27GeTjuKbycFrPjUZBID476rUGT+2WUIMmaHO9qDDo+hprZEtiH+lRJ/xfw84NTHonXkJt6Dz/DpGhm8T3VkgBps1/b895//3WeFXIS55zfi31xoiV6sW//9M1/8fs0If/YeG461aEwa1C79hzhZlObpbF8y+0uwJduGpKgfDxx3uh+51+aaA+NNzfJh2ZRmCNd+oNjd7NS3y+fNp0XNBfG2HAOb/nzcxZC3aC9ab2ne0MnNNxZaewyIiYEO5OVhFwUmNgUECxGViYZEC0iDXMXGxMYPYfMDUrQWkpYFYmJ0JrJbhEdSrN80yo583u3Ye+1kpghLgoXa67MiBjgosmY0yJ8Ijb9PmTWD24SNHNA6dOl6wedvO8mMnzgYw+OdZgBUkzXFiUjYU4/XI1WMRNeQBixk5+IPpDa//Mxjoe/DYOJWwIVsRlBAEDcJLDI4a/Ig0nD7RD8M9vpMVwLRj2HKM/Ctr0o5IRqfLUSWL1viDNWSscLJPmOFQlrDAOiJioS7YtqjWLWC5oNLvpiEFt0uCip4nuhf950FPk6/6fOTvV+jZgDmlC1PAGT5rid/aqt3R/wtXhr127lYQB8tNWwtONslVzyZ3zvv/P7H82R8dt+OgyGHQVbcBZsUopmJghH2ZHXXt/+bi/5+KJVwZ/v0PBxvs0WW0JmC2+f+AfptXOrX8oFhnKJm4HmxZZOKlSY2dH/8HRZ//LaW6DmygopQ+0BeyzB4MDDzvpoWd+Lmy4P/bFnNbBhVDW1FpaQd+rQQ1V+cy21TtNKVgGRstcRVtZ2E1Ey92cOSYT7Fxcl+aamq1IFrDoEYMLUi5QtVY9Vus2RyAbBEASBsNZT8oZQsAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n        <source\n          srcset=\"/static/5bd68d9642c5bed3145f07ca22a98bc0/cbe2e/aws-ecr-notification-architecture.webp 148w,\n/static/5bd68d9642c5bed3145f07ca22a98bc0/3084c/aws-ecr-notification-architecture.webp 295w,\n/static/5bd68d9642c5bed3145f07ca22a98bc0/5ca24/aws-ecr-notification-architecture.webp 590w\"\n          sizes=\"(max-width: 590px) 100vw, 590px\"\n          type=\"image/webp\"\n        />\n        <source\n          srcset=\"/static/5bd68d9642c5bed3145f07ca22a98bc0/12f09/aws-ecr-notification-architecture.png 148w,\n/static/5bd68d9642c5bed3145f07ca22a98bc0/e4a3f/aws-ecr-notification-architecture.png 295w,\n/static/5bd68d9642c5bed3145f07ca22a98bc0/fcda8/aws-ecr-notification-architecture.png 590w\"\n          sizes=\"(max-width: 590px) 100vw, 590px\"\n          type=\"image/png\"\n        />\n        <img\n          class=\"gatsby-resp-image-image\"\n          src=\"/static/5bd68d9642c5bed3145f07ca22a98bc0/fcda8/aws-ecr-notification-architecture.png\"\n          alt=\"architecture\"\n          title=\"Slack Message\"\n          loading=\"lazy\"\n          style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        />\n      </picture>\n    </span></p>\n<h2 id=\"getting-our-hands-dirty\" style=\"position:relative;\"><a href=\"#getting-our-hands-dirty\" aria-label=\"getting our hands dirty permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Getting our hands dirty</h2>\n<h3 id=\"scanning-images\" style=\"position:relative;\"><a href=\"#scanning-images\" aria-label=\"scanning images permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scanning images</h3>\n<p>For our use case, we decided to put all the ECR repositories to be scanned in a <code class=\"language-text\">.json</code> file within an S3 bucket. Everytime the Lambda function runs, it downloads that file, parses it and issues <code class=\"language-text\">listImages</code> for every repository defined and <code class=\"language-text\">startImageScan</code> for every image found.</p>\n<p>Using the Node.js SDK and AWS SDK, we can easily put it together, see <a href=\"https://github.com/philips-labs/aws-ecr-scanning-slack-notifications\">github</a> for the full code.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">scan</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> s3 <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token constant\">S3</span><span class=\"token punctuation\">.</span><span class=\"token function\">getObject</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    Bucket<span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">BUCKET</span><span class=\"token punctuation\">,</span>\n    Key<span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">KEY</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> repositories <span class=\"token operator\">=</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>Buffer<span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span>s3<span class=\"token punctuation\">.</span>Body<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"utf8\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> repository <span class=\"token keyword\">of</span> repositories<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> images <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token constant\">ECR</span><span class=\"token punctuation\">.</span><span class=\"token function\">listImages</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      registryId<span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">REGISTRY_ID</span><span class=\"token punctuation\">,</span>\n      repositoryName<span class=\"token operator\">:</span> repository\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> imageId <span class=\"token keyword\">of</span> images<span class=\"token punctuation\">.</span>imageIds<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">await</span> <span class=\"token constant\">ECR</span><span class=\"token punctuation\">.</span><span class=\"token function\">startImageScan</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n          registryId<span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">REGISTRY_ID</span><span class=\"token punctuation\">,</span>\n          repositoryName<span class=\"token operator\">:</span> repository<span class=\"token punctuation\">,</span>\n          imageId\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Failed scanning image: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>repository<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">:</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>imageId<span class=\"token punctuation\">.</span>imageTag<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>This task is as easy as that. It invokes the SDK to start an image scan. This process will now be run asynchronously in AWS.</p>\n<h3 id=\"analysing-the-results-for-a-scanned-image\" style=\"position:relative;\"><a href=\"#analysing-the-results-for-a-scanned-image\" aria-label=\"analysing the results for a scanned image permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Analysing the results for a Scanned image</h3>\n<p>This could be achieved by reacting to CloudWatch events in AWS, but we decided to go the easy way and periodically poll ECR for the Scan Findings. If something was found, we store the findings in DynamoDB.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">analyse</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> repository <span class=\"token keyword\">of</span> repositories<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> images <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token constant\">ECR</span><span class=\"token punctuation\">.</span><span class=\"token function\">listImages</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      registryId<span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">REGISTRY_ID</span><span class=\"token punctuation\">,</span>\n      repositoryName<span class=\"token operator\">:</span> repository\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> imageId <span class=\"token keyword\">of</span> images<span class=\"token punctuation\">.</span>imageIds<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> results <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token constant\">ECR</span><span class=\"token punctuation\">.</span><span class=\"token function\">describeImageScanFindings</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n        registryId<span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">REGISTRY_ID</span><span class=\"token punctuation\">,</span>\n        repositoryName<span class=\"token operator\">:</span> repository<span class=\"token punctuation\">,</span>\n        imageId\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>results<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        dynamoDbPromises<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>\n          DynamoDB<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n            TableName<span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">DOCKER_IMAGES_VULNERABILITIES_TABLE</span><span class=\"token punctuation\">,</span>\n            Item<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n              sha_digest<span class=\"token operator\">:</span> imageId<span class=\"token punctuation\">.</span>imageDigest<span class=\"token punctuation\">,</span>\n              tag<span class=\"token operator\">:</span> imageId<span class=\"token punctuation\">.</span>imageTag<span class=\"token punctuation\">,</span>\n              aws_vulnerabilities<span class=\"token operator\">:</span> results<span class=\"token punctuation\">.</span>imageScanFindings<span class=\"token punctuation\">.</span>findingSeverityCounts<span class=\"token punctuation\">,</span>\n              repository<span class=\"token operator\">:</span> repository<span class=\"token punctuation\">,</span>\n              registry_id<span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">REGISTRY_ID</span><span class=\"token punctuation\">,</span>\n              last_run<span class=\"token operator\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toISOString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span>\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">await</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">all</span><span class=\"token punctuation\">(</span>dynamoDbPromises<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>The code snippet above always inserts data into DynamoDB, because we don’t want to check during analysis time whether something has changed or not. This would require a new query to DynamoDB and extra logic to this function. We want to keep the functions small and concise, so we will create another function very soon to check whether there have been changes in a given image or not.</p>\n<h3 id=\"notifying-should-there-be-vulnerability-changes\" style=\"position:relative;\"><a href=\"#notifying-should-there-be-vulnerability-changes\" aria-label=\"notifying should there be vulnerability changes permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Notifying should there be vulnerability changes</h3>\n<p>Should there be any vulnerability changes to a previously scanned image or any vulnerabilities at all for a new image, we want to be aware of that.</p>\n<p>Since we are already using DynamoDB, we can use DynamoDB Streams to react on write events. If you remember correctly, our previous function <em>always</em> pushes data to DynamoDB, meaning a Stream will always be triggered. Let’s use that in our favor and have a Lambda function react upon it. This new function will be smart enough to check whether something changed or if a new image was scanned. In any case, it will trigger a notification to a Slack channel. If there are no changes at all, the Lambda function then does nothing but happily terminate.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> converter <span class=\"token operator\">=</span> <span class=\"token constant\">AWS</span><span class=\"token punctuation\">.</span>DynamoDB<span class=\"token punctuation\">.</span>Converter<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">notify</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token parameter\">records</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> record <span class=\"token keyword\">of</span> records<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>record<span class=\"token punctuation\">.</span>eventName <span class=\"token operator\">===</span> <span class=\"token string\">\"INSERT\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// code omitted, see github</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>record<span class=\"token punctuation\">.</span>eventName <span class=\"token operator\">===</span> <span class=\"token string\">\"MODIFY\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> potentiallyChangedRecord <span class=\"token operator\">=</span> converter<span class=\"token punctuation\">.</span><span class=\"token function\">unmarshall</span><span class=\"token punctuation\">(</span>\n        record<span class=\"token punctuation\">.</span>dynamodb<span class=\"token punctuation\">.</span>NewImage\n      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">const</span> originalRecord <span class=\"token operator\">=</span> converter<span class=\"token punctuation\">.</span><span class=\"token function\">unmarshall</span><span class=\"token punctuation\">(</span>record<span class=\"token punctuation\">.</span>dynamodb<span class=\"token punctuation\">.</span>OldImage<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>\n        <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>potentiallyChangedRecord<span class=\"token punctuation\">.</span>aws_vulnerabilities<span class=\"token punctuation\">)</span> <span class=\"token operator\">!==</span>\n        <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>originalRecord<span class=\"token punctuation\">.</span>aws_vulnerabilities<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">await</span> axios<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span>process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">SLACK_ENDPOINT</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n          text<span class=\"token operator\">:</span> util<span class=\"token punctuation\">.</span><span class=\"token function\">format</span><span class=\"token punctuation\">(</span>\n            <span class=\"token string\">\"_Vulnerabilities Changed_ for *%s* with SHA *%s* tagged *%s* \\n ```%s```\"</span><span class=\"token punctuation\">,</span>\n            potentiallyChangedRecord<span class=\"token punctuation\">.</span>repository<span class=\"token punctuation\">,</span>\n            potentiallyChangedRecord<span class=\"token punctuation\">.</span>sha_digest<span class=\"token punctuation\">,</span>\n            potentiallyChangedRecord<span class=\"token punctuation\">.</span>tag<span class=\"token punctuation\">,</span>\n            <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>potentiallyChangedRecord<span class=\"token punctuation\">.</span>aws_vulnerabilities<span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>When changes are detected to either a new image or to an existing image, a Slack message notifying there are vulnerabilities for a given image will be sent. </p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 18.243243243243242%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAx0lEQVQY02WPSRaCMBBEuYYyhClMAgJhSBjdufAMbr3/DcoOD9m4+K86qXRX2hDrE1GcIcsr5GWDOC2QZCUCnoJ5HKbt4Wq5p15M9sfpE8br/YFoOqhpI1aoccW0PCBJ216hFgOaVpL2KO4CIQXxKNsDvSBGECawHH8fqjF8n6OTM5pO7ipoSDtMVE8YxoXuFaQOmjfyxt3r1YKybpEWFW60lccTMD+CSwGGxQI4bgibcGhF+6jPs/ZJ2eE5B7rPpJ9p9JtfzxdZt3aRwcRUiQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n        <source\n          srcset=\"/static/0d66df900c4c131f7d86010439f8634e/cbe2e/slack-message.webp 148w,\n/static/0d66df900c4c131f7d86010439f8634e/3084c/slack-message.webp 295w,\n/static/0d66df900c4c131f7d86010439f8634e/5ca24/slack-message.webp 590w,\n/static/0d66df900c4c131f7d86010439f8634e/dad35/slack-message.webp 885w,\n/static/0d66df900c4c131f7d86010439f8634e/2baf0/slack-message.webp 1180w,\n/static/0d66df900c4c131f7d86010439f8634e/fb80a/slack-message.webp 1752w\"\n          sizes=\"(max-width: 590px) 100vw, 590px\"\n          type=\"image/webp\"\n        />\n        <source\n          srcset=\"/static/0d66df900c4c131f7d86010439f8634e/12f09/slack-message.png 148w,\n/static/0d66df900c4c131f7d86010439f8634e/e4a3f/slack-message.png 295w,\n/static/0d66df900c4c131f7d86010439f8634e/fcda8/slack-message.png 590w,\n/static/0d66df900c4c131f7d86010439f8634e/efc66/slack-message.png 885w,\n/static/0d66df900c4c131f7d86010439f8634e/c83ae/slack-message.png 1180w,\n/static/0d66df900c4c131f7d86010439f8634e/05244/slack-message.png 1752w\"\n          sizes=\"(max-width: 590px) 100vw, 590px\"\n          type=\"image/png\"\n        />\n        <img\n          class=\"gatsby-resp-image-image\"\n          src=\"/static/0d66df900c4c131f7d86010439f8634e/fcda8/slack-message.png\"\n          alt=\"Slack\"\n          title=\"Slack Message\"\n          loading=\"lazy\"\n          style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        />\n      </picture>\n    </span></p>\n<p>You can now decide on your own if the vulnerabilities detected are worth investigating. If you go to AWS’s console and inspect the image you were notified of, you can see a list of all the vulnerabilities and their corresponding CVEs</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 32.43243243243243%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABYlAAAWJQFJUiTwAAABC0lEQVQY022QTU7DQAyFczUkFrSNuBRrJPoDJ2HLTUClRZDStJk4zcx4PA2PmUlUBYnFJ79nP3vhrPwuoPYFxDRwOkJwLUFGOtWRlj856vfizLbITs93qO6vQE+3UIsbqOUU9SpHtZgkTY95qLMErfLUO84nITNLs2oxRbXMUT9cw7zMkdHnGkJ7wCjo4g1OFejaIw4fr7BVkfp18Q5WvVZfa9BukzJxL3pWu+AP6OwJWaMtKGBYYH0HK5FzgodqnL/0Iu78A/bdyHfJs3hkZVlis92CmvAPcXDMcC7ieu8Ghr6I/JNhMFtYa8MPWw0XLsfgGA5L1DQX772H1hpElHQ8ZoxBHXx/WFL9BSTfu95KnI3wAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n        <source\n          srcset=\"/static/6df4a77277bbafb20a42a2675d19a7eb/cbe2e/cve.webp 148w,\n/static/6df4a77277bbafb20a42a2675d19a7eb/3084c/cve.webp 295w,\n/static/6df4a77277bbafb20a42a2675d19a7eb/5ca24/cve.webp 590w,\n/static/6df4a77277bbafb20a42a2675d19a7eb/dad35/cve.webp 885w,\n/static/6df4a77277bbafb20a42a2675d19a7eb/2baf0/cve.webp 1180w,\n/static/6df4a77277bbafb20a42a2675d19a7eb/cf4a0/cve.webp 2658w\"\n          sizes=\"(max-width: 590px) 100vw, 590px\"\n          type=\"image/webp\"\n        />\n        <source\n          srcset=\"/static/6df4a77277bbafb20a42a2675d19a7eb/12f09/cve.png 148w,\n/static/6df4a77277bbafb20a42a2675d19a7eb/e4a3f/cve.png 295w,\n/static/6df4a77277bbafb20a42a2675d19a7eb/fcda8/cve.png 590w,\n/static/6df4a77277bbafb20a42a2675d19a7eb/efc66/cve.png 885w,\n/static/6df4a77277bbafb20a42a2675d19a7eb/c83ae/cve.png 1180w,\n/static/6df4a77277bbafb20a42a2675d19a7eb/f6b04/cve.png 2658w\"\n          sizes=\"(max-width: 590px) 100vw, 590px\"\n          type=\"image/png\"\n        />\n        <img\n          class=\"gatsby-resp-image-image\"\n          src=\"/static/6df4a77277bbafb20a42a2675d19a7eb/fcda8/cve.png\"\n          alt=\"Vulnerabilities\"\n          title=\"Vulnerabilities\"\n          loading=\"lazy\"\n          style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        />\n      </picture>\n    </span></p>\n<h2 id=\"putting-all-together\" style=\"position:relative;\"><a href=\"#putting-all-together\" aria-label=\"putting all together permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Putting all together.</h2>\n<p>In this post we have mostly concentrated on the lambda code required to create the components. Apart from the Lambda code, the GitHub repo also contains the Infrastructure Code (Iac) required to create the resources in AWS in order to glue them together. Just follow th instruction smentioned in this repo and you should have your docker images scanner up in minutes.</p>\n<p><asciinema-player src=\"/2020/02/14/ecr-scanning-notifier/aws-ecr-notify.json\"\n  cols=\"180\" rows=\"15\" autoplay=\"true\" loop=\"true\" speed=\"2.0\">\n</asciinema-player></p>\n<p>For the purposes of this post, we used Slack. But the way the Lambda function is built, it could really be any HTTP endpoint, meaning you could even notify your internal systems of potential vulnerability changes in a Docker image.</p>","frontmatter":{"title":"AWS ECR Vulnerabilities Notifier","subtitle":"We only want to be bothered once a new vulnerability is found","date":"2020-02-14","slug":"2020/02/14/ecr-scanning-notifier","language":null,"tags":["docker","vulnerabilities","serverless","aws","terraform","lambda"],"authors":["thales","niek"],"comments":null,"cover":{"publicURL":"/static/98e3ee35420010f375fb3fdfb06a1e4b/cover.jpg"},"coverLink":"https://goo.gl/maps/Pmo2wUq862Fd7Kop9","coverDescription":"Diving in the sea of colors - Glow 2019","imageTw":{"publicURL":"/static/62ec0bf293dfaa0612b4a0c2df572dae/2020-02-14-ecr-scanning-notifier-tw.png"},"imageFb":{"publicURL":"/static/0963834a4a69cd20d940c78cb340f7dc/2020-02-14-ecr-scanning-notifier-fb.png"},"asciinema":true}}},"pageContext":{"slug":"2020/02/14/ecr-scanning-notifier","previous":{"frontmatter":{"title":"Full Stack Fest 2019","slug":"2019/09/12/full-stack-fest-2019","type":"post","tags":["fullstack","frontend","backend","conference"],"authors":["jeroen"]}},"next":{"frontmatter":{"title":"Scaling GitHub Action Runners","slug":"2020/05/25/scaling-selfhosted-action-runners","type":"post","tags":["github","ci","aws","terraform","lambda","typescript"],"authors":["niek"]}}}}}