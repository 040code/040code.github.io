<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet"/><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous"/><style data-href="/styles.131b48b25a50eff60b34.css">code[class*=language-],pre[class*=language-]{color:#ccc;background:none;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.block-comment,.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#999}.token.punctuation{color:#ccc}.token.attr-name,.token.deleted,.token.namespace,.token.tag{color:#e2777a}.token.function-name{color:#6196cc}.token.boolean,.token.function,.token.number{color:#f08d49}.token.class-name,.token.constant,.token.property,.token.symbol{color:#f8c555}.token.atrule,.token.builtin,.token.important,.token.keyword,.token.selector{color:#cc99cd}.token.attr-value,.token.char,.token.regex,.token.string,.token.variable{color:#7ec699}.token.entity,.token.operator,.token.url{color:#67cdcc}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.token.inserted{color:green}</style><meta name="generator" content="Gatsby 2.4.2"/><style type="text/css">
    .anchor {
      float: left;
      padding-right: 4px;
      margin-left: -20px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var offset = element.offsetTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><link rel="preconnect dns-prefetch" href="https://www.google-analytics.com"/><link rel="alternate" type="application/rss+xml" href="/rss.xml"/><style data-styled="hTmxqc lcZENV lfoWPa hPmQYh dANmgz brBAvj hpDnww bWPqAN hwkicN iTdcdb jRHVYT kQWgFX itRnbT jNHeyA hFicPH" data-styled-version="4.3.2">
/* sc-component-id: SideMenu__StyledBurgerMenu-uekpe8-0 */
.hTmxqc .bm-burger-button{position:fixed;width:36px;height:30px;left:36px;top:36px;} .hTmxqc .bm-burger-bars{background:#ffffff;} .hTmxqc .bm-cross-button{height:24px;width:24px;} .hTmxqc .bm-cross{background:#ffffff;} .hTmxqc .bm-menu{background:rgb(0,0,0,0.5);padding:2.5em 1em 0;font-size:1.15em;} .hTmxqc .bm-morph-shape{fill:#373a47;} .hTmxqc .bm-item-list{padding-top:2em;} .hTmxqc .bm-item{display:inline-block;padding:0.5em;} .hTmxqc .bm-overlay{background:rgba(0,0,0,0.3);}
/* sc-component-id: SideMenu__MenuLink-uekpe8-1 */
.lcZENV{position:relative;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:#fff;border:0;margin:0;margin-right:0.5rem;padding-left:20px;padding-right:20px;min-width:42px;z-index:10;}
/* sc-component-id: Footer__FooterWrapper-sc-1oxe0wr-0 */
.hFicPH{text-align:left;padding-top:30px;padding-bottom:50px;background-color:rgba(32,35,42,0.85);color:#ffffff;padding-left:20px;padding-right:20px;margin:3.5em auto 0 0;} .hFicPH nav{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-flow:row wrap;-ms-flex-flow:row wrap;flex-flow:row wrap;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;max-width:900px;margin:0 auto;} .hFicPH nav .footer-col{-webkit-flex:1 auto;-ms-flex:1 auto;flex:1 auto;display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;margin-bottom:1em;padding-right:1em;} .hFicPH a{color:#ffffff;font-weight:bold;} .hFicPH a:hover{color:#e8e8e8;border-bottom:1px dotted #e8e8e8;} .hFicPH .footer-col > p{margin:0;} .hFicPH .footer-title{margin:0 0 1rem;} .hFicPH .footer-item{padding:0.25rem 0;color:#ffffff;} .hFicPH .footer-heart{color:red;} .hFicPH .footer-item-text{padding:0.1rem 0;color:#ffffff;} .hFicPH .footer-header{-webkit-order:1;-ms-flex-order:1;order:1;margin:0 0.25rem;margin-right:0.25rem;padding:0.25rem;} @media (max-width:564px){.hFicPH .footer-col:first-child{width:100%;}}
/* sc-component-id: sc-global-3886539976 */
*{box-sizing:border-box;margin:0;padding:0;} body{font-family:"Lato",sans-serif;color:#222222cc;background-color:#e8e8e8;} img{max-width:100%;height:auto;vertical-align:middle;border:0;} a{-webkit-text-decoration:none;text-decoration:none;color:rgba(34,34,34,0.8);} ul,ol{padding-left:2em;margin:1em 0 0 0;}
/* sc-component-id: Wrapper-aej7i5-0 */
.hwkicN{position:relative;border-radius:3px;width:80%;max-width:770px;border-bottom:1px solid #ebf2f6;word-wrap:break-word;background-color:#fff;margin:0px auto 30px auto;top:30px;padding:50px;box-shadow:0 0 0 0,0 6px 12px rgba(0,0,0,0.1);} @media (max-width:780px){.hwkicN{width:90%;padding:25px;}}
/* sc-component-id: Hero__HeroContainer-sc-1i1rqpz-0 */
.lfoWPa{position:relative;display:table;width:100%;height:340px;overflow:hidden;background-repeat:no-repeat;background-position:center;background-size:cover;}
/* sc-component-id: Hero__TitleContainer-sc-1i1rqpz-1 */
.hPmQYh{display:table-cell;vertical-align:middle;text-align:center;width:100%;}
/* sc-component-id: Hero__HeroTitle-sc-1i1rqpz-3 */
.dANmgz{font-size:3.5rem;margin:10px 60px;color:#fff;text-shadow:2px 2px #222222;font-weight:800;font-family:'Open Sans','Helvetica Neue',Helvetica,Arial,sans-serif;}
/* sc-component-id: Hero__HeroSubtitle-sc-1i1rqpz-4 */
.brBAvj{font-size:1.7rem;margin:10px 60px;color:#fff;text-shadow:2px 2px #222222;font-family:'Open Sans','Helvetica Neue',Helvetica,Arial,sans-serif;}
/* sc-component-id: Hero__DateAndAuthor-sc-1i1rqpz-5 */
.hpDnww{font-weight:500;font-size:1.2rem;color:#fff;text-shadow:2px 2px #222222;}
/* sc-component-id: Hero__AuthorLink-sc-1i1rqpz-6 */
.bWPqAN{margin-left:0.3rem;font-weight:500;font-size:1.2rem;color:#fff;text-shadow:2px 2px #222222;} .bWPqAN:hover{border-bottom:1px dotted #787676;} .bWPqAN:before{content:'@';}
/* sc-component-id: TagList__ListContainer-sc-1uj42o2-0 */
.kQWgFX{display:inline;margin:0 0.5rem 0 0;color:#787676;}
/* sc-component-id: TagList__TagListItem-sc-1uj42o2-1 */
.itRnbT{margin-left:0.3rem;display:inline-block;min-width:10px;padding:3px 7px;font-size:12px;font-weight:700;line-height:1;color:#fff;text-align:center;white-space:nowrap;vertical-align:middle;background-color:#777;border-radius:10px;} .itRnbT:hover{border-bottom:1px dotted #787676;}
/* sc-component-id: ContentHeader__Header-sc-1uw779c-0 */
.jRHVYT{margin-bottom:2rem;color:#787676;}
/* sc-component-id: Content__ContentBody-sc-1jppj8x-0 */
.jNHeyA{line-height:1.6;} .jNHeyA > *:first-child{padding-top:0;margin-top:0;} .jNHeyA > h1{margin-top:3rem;font-size:2em;} .jNHeyA > h2{margin-top:3rem;font-size:1.5em;} .jNHeyA > h3{padding-top:3rem;font-size:1.17em;} .jNHeyA > p{margin:1em 0 0 0;} .jNHeyA a{border-bottom:1px dotted rgba(162,162,162,0.8);} .jNHeyA a:hover{border-bottom-style:solid;} .jNHeyA a.anchor,.jNHeyA a.gatsby-resp-image-link{border:none;} .jNHeyA > blockquote{box-sizing:border-box;margin:1.75em 0 1.75em -2.2em;padding:0 0 0 1.75em;border-left:0.4em solid rgba(32,35,42,0.85);} .jNHeyA > blockquote p{margin:0.8em 0;font-style:italic;} .jNHeyA .gatsby-highlight{border-radius:5px;font-size:15px;line-height:1.7;background:#2d2d2d;color:#ffffff;border-radius:10px;overflow:auto;tab-size:1.5em;margin:1.5em 0em 1.5em 0;font-size:0.7em;} .jNHeyA .gatsby-highlight > pre{border:0;margin:0;padding:1;} .jNHeyA .gatsby-highlight-code-line{background-color:#022a4b;display:block;margin-right:-1em;margin-left:-1em;padding-right:1em;padding-left:0.75em;border-left:0.25em solid #ffa7c4;} .jNHeyA p > code.language-text,.jNHeyA li > code.language-text{background:rgba(255,229,100,0.2);color:#222222cc;padding:0 3px;font-size:0.94em;border-radius:0.3rem;} .jNHeyA table{margin-top:1em;border-collapse:collapse;border-radius:0.5em;overflow:hidden;} .jNHeyA table th,.jNHeyA table td{padding:0.5em;background:#e8e8e8;border-bottom:2px solid white;} .jNHeyA:not(pre) a code[class*='language-']{color:#222222cc;background-color:rgba(255,229,100,0.2);}
/* sc-component-id: Article__ArticleWrapper-sc-1nyoqfc-0 */
.iTdcdb{padding:0 30px 30px;} @media only screen and (max-width:500px){.iTdcdb{padding:0;}}</style><title data-react-helmet="true">Docker Multi Stage Builds | 040code</title><link data-react-helmet="true" rel="canonical" href="https://040code.github.io/2017/05/07/docker-multi-stage-builds"/><meta data-react-helmet="true" name="description" content="The problemBuilding an application requires typically multiple steps. First compiling the application, next testing it and finally shipping…"/><meta data-react-helmet="true" property="og:url" content="https://040code.github.io/2017/05/07/docker-multi-stage-builds"/><meta data-react-helmet="true" property="og:type" content="article"/><meta data-react-helmet="true" property="og:title" content="Docker Multi Stage Builds | 040code"/><meta data-react-helmet="true" property="og:description" content="The problemBuilding an application requires typically multiple steps. First compiling the application, next testing it and finally shipping…"/><meta data-react-helmet="true" property="og:image" content="https://040code.github.io/static/2017-05-07-docker-multi-stage-builds-fb-51a31d569efb9835b0dbe7cf6cc50a09.png"/><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"/><meta data-react-helmet="true" name="twitter:creator" content="niekos77"/><meta data-react-helmet="true" name="twitter:title" content="Docker Multi Stage Builds | 040code"/><meta data-react-helmet="true" name="twitter:description" content="The problemBuilding an application requires typically multiple steps. First compiling the application, next testing it and finally shipping…"/><meta data-react-helmet="true" name="twitter:image" content="https://040code.github.io/static/2017-05-07-docker-multi-stage-builds-tw-3ae3a359585ebd85ae966ae67d33d986.png"/><link rel="shortcut icon" href="/icons/icon-48x48.png?v=008654519ce705ac7bc44303a9014606"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#222222"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=008654519ce705ac7bc44303a9014606"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=008654519ce705ac7bc44303a9014606"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=008654519ce705ac7bc44303a9014606"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=008654519ce705ac7bc44303a9014606"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=008654519ce705ac7bc44303a9014606"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=008654519ce705ac7bc44303a9014606"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=008654519ce705ac7bc44303a9014606"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=008654519ce705ac7bc44303a9014606"/><link as="script" rel="preload" href="/component---src-templates-blog-post-js-6e52eeb3246ca14c1467.js"/><link as="script" rel="preload" href="/app-84e701222f5b7186a9a9.js"/><link as="script" rel="preload" href="/3-4d73c1baf9953aba24ed.js"/><link as="script" rel="preload" href="/1-71e2f819df9369c863b9.js"/><link as="script" rel="preload" href="/styles-13d2ee47eddc5325ccbc.js"/><link as="script" rel="preload" href="/webpack-runtime-e626ca19e89ff477e290.js"/><link as="fetch" rel="preload" href="/static/d/891/path---2017-05-07-docker-multi-stage-builds-aa-6-2cb-6uv4rPQ2EyjRLROhw3G8YfOhRc.json" crossorigin="use-credentials"/></head><body><noscript>This site runs best with JavaScript enabled.</noscript><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group"><div class="SideMenu__StyledBurgerMenu-uekpe8-0 hTmxqc"><div><div class="bm-overlay" style="position:fixed;z-index:1000;width:100%;height:100%;background:rgba(0, 0, 0, 0.3);opacity:0;-moz-transform:translate3d(100%, 0, 0);-ms-transform:translate3d(100%, 0, 0);-o-transform:translate3d(100%, 0, 0);-webkit-transform:translate3d(100%, 0, 0);transform:translate3d(100%, 0, 0);transition:opacity 0.3s, transform 0s 0.3s"></div><div id="" class="bm-menu-wrap" style="position:fixed;right:inherit;z-index:1100;width:300px;height:100%;-moz-transform:translate3d(-100%, 0, 0);-ms-transform:translate3d(-100%, 0, 0);-o-transform:translate3d(-100%, 0, 0);-webkit-transform:translate3d(-100%, 0, 0);transform:translate3d(-100%, 0, 0);transition:all 0.5s"><div class="bm-menu" style="height:100%;box-sizing:border-box;overflow:auto"><nav class="bm-item-list" style="height:100%"><a class="bm-item SideMenu__MenuLink-uekpe8-1 lcZENV" style="display:block" tabindex="-1" href="/">🏡 040 blog</a><a class="bm-item SideMenu__MenuLink-uekpe8-1 lcZENV" style="display:block" tabindex="-1" href="/about">About</a><a class="bm-item SideMenu__MenuLink-uekpe8-1 lcZENV" style="display:block" tabindex="-1" href="/authors/niek">Niek Palm</a><a class="bm-item SideMenu__MenuLink-uekpe8-1 lcZENV" style="display:block" tabindex="-1" href="/authors/maarten">Maarten Metz</a><a class="bm-item SideMenu__MenuLink-uekpe8-1 lcZENV" style="display:block" tabindex="-1" href="/authors/jeroen">Jeroen Knoops</a><a class="bm-item SideMenu__MenuLink-uekpe8-1 lcZENV" style="display:block" tabindex="-1" href="/authors/stefan">Stefan van den Oord</a></nav></div><div><div class="bm-cross-button" style="position:absolute;width:24px;height:24px;right:8px;top:8px"><span style="position:absolute;top:6px;right:14px"><span class="bm-cross" style="position:absolute;width:3px;height:14px;transform:rotate(45deg)"></span><span class="bm-cross" style="position:absolute;width:3px;height:14px;transform:rotate(-45deg)"></span></span><button style="position:absolute;left:0;top:0;width:100%;height:100%;margin:0;padding:0;border:none;font-size:0;background:transparent;cursor:pointer" tabindex="-1">Close Menu</button></div></div></div><div><div class="bm-burger-button" style="z-index:1000"><span><span class="bm-burger-bars" style="position:absolute;height:20%;left:0;right:0;top:0%;opacity:1"></span><span class="bm-burger-bars" style="position:absolute;height:20%;left:0;right:0;top:40%;opacity:1"></span><span class="bm-burger-bars" style="position:absolute;height:20%;left:0;right:0;top:80%;opacity:1"></span></span><button style="position:absolute;left:0;top:0;width:100%;height:100%;margin:0;padding:0;border:none;font-size:0;background:transparent;cursor:pointer">Open Menu</button></div></div></div></div><div style="margin:0 0"><div style="background-image:url(&quot;/static/containers-strijp-s-865e0fd570fd27aef20a38112634d3f2.png&quot;)" class="Hero__HeroContainer-sc-1i1rqpz-0 lfoWPa"><div class="Hero__TitleContainer-sc-1i1rqpz-1 hPmQYh"><h1 class="Hero__HeroTitle-sc-1i1rqpz-3 dANmgz">Docker Multi Stage Builds</h1><h2 class="Hero__HeroSubtitle-sc-1i1rqpz-4 brBAvj">Building and shipping in one Docker build</h2><span class="Hero__DateAndAuthor-sc-1i1rqpz-5 hpDnww">by:<!-- --> <a class="Hero__AuthorLink-sc-1i1rqpz-6 bWPqAN" href="/authors/niek">niek</a>  on <!-- -->2017-05-07</span></div></div><main role="main" class="Wrapper-aej7i5-0 hwkicN"><article class="Article__ArticleWrapper-sc-1nyoqfc-0 iTdcdb"><section><header class="ContentHeader__Header-sc-1uw779c-0 jRHVYT"><div class="TagList__ListContainer-sc-1uj42o2-0 kQWgFX"><a class="w3-round-size TagList__TagListItem-sc-1uj42o2-1 itRnbT" href="/tags/docker">docker</a></div></header><div class="Content__ContentBody-sc-1jppj8x-0 jNHeyA"><h1 id="the-problem"><a href="#the-problem" aria-label="the problem permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>The problem</h1>
<p>Building an application requires typically multiple steps. First compiling the application, next testing it and finally shipping the artifact in a Docker image for execution. All these steps can be combined in one <code class="language-text">Dockerfile</code>, but typically you end up with a Docker image that contains all kinds of tools that are not necessary for running the application.</p>
<p>We could try to get rid of all unneeded files in the image after build, but a more useful approach is to separate Docker images for building and running the application. However, this approach requires two separate Dockerfiles that needs to be maintained.</p>
<p>Let’s have a look on a <a href="https://github.com/040code/blog_docker-mulit-stage-build.git">example</a> for a simple Java micro service. The micro services require the JDK and Gradle to build. The JDK needs to be installed before the build and Gradle will be download by the build itself. We can build the micro service in the following way.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">git clone https://github.com/040code/blog_docker-mulit-stage-build.git
cd notes-service
docker run -it --rm -v $(pwd):/build -w /build openjdk:8u121-jdk-alpine ./gradlew build</code></pre></div>
<p>Now the artifact is available, we can create a Docker runtime image. The application only needs the Java Runtime (JRE) to run. We create a <code class="language-text">Dockerfile</code> based JRE alpine image and add our application.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text"># file: Dockerfile (git checkout step-00)
FROM openjdk:8u121-jre-alpine
COPY build/libs/notes-service.jar /app/notes-service.jar

EXPOSE 8080
CMD java -jar /app/notes-service.jar</code></pre></div>
<p>Next, we build the production image as follows:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">docker build -t notes-service:00 .</code></pre></div>
<p>Now we have created a clean Docker images that only containes the needed libraries to run the application. But would it not be nice if we can do this more straightforward? For example, in one Docker build.</p>
<h1 id="moving-on-to-a-multi-stage-build"><a href="#moving-on-to-a-multi-stage-build" aria-label="moving on to a multi stage build permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Moving on to a multi stage build</h1>
<p>Docker 17.05.x brings a new feature; it is now possible to define a <a href="https://docs.docker.com/engine/userguide/eng-image/multistage-build/">multi stage builds</a> in one Dockerfile. The Dockerfile can contain multiple FROM lines and each stage starts with a new FROM line and a fresh context. You can copy artifacts from stage to stage.</p>
<a href="#">
    <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;">
    <span class="gatsby-resp-image-background-image" style="padding-bottom: 55.758880516684606%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAACsUlEQVQozz2STU8TURiFZ+fanUt/gRs3LkyMP8KVv0DDwoRoWKEoG6JWNGqEmKBEFBGISqEBi1aQAgGE8jH9LoVpO51OmbYUWvpBH99OI4s3997c+557znmPkiymUE0Nv7mPdpgkmkugZlr73byUnP1yv19Isq7vEbU0qg2D8qnByVllzvZKTJpcoQiTgTCL+zFmwhGpKMuJOD8iMb77I2ymmx+kCFlJ9JJBnSw1qToH9lqup6k0WqBKvpJmr2iQLGXI1nKE8waRXIpEUSeY1YjlE9Jk0Gg2VhMYBwHMQhQ9GyBpqmQLMU4F2GYozBUtvc3Siou1DTeumc8EQosclfY4PtEEJENNHpWEQZONZqi8HXzBh899jE0M2mv/u142w0tUMVsM46ktRr4O8Gm8Xx4NMOkeZtozinkYBgoC2pRlSkOWTC7Cz/nveBaczC9N8dPrxLfmxpoZo1zThWEGJSv0d8LLuD2zTDinGB7+gueXh0BQZXt7A1X1kbF2bd+aDErSWK7rHFdTMpg0hZMosciC7WFFPlYa5MSXMM+7J3jc+YeHd708aJ+n7eYYVy/c59K5Dvod48LQEIZ75I4TFCstsFLVtD93fn2Db31UlFgo/tA0vY+u0feknZ77C3R3+HjctUXHbTdXzj/gonKPZ13DIv+Aw3KKo4qOkYtTaqSJ7/q5dX2Qd44hxobaKJQ0GYq+infuPat/f/HpwxKvHIu8fuqj846bG5cd9NwdIRT0236eCoOGFOTtfTOL6vJHFid7cE+/FNkiuS4XNZHdzNOpTLUo052dc+J0feP3HxeB+AKrW7NsBbzsSAK2g168K9OE42sCnidhbLK+MSV2BO3BKa2Ep23DK5L4ZkgNK4h1FBNpITRdJWUGSB8E7bNhhQRkB6u4KwAZexhVseN/sP8Bc58C1cyyjvgAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;"></span>
    <picture>
        <source srcset="/static/9f19fe775a09640a4724e3e5fd31b87b/cc182/docker-multi-stages-build.webp 148w,
/static/9f19fe775a09640a4724e3e5fd31b87b/f7e40/docker-multi-stages-build.webp 295w,
/static/9f19fe775a09640a4724e3e5fd31b87b/1a2f4/docker-multi-stages-build.webp 590w,
/static/9f19fe775a09640a4724e3e5fd31b87b/4837b/docker-multi-stages-build.webp 885w,
/static/9f19fe775a09640a4724e3e5fd31b87b/2f819/docker-multi-stages-build.webp 1180w,
/static/9f19fe775a09640a4724e3e5fd31b87b/799b2/docker-multi-stages-build.webp 1770w,
/static/9f19fe775a09640a4724e3e5fd31b87b/2cc55/docker-multi-stages-build.webp 1858w" sizes="(max-width: 590px) 100vw, 590px" type="image/webp">
        <source srcset="/static/9f19fe775a09640a4724e3e5fd31b87b/cf440/docker-multi-stages-build.png 148w,
/static/9f19fe775a09640a4724e3e5fd31b87b/d2d38/docker-multi-stages-build.png 295w,
/static/9f19fe775a09640a4724e3e5fd31b87b/b9e4f/docker-multi-stages-build.png 590w,
/static/9f19fe775a09640a4724e3e5fd31b87b/f9b6a/docker-multi-stages-build.png 885w,
/static/9f19fe775a09640a4724e3e5fd31b87b/2d849/docker-multi-stages-build.png 1180w,
/static/9f19fe775a09640a4724e3e5fd31b87b/bbefa/docker-multi-stages-build.png 1770w,
/static/9f19fe775a09640a4724e3e5fd31b87b/bb319/docker-multi-stages-build.png 1858w" sizes="(max-width: 590px) 100vw, 590px" type="image/png">
        <img class="gatsby-resp-image-image" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;" src="/static/9f19fe775a09640a4724e3e5fd31b87b/b9e4f/docker-multi-stages-build.png" alt="docker-multi-stages-build" title>
      </picture>
  </span>
</a>
<p>Now it is time to have a second look on the same example. Instead of passing the build arguments and mounting our sources, we will build our software using a single Dockerfile.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text"># file: Dockerfile (git checkout step-01)
FROM openjdk:8u121-jdk-alpine AS build

WORKDIR /build-env
ADD . /build-env
RUN ./gradlew build

CMD java -jar /build-env/build/notes-service.jar</code></pre></div>
<p>And build it:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">docker build -t notes-service:01 .</code></pre></div>
<p>Nothing new here, we are now able to build our software in a container and ship an image, but the image contains all kinds of build stuff that we do not want in a runtime image. So, the next step is to solve this problem by getting rid of all the unwanted build tools.</p>
<p>We update the <code class="language-text">Dockerfile</code> and make a few modifications.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text"># file: Dockerfile (git checkout step-02)
FROM openjdk:8u121-jdk-alpine AS build                                               # (1)

WORKDIR /build-env
ADD . /build-env
RUN ./gradlew build

FROM openjdk:8u121-jre-alpine                                                        # (2)
COPY --from=build /build-env/build/libs/notes-service.jar /app/notes-service.jar     # (3)

EXPOSE 8080
CMD java -jar /app/notes-service.jar</code></pre></div>
<p>In the <code class="language-text">Dockerfile</code> above we marked the first stage (1) as <em>build</em> to refer later, if not specifying a name you can refer to the stage as 0. Next (2), we add the second stage which specifies the base image that we need to run our application. Finally (3), we copy the results from the build stage to the image for executing.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">docker build -t notes-service:02 .</code></pre></div>
<p>And now we can run via the following docker run command.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">docker run -it --rm -p 8080 notes-service:2</code></pre></div>
<p>Inspection of the tree images build will show that version 0 and 2 are equal in size, version 1 that contains all the build files and the JDK is almost three times bigger.</p>
<h1 id="conclusion"><a href="#conclusion" aria-label="conclusion permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Conclusion</h1>
<p>Docker’s new multi layer build feature can be quite useful when build pipeline without parallel builds will suite your needs. In that case, you can reduce your build to a single image. For projects that requires a more complex multi stage build, including parallel builds, this new Docker feature will not provide an added value.</p></div></section></article></main></div><footer class="Footer__FooterWrapper-sc-1oxe0wr-0 hFicPH"><nav><div class="footer-col"><h5 class="footer-title">040 code © 2019</h5><span class="footer-item">Build with <i></i><a class="footer-link" href="https://www.gatsbyjs.org/">Gatsby</a></span></div><div class="footer-col"><h5 class="footer-title">Blog</h5><span class="footer-item"><a class="footer-link" href="/">home</a></span><span class="footer-item"><a class="footer-link" href="/about">about</a></span></div><div class="footer-col"><h5 class="footer-title">Source</h5><span class="footer-item"><i></i><a class="footer-link" href="https://github.com/040code/">Github</a></span></div></nav></footer></div></div><script>
  
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-97020149-1', 'auto', {});
      
      
      
      }
      </script><script id="gatsby-script-loader">/*<![CDATA[*/window.page={"componentChunkName":"component---src-templates-blog-post-js","jsonName":"2017-05-07-docker-multi-stage-builds-aa6","path":"/2017/05/07/docker-multi-stage-builds"};window.dataPath="891/path---2017-05-07-docker-multi-stage-builds-aa-6-2cb-6uv4rPQ2EyjRLROhw3G8YfOhRc";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-84e701222f5b7186a9a9.js"],"component---node-modules-gatsby-plugin-offline-app-shell-js":["/component---node-modules-gatsby-plugin-offline-app-shell-js-e7d83f3aca32b19d7eca.js"],"component---src-templates-blog-list-template-js":["/component---src-templates-blog-list-template-js-4244168454bdd7b6ce63.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-6e52eeb3246ca14c1467.js"],"component---src-templates-page-js":["/component---src-templates-page-js-abf7edb15f3db38b2f92.js"],"component---src-templates-tags-js":["/component---src-templates-tags-js-246b5f3ef84605384230.js"],"component---src-templates-authors-js":["/component---src-templates-authors-js-92815d20e671579c92f3.js"],"component---src-pages-404-js":["/component---src-pages-404-js-11c3986ca33f38cfb2b8.js"],"pages-manifest":["/pages-manifest-f13fa6f908d18ebf6fe8.js"]};/*]]>*/</script><script src="/webpack-runtime-e626ca19e89ff477e290.js" async=""></script><script src="/styles-13d2ee47eddc5325ccbc.js" async=""></script><script src="/1-71e2f819df9369c863b9.js" async=""></script><script src="/3-4d73c1baf9953aba24ed.js" async=""></script><script src="/app-84e701222f5b7186a9a9.js" async=""></script><script src="/component---src-templates-blog-post-js-6e52eeb3246ca14c1467.js" async=""></script></body></html>