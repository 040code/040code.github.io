<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet"/><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous"/><style data-href="/styles.131b48b25a50eff60b34.css">code[class*=language-],pre[class*=language-]{color:#ccc;background:none;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.block-comment,.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#999}.token.punctuation{color:#ccc}.token.attr-name,.token.deleted,.token.namespace,.token.tag{color:#e2777a}.token.function-name{color:#6196cc}.token.boolean,.token.function,.token.number{color:#f08d49}.token.class-name,.token.constant,.token.property,.token.symbol{color:#f8c555}.token.atrule,.token.builtin,.token.important,.token.keyword,.token.selector{color:#cc99cd}.token.attr-value,.token.char,.token.regex,.token.string,.token.variable{color:#7ec699}.token.entity,.token.operator,.token.url{color:#67cdcc}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.token.inserted{color:green}</style><meta name="generator" content="Gatsby 2.22.9"/><style type="text/css">
    .anchor.before {
      position: absolute;
      top: 0;
      left: 0;
      transform: translateX(-100%);
      padding-right: 4px;
    }
    .anchor.after {
      display: inline-block;
      padding-left: 4px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><link rel="preconnect dns-prefetch" href="https://www.google-analytics.com"/><link rel="alternate" type="application/rss+xml" href="/rss.xml"/><style data-styled="hTmxqc lcZENV lfoWPa hPmQYh dANmgz brBAvj hpDnww bWPqAN gEMFDS eyJpws cmRrYK hwkicN iTdcdb jRHVYT kQWgFX itRnbT jNHeyA hFicPH" data-styled-version="4.3.2">
/* sc-component-id: SideMenu__StyledBurgerMenu-uekpe8-0 */
.hTmxqc .bm-burger-button{position:fixed;width:36px;height:30px;left:36px;top:36px;} .hTmxqc .bm-burger-bars{background:#ffffff;} .hTmxqc .bm-cross-button{height:24px;width:24px;} .hTmxqc .bm-cross{background:#ffffff;} .hTmxqc .bm-menu{background:rgb(0,0,0,0.5);padding:2.5em 1em 0;font-size:1.15em;} .hTmxqc .bm-morph-shape{fill:#373a47;} .hTmxqc .bm-item-list{padding-top:2em;} .hTmxqc .bm-item{display:inline-block;padding:0.5em;} .hTmxqc .bm-overlay{background:rgba(0,0,0,0.3);}
/* sc-component-id: SideMenu__MenuLink-uekpe8-1 */
.lcZENV{position:relative;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:#fff;border:0;margin:0;margin-right:0.5rem;padding-left:20px;padding-right:20px;min-width:42px;z-index:10;}
/* sc-component-id: Footer__FooterWrapper-sc-1oxe0wr-0 */
.hFicPH{text-align:left;padding-top:30px;padding-bottom:50px;background-color:rgba(32,35,42,0.85);color:#ffffff;padding-left:20px;padding-right:20px;margin:3.5em auto 0 0;} .hFicPH nav{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-flow:row wrap;-ms-flex-flow:row wrap;flex-flow:row wrap;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;max-width:900px;margin:0 auto;} .hFicPH nav .footer-col{-webkit-flex:1 auto;-ms-flex:1 auto;flex:1 auto;display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;margin-bottom:1em;padding-right:1em;} .hFicPH a{color:#ffffff;font-weight:bold;} .hFicPH a:hover{color:#e8e8e8;border-bottom:1px dotted #e8e8e8;} .hFicPH .footer-col > p{margin:0;} .hFicPH .footer-title{margin:0 0 1rem;} .hFicPH .footer-item{padding:0.25rem 0;color:#ffffff;} .hFicPH .footer-heart{color:red;} .hFicPH .footer-item-text{padding:0.1rem 0;color:#ffffff;} .hFicPH .footer-header{-webkit-order:1;-ms-flex-order:1;order:1;margin:0 0.25rem;margin-right:0.25rem;padding:0.25rem;} @media (max-width:564px){.hFicPH .footer-col:first-child{width:100%;}}
/* sc-component-id: sc-global-693195232 */
*{box-sizing:border-box;margin:0;padding:0;} body{font-family:"Lato",sans-serif;color:#222222cc;background-color:#e8e8e8;} img{max-width:100%;height:auto;vertical-align:middle;border:0;} a{-webkit-text-decoration:none;text-decoration:none;color:#0366d6;} ul,ol{padding-left:2em;margin:1em 0 0 0;}
/* sc-component-id: Wrapper-aej7i5-0 */
.hwkicN{position:relative;border-radius:3px;width:80%;max-width:770px;border-bottom:1px solid #ebf2f6;word-wrap:break-word;background-color:#fff;margin:0px auto 30px auto;top:30px;padding:50px;box-shadow:0 0 0 0,0 6px 12px rgba(0,0,0,0.1);} @media (max-width:780px){.hwkicN{width:90%;padding:25px;}}
/* sc-component-id: TagList__ListContainer-sc-1uj42o2-0 */
.kQWgFX{display:inline;margin:0 0.5rem 0 0;color:#787676;}
/* sc-component-id: TagList__TagListItem-sc-1uj42o2-1 */
.itRnbT{margin-left:0.3rem;display:inline-block;min-width:10px;padding:3px 7px;font-size:12px;font-weight:700;line-height:1;color:#fff;text-align:center;white-space:nowrap;vertical-align:middle;background-color:#777;border-radius:10px;} .itRnbT:hover{border-bottom:1px dotted #787676;}
/* sc-component-id: ContentHeader__Header-sc-1uw779c-0 */
.jRHVYT{margin-bottom:2rem;color:#787676;}
/* sc-component-id: Content__ContentBody-sc-1jppj8x-0 */
.jNHeyA{line-height:1.6;} .jNHeyA > *:first-child{padding-top:0;margin-top:0;} .jNHeyA > h1{margin-top:3rem;font-size:2em;} .jNHeyA > h2{margin-top:3rem;font-size:1.5em;} .jNHeyA > h3{padding-top:3rem;font-size:1.17em;} .jNHeyA > p{margin:1em 0 0 0;} .jNHeyA a{border-bottom:1px dotted rgba(162,162,162,0.8);} .jNHeyA a:hover{border-bottom-style:solid;} .jNHeyA a.anchor,.jNHeyA a.gatsby-resp-image-link{border:none;} .jNHeyA > blockquote{box-sizing:border-box;margin:1.75em 0 1.75em -2.2em;padding:0 0 0 1.75em;border-left:0.4em solid rgba(32,35,42,0.85);} .jNHeyA > blockquote p{margin:0.8em 0;font-style:italic;} .jNHeyA .gatsby-highlight{border-radius:5px;font-size:15px;line-height:1.7;background:#2d2d2d;color:#ffffff;border-radius:10px;overflow:auto;tab-size:1.5em;margin:1.5em 0em 1.5em 0;font-size:0.7em;} .jNHeyA .gatsby-highlight > pre{border:0;margin:0;padding:1;} .jNHeyA .gatsby-highlight-code-line{background-color:#022a4b;display:block;margin-right:-1em;margin-left:-1em;padding-right:1em;padding-left:0.75em;border-left:0.25em solid #ffa7c4;} .jNHeyA p > code.language-text,.jNHeyA li > code.language-text{background:rgba(255,229,100,0.2);color:#222222cc;padding:0 3px;font-size:0.94em;border-radius:0.3rem;} .jNHeyA table{margin-top:1em;border-collapse:collapse;border-radius:0.5em;overflow:hidden;} .jNHeyA table th,.jNHeyA table td{padding:0.5em;background:#e8e8e8;border-bottom:2px solid white;} .jNHeyA:not(pre) a code[class*='language-']{color:#222222cc;background-color:rgba(255,229,100,0.2);}
/* sc-component-id: Hero__HeroContainer-sc-1i1rqpz-0 */
.lfoWPa{position:relative;display:table;width:100%;height:340px;overflow:hidden;background-repeat:no-repeat;background-position:center;background-size:cover;}
/* sc-component-id: Hero__TitleContainer-sc-1i1rqpz-1 */
.hPmQYh{display:table-cell;vertical-align:middle;text-align:center;width:100%;}
/* sc-component-id: Hero__LocationContainer-sc-1i1rqpz-2 */
.gEMFDS{display:table-footer-group;vertical-align:center;text-align:right;width:100%;}
/* sc-component-id: Hero__HeroTitle-sc-1i1rqpz-3 */
.dANmgz{font-size:3.5rem;margin:10px 60px;color:#fff;text-shadow:2px 2px #222222;font-weight:800;font-family:'Open Sans','Helvetica Neue',Helvetica,Arial,sans-serif;}
/* sc-component-id: Hero__HeroSubtitle-sc-1i1rqpz-4 */
.brBAvj{font-size:1.7rem;margin:10px 60px;color:#fff;text-shadow:2px 2px #222222;font-family:'Open Sans','Helvetica Neue',Helvetica,Arial,sans-serif;}
/* sc-component-id: Hero__DateAndAuthor-sc-1i1rqpz-5 */
.hpDnww{font-weight:500;font-size:1.2rem;color:#fff;text-shadow:2px 2px #222222;}
/* sc-component-id: Hero__AuthorLink-sc-1i1rqpz-6 */
.bWPqAN{margin-left:0.3rem;font-weight:500;font-size:1.2rem;color:#fff;text-shadow:2px 2px #222222;} .bWPqAN:hover{border-bottom:1px dotted #787676;} .bWPqAN:before{content:'@';}
/* sc-component-id: Hero__LocationLink-sc-1i1rqpz-7 */
.cmRrYK{margin-right:0.7rem;font-size:0.9rem;color:#fff;text-shadow:2px 2px #222222;font-size:1rem;font-family:'Open Sans','Helvetica Neue',Helvetica,Arial,sans-serif;font-style:italic;} .cmRrYK:hover{border-bottom:1px dotted #787676;}
/* sc-component-id: Hero__LocationMarker-sc-1i1rqpz-8 */
.eyJpws{margin-right:0.4rem;font-size:0.75rem;color:#fff;text-shadow:2px 2px #222222;font-family:'Open Sans','Helvetica Neue',Helvetica,Arial,sans-serif;}
/* sc-component-id: Article__ArticleWrapper-sc-1nyoqfc-0 */
.iTdcdb{padding:0 30px 30px;} @media only screen and (max-width:500px){.iTdcdb{padding:0;}}</style><title data-react-helmet="true">Scaling GitHub Action Runners | 040code</title><link data-react-helmet="true" rel="canonical" href="https://040code.github.io/2020/05/25/scaling-selfhosted-action-runners"/><meta data-react-helmet="true" name="description" content="This post explains how to run GitHub actions on self-hosted scalable runners on AWS spot instances. Introduction Last year GitHub released…"/><meta data-react-helmet="true" property="og:url" content="https://040code.github.io/2020/05/25/scaling-selfhosted-action-runners"/><meta data-react-helmet="true" property="og:type" content="article"/><meta data-react-helmet="true" property="og:title" content="Scaling GitHub Action Runners | 040code"/><meta data-react-helmet="true" property="og:description" content="This post explains how to run GitHub actions on self-hosted scalable runners on AWS spot instances. Introduction Last year GitHub released…"/><meta data-react-helmet="true" property="og:image" content="https://040code.github.io/static/df5cd3c20b042e9ceae510cb6057807f/2020-05-25-scaling-selfhosted-action-runners-fb.png"/><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"/><meta data-react-helmet="true" name="twitter:creator" content="niekos77"/><meta data-react-helmet="true" name="twitter:title" content="Scaling GitHub Action Runners | 040code"/><meta data-react-helmet="true" name="twitter:description" content="This post explains how to run GitHub actions on self-hosted scalable runners on AWS spot instances. Introduction Last year GitHub released…"/><meta data-react-helmet="true" name="twitter:image" content="https://040code.github.io/static/7f1bc45382b90f588600ee7328f2ab34/2020-05-25-scaling-selfhosted-action-runners-tw.png"/><link rel="icon" href="/favicon-32x32.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#222222"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link as="script" rel="preload" href="/6dae301c9709e8c5899acc3516b7dd8f43382179-3a8e428404b3ed412f4e.js"/><link as="script" rel="preload" href="/framework-d9760d5f29a556096c12.js"/><link as="script" rel="preload" href="/app-2e259087cf0f884cb471.js"/><link as="script" rel="preload" href="/component---src-templates-blog-post-js-8ba9e14f49a230982ddd.js"/><link as="script" rel="preload" href="/6b89ea6005f9c555c01b9da0decab7e9d6623b3d-acf9dd694899c0988cea.js"/><link as="script" rel="preload" href="/777cf710-f81af635b8297329d6d2.js"/><link as="script" rel="preload" href="/styles-503b3015a8b38c118cb7.js"/><link as="script" rel="preload" href="/webpack-runtime-88371d95a4ecc8f25203.js"/><link as="fetch" rel="preload" href="/page-data/2020/05/25/scaling-selfhosted-action-runners/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><noscript>This site runs best with JavaScript enabled.</noscript><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="SideMenu__StyledBurgerMenu-uekpe8-0 hTmxqc"><div><div class="bm-overlay" style="position:fixed;z-index:1000;width:100%;height:100%;background:rgba(0, 0, 0, 0.3);opacity:0;-moz-transform:translate3d(100%, 0, 0);-ms-transform:translate3d(100%, 0, 0);-o-transform:translate3d(100%, 0, 0);-webkit-transform:translate3d(100%, 0, 0);transform:translate3d(100%, 0, 0);transition:opacity 0.3s, transform 0s 0.3s"></div><div id="" class="bm-menu-wrap" style="position:fixed;right:inherit;z-index:1100;width:300px;height:100%;-moz-transform:translate3d(-100%, 0, 0);-ms-transform:translate3d(-100%, 0, 0);-o-transform:translate3d(-100%, 0, 0);-webkit-transform:translate3d(-100%, 0, 0);transform:translate3d(-100%, 0, 0);transition:all 0.5s"><div class="bm-menu" style="height:100%;box-sizing:border-box;overflow:auto"><nav class="bm-item-list" style="height:100%"><a class="bm-item SideMenu__MenuLink-uekpe8-1 lcZENV" style="display:block" tabindex="-1" href="/">🏡 040 blog</a><a class="bm-item SideMenu__MenuLink-uekpe8-1 lcZENV" style="display:block" tabindex="-1" href="/about">About</a><a class="bm-item SideMenu__MenuLink-uekpe8-1 lcZENV" style="display:block" tabindex="-1" href="/authors/niek">Niek Palm</a><a class="bm-item SideMenu__MenuLink-uekpe8-1 lcZENV" style="display:block" tabindex="-1" href="/authors/maarten">Maarten Metz</a><a class="bm-item SideMenu__MenuLink-uekpe8-1 lcZENV" style="display:block" tabindex="-1" href="/authors/jeroen">Jeroen Knoops</a><a class="bm-item SideMenu__MenuLink-uekpe8-1 lcZENV" style="display:block" tabindex="-1" href="/authors/stefan">Stefan van den Oord</a><a class="bm-item SideMenu__MenuLink-uekpe8-1 lcZENV" style="display:block" tabindex="-1" href="/authors/thales">Thales Sousa</a></nav></div><div><div class="bm-cross-button" style="position:absolute;width:24px;height:24px;right:8px;top:8px"><span style="position:absolute;top:6px;right:14px"><span class="bm-cross" style="position:absolute;width:3px;height:14px;transform:rotate(45deg)"></span><span class="bm-cross" style="position:absolute;width:3px;height:14px;transform:rotate(-45deg)"></span></span><button style="position:absolute;left:0;top:0;width:100%;height:100%;margin:0;padding:0;border:none;font-size:0;background:transparent;cursor:pointer" tabindex="-1">Close Menu</button></div></div></div><div><div class="bm-burger-button" style="z-index:1000"><span><span class="bm-burger-bars" style="position:absolute;height:20%;left:0;right:0;top:0%;opacity:1"></span><span class="bm-burger-bars" style="position:absolute;height:20%;left:0;right:0;top:40%;opacity:1"></span><span class="bm-burger-bars" style="position:absolute;height:20%;left:0;right:0;top:80%;opacity:1"></span></span><button style="position:absolute;left:0;top:0;width:100%;height:100%;margin:0;padding:0;border:none;font-size:0;background:transparent;cursor:pointer">Open Menu</button></div></div></div></div><div style="margin:0 0"><div style="background-image:url(&quot;/static/be4c42fdeda71d7e306461b20f94342a/cover.jpg&quot;)" class="Hero__HeroContainer-sc-1i1rqpz-0 lfoWPa"><div class="Hero__TitleContainer-sc-1i1rqpz-1 hPmQYh"><h1 class="Hero__HeroTitle-sc-1i1rqpz-3 dANmgz">Scaling GitHub Action Runners</h1><h2 class="Hero__HeroSubtitle-sc-1i1rqpz-4 brBAvj">Serverless scalable self-hosted runners on AWS spot instances</h2><span class="Hero__DateAndAuthor-sc-1i1rqpz-5 hpDnww">by:<!-- --> <a class="Hero__AuthorLink-sc-1i1rqpz-6 bWPqAN" href="/authors/niek">niek</a>  on <!-- -->2020-05-25</span></div><div class="Hero__LocationContainer-sc-1i1rqpz-2 gEMFDS"><span class="Hero__LocationMarker-sc-1i1rqpz-8 eyJpws"><span class="fa fa-map-marker-alt"></span></span><a href="https://goo.gl/maps/fp8Q2UYVZbE1kfM7A" target="_blank" class="Hero__LocationLink-sc-1i1rqpz-7 cmRrYK">Van Abbe</a></div></div><main role="main" class="Wrapper-aej7i5-0 hwkicN"><article class="Article__ArticleWrapper-sc-1nyoqfc-0 iTdcdb"><section><header class="ContentHeader__Header-sc-1uw779c-0 jRHVYT"><div class="TagList__ListContainer-sc-1uj42o2-0 kQWgFX"><a class="w3-round-size TagList__TagListItem-sc-1uj42o2-1 itRnbT" href="/tags/github">github</a> <a class="w3-round-size TagList__TagListItem-sc-1uj42o2-1 itRnbT" href="/tags/ci">ci</a> <a class="w3-round-size TagList__TagListItem-sc-1uj42o2-1 itRnbT" href="/tags/aws">aws</a> <a class="w3-round-size TagList__TagListItem-sc-1uj42o2-1 itRnbT" href="/tags/terraform">terraform</a> <a class="w3-round-size TagList__TagListItem-sc-1uj42o2-1 itRnbT" href="/tags/lambda">lambda</a> <a class="w3-round-size TagList__TagListItem-sc-1uj42o2-1 itRnbT" href="/tags/typescript">typescript</a></div></header><div class="Content__ContentBody-sc-1jppj8x-0 jNHeyA"><p><em>This post explains how to run GitHub actions on self-hosted scalable runners on AWS spot instances.</em></p>
<p style="text-align: right">
  <a href="https://github.com/philips-labs/terraform-aws-github-runner" target="sourcecode">
  <i class="fab fa-github" style="font-size: 200%">&nbsp;</i>Source code for this post</a></p>
<h2 id="introduction" style="position:relative;"><a href="#introduction" aria-label="introduction permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Introduction</h2>
<p>Last year GitHub released <a href="https://github.blog/2019-11-05-self-hosted-runners-for-github-actions-is-now-in-beta/">self-hosted action runners</a> which already empower you to run GitHub actions on your own machines. At the time of, the feature was quite limited; it lacked an API and only supported repository level runners. We could already automate the deployment of a single self-hosted runner for one repo with Terraform on AWS. But the clear drawback here is that you will pay AWS for hosting your instances, even if there is no workload to execute. Over the last months, GitHub released an <a href="https://github.blog/changelog/2020-01-27-github-actions-api-beta/">API</a> for self-hosted action runners, and support for <a href="https://github.blog/changelog/2020-04-22-github-actions-organization-level-self-hosted-runners/">org level runners</a> was added. Therefore, now is a good moment to have a second look on how to utilize self-hosted runners, and scale the self-hosted runners up and down based on workload using the GitHub API. Similar to scaling runners for GitHub we wrote an <a href="/2017/12/09/runners-on-the-spot">article</a> on how to scale runners for <a href="https://docs.gitlab.com/runner/">GitLab</a> which Terraform community module you find <a href="https://github.com/npalm/terraform-aws-gitlab-runner">here</a>.</p>
<h2 id="why" style="position:relative;"><a href="#why" aria-label="why permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Why?</h2>
<p>Why we are using self-hosted runners? First of all, by running on our own hardware, we created our own trusted environment for our builds that we can connect to networks not available via public runners. Note that because of this reason, we choose to limit the use of self-hosted runners to our private and internal repositories. While using self-hosted runners on public repositories is possible, be aware that any pull request will run on your hardware which could have serious security risks. Therefore you should carefully consider the usage of self-hosted runners in this context. A second advantage of hosting our own runners, is that we can fine-tune the required hardware. Finally, local runners allow you to control, and maybe even save, costs, in contrast to public runners that are not free for non-public repo’s. The setup we will show will have almost no costs if there are no builds, and by executing the workflows on AWS spot instances we save again some pennies.</p>
<h2 id="the-idea" style="position:relative;"><a href="#the-idea" aria-label="the idea permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>The idea</h2>
<p>The GitHub self-hosted action runner is an agent that you need to install on any machine that needs to pickup and execute workflow. To connect the agent to GitHub you can either choose to register the agent on repo level or org level. For registration you request a registration token (<a href="https://developer.github.com/v3/actions/self-hosted-runners/">API</a>) and this token is used during the setup of agent. This part is easy to automate, so let’s have a look how we can orchestrate the process of creating runners.</p>
<p>In GitHub everytime a workflow is triggered, a <code class="language-text">check run</code> event is created. Can we use this event to decide whether to scale a runner? Yes, if we find a way to receive and listen for the event. Actually, there are two options: using the webhook at the repo or org level, or using the GitHub app. Here, we will use the GitHub app option. The GitHub app can sent a message to our webhook for every <code class="language-text">check run</code> event and we can easily implement this webhook with a AWS Lambda function. This lambda can verify the event, run some other checks and decide to create a EC2 spot instance to facilitate the execution of the workflow. The EC2 spot instances will be linux based with docker so we can run any containerized workload.</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; "
    >
      <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 68.24324324324324%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsSAAALEgHS3X78AAABeUlEQVQ4y3WTi0rDMBiF2yZp0m2urtN5BZGpeEPxQcQXExF8Yc/JTvCndoFvSZrk/NdVzrmKg7OotQ+gA61I2ndah3JW17VrmiZkLQqIyg5e1MyzGYhGPEo4v/Xev2I+pZGxyDm4AXegh1V+m4OFvj2AW/Co79mLGOMqhDDPTuDnCbxJrNdjhjQzHiYJHOp8USKAd9kZGKd+9uAHfIOPqZDL4EN8W43DMjUITkX4BF9gaTziHLXniBD0oyL5fYIv4F2XbcWLIIWW4BncK0VXSsN/QeN6o2oO2kdzkflbS5h5PtjrISvZ8OdPeAOOeQH9ZQ0ygsU4f1MhcxGMZhHttT5TB1yALY1VE8MKMpyBOeFB8SrnaNf9FDyBQRrZYKb3DMqrVYLJdRZcy3osXpaioFlT27ZzgN6NHeaUuq5V+7BA1yrWsGuC3UMnwdLIFR4yr3idOnAElmAAPQQHekeBIqJwkzMJvbSCpf/4h+cSaWBFeeB1FCag5/UvGoMT0PPkrHwAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <picture>
        <source
          srcset="/static/402d87b6ca089a161b38f09fd6a13f15/cbe2e/idea.webp 148w,
/static/402d87b6ca089a161b38f09fd6a13f15/3084c/idea.webp 295w,
/static/402d87b6ca089a161b38f09fd6a13f15/5ca24/idea.webp 590w,
/static/402d87b6ca089a161b38f09fd6a13f15/87ca7/idea.webp 730w"
          sizes="(max-width: 590px) 100vw, 590px"
          type="image/webp"
        />
        <source
          srcset="/static/402d87b6ca089a161b38f09fd6a13f15/12f09/idea.png 148w,
/static/402d87b6ca089a161b38f09fd6a13f15/e4a3f/idea.png 295w,
/static/402d87b6ca089a161b38f09fd6a13f15/fcda8/idea.png 590w,
/static/402d87b6ca089a161b38f09fd6a13f15/e9beb/idea.png 730w"
          sizes="(max-width: 590px) 100vw, 590px"
          type="image/png"
        />
        <img
          class="gatsby-resp-image-image"
          src="/static/402d87b6ca089a161b38f09fd6a13f15/fcda8/idea.png"
          alt="idea"
          title="concept"
          loading="lazy"
          style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        />
      </picture>
    </span></p>
<p>Being able to create runners once a workflow is triggered brings us the possibility to scale up. Question remains now how to scale down? Again we could listen for event and next try to scale down. Since a runner instance is not dedicated to only executing one workload. At the moment another workflow requires a build the, the runner will process this build as well. This makes scaling down based on events less trivial. So we took a slightly different and much simpler approach: every x minutes all runners that are not busy are removed.</p>
<p>You might think why not using <a href="https://kubernetes.io/">Kubernetes</a>? The reasons for us are quite simple. First, we would like to have a solution that could scale really from zero without making any costs. Second, with Kubernetes we enter a other model of running the GitHub agent, which is not supported (yet?). So, this would introduce some extra obstacles as managing docker in docker. Hence, we favoured this simple and straightforward approach.</p>
<h2 id="architecture" style="position:relative;"><a href="#architecture" aria-label="architecture permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Architecture</h2>
<p>Before we build scalable runners on AWS, we discuss the architecture in a bit more detail. On AWS we need several infrastructure components and a component to orchestrate the life cycle of the action runners. All infra structure will be created using <a href="https://www.terraform.io/">HashiCorp Terraform</a>. The orchestration layer is build with AWS lambda. All the lambda functions are written in <a href="https://www.typescriptlang.org/">TypeScript</a> and compiled to NodeJS single file with <a href="https://github.com/zeit/ncc">zeit ncc</a>.</p>
<p>For the orchestration we build 4 different lambda’s: First a lambda to handle the GitHub events, two lambda’s for scaling up and down. And a last one to synchronize the runner binary. The self-hosted runners will run on AWS spot instances.</p>
<p><img src="/a92960a66f989bdb08fe68cdcdb5e8dc/architecture.svg" alt="architecture" title="architecture"></p>
<h3 id="webhook" style="position:relative;"><a href="#webhook" aria-label="webhook permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Webhook</h3>
<p>This <a href="https://github.com/philips-labs/terraform-aws-github-runner/tree/master/modules/webhook">lambda</a> receives events via the API gateway sent via the GitHub App for each check run event. The lambda will check if the event is signed with correct secret. Next it filters only for the check run event that requires an action runner, other events are simply dropped. In other words the we only keep the events that are created once a new workflow is triggered. The events we accept are published on a SQS queue. Messages on the queue are delayed for 30 seconds by default. This allows possible idle action runners to start the workflow execution.</p>
<h3 id="scale-up" style="position:relative;"><a href="#scale-up" aria-label="scale up permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Scale up</h3>
<p>This <a href="https://github.com/philips-labs/terraform-aws-github-runner/tree/master/modules/runners">lambda</a> will receive messages from the SQS queue. For each message the lambda first verifies if the workflow has not yet been started. When the workflow is still queued, the lambda will create an AWS spot instance via a launch template. Before creating the instance, a new runner will be registered to GitHub. The token will be temporary stored in the AWS parameter store (SSM). During the boot the AWS instance installs all requirements via a <code class="language-text">user_data</code> script. The script will install docker, git and the action runner, which is fetched from a S3 bucket. Finally the runner is configured with parameters fetched from the parameter store, and is then ready to consume workloads.</p>
<h3 id="scale-down" style="position:relative;"><a href="#scale-down" aria-label="scale down permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Scale down</h3>
<p>This <a href="https://github.com/philips-labs/terraform-aws-github-runner/tree/master/modules/runners">lambda</a> is triggered by a cloud watch event. Every time it runs it will try to remove all the registered runners from GitHub. Only inactive runners can be removed. Trying to remove an active one will simply fail, resulting in a 500 response. For all the removed runners from GitHub the lambda will terminate the EC2 spot instances so the bill stops. The scale up and scale down lambda share the same code base, and are released as one zip.</p>
<h3 id="update-binary" style="position:relative;"><a href="#update-binary" aria-label="update binary permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Update Binary</h3>
<p>This <a href="https://github.com/philips-labs/terraform-aws-github-runner/tree/master/modules/runner-binaries-syncer">lambda</a> will download the action runner binary to avoid unnecessary latency during creation of the runners. We found out in our first week of running our setup that downloading the action runner binary could take up to 15 minutes, therefore we build a simple lambda to cache the artifact in a bucket.</p>
<h2 id="build-it" style="position:relative;"><a href="#build-it" aria-label="build it permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Build it</h2>
<p>Time to build the idea. In the next steps we create a GitHub app, setup Terraform, configure an example repo to test our runners.</p>
<h3 id="github-app" style="position:relative;"><a href="#github-app" aria-label="github app permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>GitHub app</h3>
<p>As mentioned above there are two scenario’s two options for running the self-hosted runner, repo level or org level. Our module supports both but for this blog we use the repo level runner as example. The example below is based on the <a href="https://github.com/philips-labs/terraform-aws-github-runner/tree/master/examples/default">default example</a> in the Terraform module.</p>
<p>The process starts with the event that we need to receive. So first we create a <a href="https://github.com/settings/apps/new?name=AWS%20Spot%20Runner&#x26;public=false">GitHub App</a>. To create an app in your organization, go to you organization settings and select GitHub apps. On the app creation page you only need to fill in the name, homepage, and uncheck the webhook. We will activate the webhook once we know our endpoint.</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 520px; "
    >
      <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 125%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAZCAYAAAAxFw7TAAAACXBIWXMAAAsSAAALEgHS3X78AAADBklEQVQ4y41VyY7TQBD1X3LgwpEjEhdO8AmAhMQZDogDP8AZhIQ4sCgzmXFix0viOIn3fX9UdeLMeORkxtJLtdud7lreq5aKokAUxYiTBFmWIUlSRHEswHNpmqJtWzz0kcIwwuRiCnmuYLmyoOk6FpoOeTaHoi5wLc9QlpVY3HYdunsgdXR6XZVomhpNXQmMP91Z8GEMaeOE+PVPxu9LBX8uVbIqltsIblwd4SU1/LRBkLUDhASej/OblEhu2kJfe7C2Hpa2i40bwbB2UI01jLUDhaysmrDp4LwG0rIldMLyu+PHMJ0UTbePQgqTAvOlA3XlQKONNcuDYtKGKxfmJkSYd0fveBzm7S3QN5pPir2HIofg2A/5YyvGB1tXFeIoRJYmIs83uRzJMBeFQz5HgaZpYJpLWJYl6HP849kqd93oab11HAe73Q51XQ++neQhL5xeXeHqWhbcK8tyEALbntjdQ3jYtB2SNBcqyfPipAfdSBTtCKQgA2bLELq2QECqqesGFRWjZJBCeLxHfRwXRSnWjYbMP2mWY0e52u4cuJ5HG4dkfZpz4fmBGHu+jyAIxfva3gqdj6VB0ObUwws8OiCKIpTURE4Vb+Bhn/S74HkumGEYRB1zlDa33wchn3u4WP1md70a9bAqC+i6BnuzxXptUwtbUQsjr5Z7qxumaGdzRRWbizZ2iGDMUykmPaorD667IwI7AlsiMhcpz3PBS27CxUgOxzyVUmp/qhVCURTMyAt1oRHRZdFwuapMJYbr+vCDgBDCsjei8ow0zYYeMmVZ+CmFwyH1nvRFYT0zmIf9mL3ux3dVJIpibWz8nUxwQRKcTKdwAx9hHO3vF7pv2NOECsPvjIx4y3cOe57fcmBY5fagLxYAy5nWFZTDIueLKxER9MhoPo4TIncqVLOn3kF6ZmbjzeIj3umfBN4bn/Fa+4Av9lcUlN+EuvN9d95AKRNfxqNvz/D050s8+fFC2Mffn+PVv7ewggqyTVWuzneboZa7fSMtqWPX1KWrphLgEE71yHP4DxIqkQkvzZm4AAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <picture>
        <source
          srcset="/static/86bc7d48f65c06506f52fa5f5808d0e3/cbe2e/github-app.webp 148w,
/static/86bc7d48f65c06506f52fa5f5808d0e3/3084c/github-app.webp 295w,
/static/86bc7d48f65c06506f52fa5f5808d0e3/002e6/github-app.webp 520w"
          sizes="(max-width: 520px) 100vw, 520px"
          type="image/webp"
        />
        <source
          srcset="/static/86bc7d48f65c06506f52fa5f5808d0e3/12f09/github-app.png 148w,
/static/86bc7d48f65c06506f52fa5f5808d0e3/e4a3f/github-app.png 295w,
/static/86bc7d48f65c06506f52fa5f5808d0e3/69902/github-app.png 520w"
          sizes="(max-width: 520px) 100vw, 520px"
          type="image/png"
        />
        <img
          class="gatsby-resp-image-image"
          src="/static/86bc7d48f65c06506f52fa5f5808d0e3/69902/github-app.png"
          alt="app"
          title="create GitHub app"
          loading="lazy"
          style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        />
      </picture>
    </span></p>
<p>Next hit create app, you will be redirected to the app overview page. Make a note of the following generated id’s, and generate the ssh private key on the bottom of this page.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">App ID:         12345
Client ID:      Iv1.abcd1234
Client secret:  some-secret</code></pre></div>
<h3 id="lambda-artifacts" style="position:relative;"><a href="#lambda-artifacts" aria-label="lambda artifacts permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Lambda artifacts</h3>
<p>Before we can actually deploy the infrastructure we need to build or download the lambda functions. You can clone the module repo and use the script in <code class="language-text">.ci/build.sh</code> to build the 3 lambda zip files. But the easier option is just to download the <a href="https://github.com/philips-labs/terraform-aws-github-runner">release artifacts</a> from the repo. We even provide a small utility module to download the artifacts.</p>
<p>Create a new workspace (directory) and add the following terraform code.</p>
<div class="gatsby-highlight" data-language="hcl"><pre class="language-hcl"><code class="language-hcl"><span class="token keyword">module<span class="token type variable"> "github-runner_download-lambda" </span></span><span class="token punctuation">{</span>
  <span class="token property">source</span>  <span class="token punctuation">=</span> <span class="token string">"philips-labs/github-runner/aws//modules/download-lambda"</span>
  <span class="token property">version</span> <span class="token punctuation">=</span> <span class="token string">"0.1.0"</span>
<span class="token punctuation">}</span>

  <span class="token property">lambdas</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">name</span> <span class="token punctuation">=</span> <span class="token string">"webhook"</span>
      <span class="token property">tag</span>  <span class="token punctuation">=</span> <span class="token string">"v0.1.0"</span>
    <span class="token punctuation">}</span>,
    <span class="token punctuation">{</span>
      <span class="token property">name</span> <span class="token punctuation">=</span> <span class="token string">"runners"</span>
      <span class="token property">tag</span>  <span class="token punctuation">=</span> <span class="token string">"v0.1.0"</span>
    <span class="token punctuation">}</span>,
    <span class="token punctuation">{</span>
      <span class="token property">name</span> <span class="token punctuation">=</span> <span class="token string">"runner-binaries-syncer"</span>
      <span class="token property">tag</span>  <span class="token punctuation">=</span> <span class="token string">"v0.1.0"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Next run <code class="language-text">terraform init &amp;&amp; terraform apply</code> the lambda artifacts will be download to your local machine.</p>
<h3 id="deploy-the-action-runners" style="position:relative;"><a href="#deploy-the-action-runners" aria-label="deploy the action runners permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Deploy the action runners</h3>
<p>Now we will create all required AWS resources and deploy the lambda functions. Besides this module, we also need a vpc as well. We have a VPC with a public <a href="https://github.com/terraform-aws-modules/terraform-aws-vpc">terraform AWS VPC</a> module, you can use your own VPC as well. Create a new workspace and the code below to the <code class="language-text">main.tf</code>.</p>
<div class="gatsby-highlight" data-language="hcl"><pre class="language-hcl"><code class="language-hcl"><span class="token keyword">provider<span class="token type variable"> "aws" </span></span><span class="token punctuation">{</span>
  <span class="token property">region</span>  <span class="token punctuation">=</span> local.aws_region
  <span class="token property">version</span> <span class="token punctuation">=</span> <span class="token string">"2.61"</span>
<span class="token punctuation">}</span>

<span class="token keyword">locals</span> <span class="token punctuation">{</span>
  <span class="token property">environment</span> <span class="token punctuation">=</span> <span class="token string">"blog"</span>
  <span class="token property">aws_region</span>  <span class="token punctuation">=</span> <span class="token string">"eu-west-1"</span>
<span class="token punctuation">}</span>

<span class="token keyword">module<span class="token type variable"> "vpc" </span></span><span class="token punctuation">{</span>
  <span class="token property">source</span>  <span class="token punctuation">=</span> <span class="token string">"terraform-aws-modules/vpc/aws"</span>
  <span class="token property">version</span> <span class="token punctuation">=</span> <span class="token string">"2.33"</span>

  <span class="token property">name</span> <span class="token punctuation">=</span> <span class="token string">"vpc-blog"</span>
  <span class="token property">cidr</span> <span class="token punctuation">=</span> <span class="token string">"10.0.0.0/16"</span>

  <span class="token property">azs</span>             <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"eu-west-1a"</span>, <span class="token string">"eu-west-1b"</span>, <span class="token string">"eu-west-1c"</span><span class="token punctuation">]</span>
  <span class="token property">private_subnets</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"10.1.0.0/24"</span>, <span class="token string">"10.0.2.0/24"</span>, <span class="token string">"10.0.3.0/24"</span><span class="token punctuation">]</span>
  <span class="token property">public_subnets</span>  <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"10.1.001.0/24"</span>, <span class="token string">"10.1.002.0/24"</span>, <span class="token string">"10.1.003.0/24"</span><span class="token punctuation">]</span>

  <span class="token property">enable_nat_gateway</span> <span class="token punctuation">=</span> <span class="token boolean">true</span>
  <span class="token property">single_nat_gateway</span> <span class="token punctuation">=</span> <span class="token boolean">true</span>
  <span class="token property">enable_s3_endpoint</span> <span class="token punctuation">=</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span></code></pre></div>
<p>You can already run and apply the terraform code, once we have finished with the setup. We can now add the GitHub action runner module. Events sent to the webhook will be signed with a secret, therefore we generate a password with <a href="https://www.terraform.io/docs/providers/random/">Terraform random provider</a>. Ensure you set the variables for the lambda zip to the download lambda artifacts, and also add the id’s, keys and base64 encoded secret for the GitHub app to the configuration.</p>
<div class="gatsby-highlight" data-language="hcl"><pre class="language-hcl"><code class="language-hcl"><span class="token keyword">resource <span class="token type variable">"random_password"</span></span> <span class="token string">"random"</span> <span class="token punctuation">{</span>
  <span class="token property">length</span> <span class="token punctuation">=</span> <span class="token number">32</span>
<span class="token punctuation">}</span>

<span class="token keyword">module<span class="token type variable"> "runners" </span></span><span class="token punctuation">{</span>
  <span class="token property">source</span>  <span class="token punctuation">=</span> <span class="token string">"philips-labs/github-runner/aws"</span>
  <span class="token property">version</span> <span class="token punctuation">=</span> <span class="token string">"0.1.0"</span>

  <span class="token property">aws_region</span>  <span class="token punctuation">=</span> local.aws_region
  <span class="token property">vpc_id</span>      <span class="token punctuation">=</span> module.vpc.vpc_id
  <span class="token property">subnet_ids</span>  <span class="token punctuation">=</span> module.vpc.private_subnets
  <span class="token property">environment</span> <span class="token punctuation">=</span> local.environment

  <span class="token property">github_app</span> <span class="token punctuation">=</span> <span class="token punctuation">{</span>
    <span class="token property">key_base64</span>     <span class="token punctuation">=</span> <span class="token string">""</span>
    <span class="token property">id</span>             <span class="token punctuation">=</span> <span class="token string">""</span>
    <span class="token property">client_id</span>      <span class="token punctuation">=</span> <span class="token string">""</span>
    <span class="token property">client_secret</span>  <span class="token punctuation">=</span> <span class="token string">""</span>
    <span class="token property">webhook_secret</span> <span class="token punctuation">=</span> random_password.random.result
  <span class="token punctuation">}</span>

  <span class="token property">webhook_lambda_zip</span>                <span class="token punctuation">=</span> <span class="token string">"lambdas-download/webhook.zip"</span>
  <span class="token property">runner_binaries_syncer_lambda_zip</span> <span class="token punctuation">=</span> <span class="token string">"lambdas-download/runner-binaries-syncer.zip"</span>
  <span class="token property">runners_lambda_zip</span>                <span class="token punctuation">=</span> <span class="token string">"lambdas-download/runners.zip"</span>
  <span class="token property">enable_organization_runners</span>       <span class="token punctuation">=</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>

<span class="token keyword">output<span class="token type variable"> "lambda_syncer_name" </span></span><span class="token punctuation">{</span>
  <span class="token property">value</span> <span class="token punctuation">=</span> module.runners.binaries_syncer.lambda.function_name
<span class="token punctuation">}</span>

<span class="token keyword">output<span class="token type variable"> "webhook" </span></span><span class="token punctuation">{</span>
  <span class="token property">value</span> <span class="token punctuation">=</span> <span class="token punctuation">{</span>
    <span class="token property">secret</span>   <span class="token punctuation">=</span> random_password.random.result
    <span class="token property">endpoint</span> <span class="token punctuation">=</span> module.runners.webhook.endpoint
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Save your configuration and run <code class="language-text">terraform init</code> and <code class="language-text">terraform apply</code>. Once Terraform is finished we will trigger the lambda function for the syncing the distribution one time manually to ensure our cache is filled.</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">aws lambda invoke --function-name <span class="token punctuation">\</span>
  <span class="token variable"><span class="token variable">$(</span>terraform output -json lambda_syncer <span class="token operator">|</span> jq -r<span class="token variable">)</span></span> respone.json</code></pre></div>
<blockquote>
<p>The module we released for creating the infrastructure supports <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies_boundaries.html">IAM permissions boundaries</a> for those who have to run on shared AWS environments. For more details checkout the <a href="https://github.com/philips-labs/terraform-aws-github-runner/tree/master/examples/permissions-boundary">example</a>.</p>
</blockquote>
<h3 id="configure-the-github-app-part-2" style="position:relative;"><a href="#configure-the-github-app-part-2" aria-label="configure the github app part 2 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Configure the GitHub App part 2</h3>
<p>Go back to your GitHub app and activate the webhook, and provide the endpoint and secret. <strong>Don’t forget to save the changes</strong>. Now you can subscribe for events. Go to the section <em>permissions and events</em>, grant permission on repo as follow, check your terraform output for the values. (<code class="language-text">terraform output -json webhook</code>):</p>
<ol>
<li>Administration (read, write) - required to register runner.</li>
<li>Repository permissions Checks (read) - required to get check run events</li>
</ol>
<p>Scroll all the way to the bottom and check the box to subscribe to the check event.</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; "
    >
      <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 79.72972972972973%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsSAAALEgHS3X78AAABzElEQVQ4y5VTCXKDMAzk/59MQ8KZUMxhDAZH1co4IZTMtJ7RiEOW17urqGlauiYp5UVBRVFSkqZU1zVhPR6Pf0c0TRO1XUdmHAnPI+d5nv/cYLukYdO2dLkm1PWam000GENaD7QsyxvK/UaswYx0q2pKsoLzNzk0HIGw7QSlR7c8Ee6b7AO12A8QyIKwVorO8YXiy5Vu94p6RormXd9T1/WkmGN8O2qoGEjJe7LiRlWtPEJrLQ3DIC8oWhYn4RznNdyK9jfCWa6Ng4FSEKqmEYRKNR/5Ap+B0y2HhjkHsnyLkA7WtjEalWV5aKWjFQFqxQpBbXgSsV8dbMV1nw5+82HP5Od5IU3vTPC9qsgyN+A2hFfeq493+BUZVwzxbAhBFCsN64TcMlpw61E3wm/FB8EReK+ZL+w7Qhw55ihJM4pZGIgD62guNqvBp8lKsdaaTl9n6jmDJmT8R4atgF44dM4b1Np5VdPJTzyHq2LhW81IzTqarxqfg0iR0o5OccLjdxUT4/RhMIIS+TVmRm6ScqAxpgoIkYFysv4mYhsoi+nAaSAc1wzx8txIGYuHQ9AElOAbBMTYBZ9Gn/y0NzFUBb8Ni9YzMkxH4Hdb+wNa++LUvFkzOQAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <picture>
        <source
          srcset="/static/bffaff6e338b1666f1075bc99c45461f/cbe2e/github-app2.webp 148w,
/static/bffaff6e338b1666f1075bc99c45461f/3084c/github-app2.webp 295w,
/static/bffaff6e338b1666f1075bc99c45461f/5ca24/github-app2.webp 590w,
/static/bffaff6e338b1666f1075bc99c45461f/4cb1e/github-app2.webp 786w"
          sizes="(max-width: 590px) 100vw, 590px"
          type="image/webp"
        />
        <source
          srcset="/static/bffaff6e338b1666f1075bc99c45461f/12f09/github-app2.png 148w,
/static/bffaff6e338b1666f1075bc99c45461f/e4a3f/github-app2.png 295w,
/static/bffaff6e338b1666f1075bc99c45461f/fcda8/github-app2.png 590w,
/static/bffaff6e338b1666f1075bc99c45461f/321ea/github-app2.png 786w"
          sizes="(max-width: 590px) 100vw, 590px"
          type="image/png"
        />
        <img
          class="gatsby-resp-image-image"
          src="/static/bffaff6e338b1666f1075bc99c45461f/fcda8/github-app2.png"
          alt="github-app2"
          title="Permissions and events."
          loading="lazy"
          style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        />
      </picture>
    </span></p>
<blockquote>
<p>Note: for org level runners you need to grant the administration permission on org level instead of repo level.</p>
</blockquote>
<h2 id="putting-all-together" style="position:relative;"><a href="#putting-all-together" aria-label="putting all together permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Putting all together</h2>
<p>We are almost done; next we configure the self-hosted runner for a test repo. First we create a test repo in <a href="https://github.com/new">GitHub</a>. In case you are using a runner and GitHub cannot find any runner that could run the workflow the build will directly fail. Since the scalable runners only create a runner once an event is received and remove the runners after an idle time, there are no candidate runners registered by default. For the time being we have a work around: register a runner for the repo (or org) which we will never use, and start that runner. The registered runner will prevent the workflow from failing. Be aware that this runner will be removed by GitHub after 30 days. To add this runner, go to your repo settings (or org settings), select actions and choose “Add runner”. Run the provided instruction for your OS and give it a descriptive name such as “dummy”. In case you provided the terraform module extra labels, provide them here as well.</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; "
    >
      <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 82.43243243243244%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsSAAALEgHS3X78AAACZ0lEQVQ4y32UW4+TQBTH++WNJhofjfHJzcZPYMzG+G70fX3aLW0ptKVchmGAgZmBv+cM0L3Etcmv58wBzpXDqu16ZMqgrDuUZYlSCEgpIQTpJUmyGWNhrYVzbpLWkDReOmu9Po6jv7aSssLdeoO7YIv1JsR6u8f9OsA6CLALQ0RRRMQIgg3JPbZRguAgsIlzBMQ2Tr3e9ZPzVd32OElHWKTKIakcCtngkKRQTQc3AnYAevrzOKAjnkt/H2W66oxDWiqE8QnRKcX+eCYySO0QJZxB4ilqaksHCD2iJBbJFO2IxsC3YMWpSuqfrDWUNlCUMdNS6JrOC9oM6Cz+ibZTFT7DpmmQphm0pvAv/EaGmj4Mw4vwzw+FMyyrBqe0wDkTyAqJqm4vSNWi7QxhKesZf56hc0MV9HZ6A1Y9OUzzEsEuQhgdsYsO2O0P2ISxt53OGQWsyXHj5aJPwZqZ9rlDgZiGkaQ5UaCgIeVCkqwgpPIyK0qqgKrIhdf5Olez3GceO5QU7ZhkOFI28ensM+bIQj5k1Oge+n8lm9lhqzVllSGnqIocl5QRI7m8WVaqhu74IUsvMGEeWGzODZNDTQ7zQpCxv0zUS1IGz+hxNElLD036bHOTzdJKDsvq8Z5yH+6Dne8jD4VXcE8vOrchOiTezvCZ+8ttYFm3nS+Xt+1SMkf5+u0Gb9+9x4ePn3B1/QWfr67x89dvP8ml6Y8HxA5ZZ4fcR+7vZcpc4s33H3j1+g02uz3t5gheR0b7frFcsE9YBsMOecrOkUNV1/5Lcnv7BwV9uvgsq+pCVSkaiprkzBP7fI2fU6T/Bd0/yeOPWsOZAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <picture>
        <source
          srcset="/static/56c997b4af8f61d415e06a7e53c7b01f/cbe2e/register.webp 148w,
/static/56c997b4af8f61d415e06a7e53c7b01f/3084c/register.webp 295w,
/static/56c997b4af8f61d415e06a7e53c7b01f/5ca24/register.webp 590w,
/static/56c997b4af8f61d415e06a7e53c7b01f/f23e7/register.webp 814w"
          sizes="(max-width: 590px) 100vw, 590px"
          type="image/webp"
        />
        <source
          srcset="/static/56c997b4af8f61d415e06a7e53c7b01f/12f09/register.png 148w,
/static/56c997b4af8f61d415e06a7e53c7b01f/e4a3f/register.png 295w,
/static/56c997b4af8f61d415e06a7e53c7b01f/fcda8/register.png 590w,
/static/56c997b4af8f61d415e06a7e53c7b01f/a4262/register.png 814w"
          sizes="(max-width: 590px) 100vw, 590px"
          type="image/png"
        />
        <img
          class="gatsby-resp-image-image"
          src="/static/56c997b4af8f61d415e06a7e53c7b01f/fcda8/register.png"
          alt="register-runner"
          title="Configure a dummy."
          loading="lazy"
          style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        />
      </picture>
    </span></p>
<p>THe final step is to install the GitHub app we have created. Go to your <a href="https://github.com/settings/apps/self-hosted-aws-spot-runners">app settings</a> and select install, now you can choose how to install the app. To only receive relevant events we choose to be repo specific and install the app to our test repo.</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 494px; "
    >
      <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 97.2972972972973%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAAAsSAAALEgHS3X78AAACK0lEQVQ4y5VUW47TQBD0seAk/HIMbsMFuACCLySEEHyRXYRWIY7fj8SO30lsj4uuIY7DypuwI7XamtHUVHV32RiGAV3XYb/fo2ka1HWNw+GAa4t3nloGD+PNBvc/f+HH4g6Lu3uszDXKqkYlUZYVanmI30VZ6odH0Dlg4/QmjscWe2HW9T1aYUyQRi6XVaUjL0rkeSEKmuuA2wowgxpR6COKYokIQRCeY+7SVclNC8S7BrbtwFzbcFwPpmVjtbZg2a6WPrK5ZHVV8vF4hOUFePhtYu14WJoWHpamZBvJLodS6h+Qa6EBWbuM9dFdblBIvVjLxyCs9a31l2Hb6qKzCQSlTDZmbpGtEvBzqBmGvbBJkgRhGMF2HAkXrtTS9Xyduee4LrIsm0DVoDNBSIhEzgy5yWGmXB7kRaEH/HLYmVu5OM96EFJqGmzP97GWzlq2rRk5wnD87k+1vByZua6PZ4YaFPpTFymh63pdG9qR3Scg98lgkjoX6lRDcUid7rCVGiZJKm7IkaSplvlcH2vJveqw2cZ6sH0/QChOobfpmoq2E//Sw1mWa8aT7Hn5hgjCrsxhSQ0JQkAyZPbFesxBGOoHU9m/NeBGN/SIdhssVyt4YaCbwREhUBTH+hGOD33tSR5/bU9JN/DMNQzDNNyPGqMZpm2Oj9sv+JR+x/vNZ5i1CykrqkOnO3sGOMVNL3/bLvDywyu8/voGLyS/Xb2TwQYWXoN9O/4U/l/BH5WZwyUUnWKxAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <picture>
        <source
          srcset="/static/c2d63d2579a0ecdc228bc19622db635e/cbe2e/install-app.webp 148w,
/static/c2d63d2579a0ecdc228bc19622db635e/3084c/install-app.webp 295w,
/static/c2d63d2579a0ecdc228bc19622db635e/32f69/install-app.webp 494w"
          sizes="(max-width: 494px) 100vw, 494px"
          type="image/webp"
        />
        <source
          srcset="/static/c2d63d2579a0ecdc228bc19622db635e/12f09/install-app.png 148w,
/static/c2d63d2579a0ecdc228bc19622db635e/e4a3f/install-app.png 295w,
/static/c2d63d2579a0ecdc228bc19622db635e/d72d4/install-app.png 494w"
          sizes="(max-width: 494px) 100vw, 494px"
          type="image/png"
        />
        <img
          class="gatsby-resp-image-image"
          src="/static/c2d63d2579a0ecdc228bc19622db635e/d72d4/install-app.png"
          alt="install-app"
          title="Install app."
          loading="lazy"
          style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        />
      </picture>
    </span></p>
<p>That’s it, time to test. First create a simple action workflow in an empty directory.</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">mkdir</span> -p .github/workflows
<span class="token function">cat</span> <span class="token operator">&lt;&lt;</span> EOF <span class="token operator">></span> .github/workflows/verify.yml
name: verify
on: <span class="token punctuation">[</span>push<span class="token punctuation">]</span>

jobs:
  cowsay:
    runs-on: self-hosted
    container: npalm/cowsay

    steps:
      - uses: actions/checkout@v2
      - run: cowsay -f ghostbusters <span class="token string">"  Who ya gonna call?"</span>
EOF</code></pre></div>
<p>Initialize your current directory as GitHub repo and push all the content to GitHub.</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">git</span> init
<span class="token function">git</span> remote <span class="token function">add</span> origin git@github.com:<span class="token operator">&lt;</span>YOUR_REPO<span class="token operator">></span>
<span class="token function">git</span> <span class="token function">add</span> --all .github
<span class="token function">git</span> commit -m <span class="token string">"Test runners"</span> <span class="token builtin class-name">.</span>
<span class="token function">git</span> push origin master</code></pre></div>
<p>After 30 seconds you should see your new spot instance starting in AWS.</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; "
    >
      <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 8.108108108108107%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAAAsSAAALEgHS3X78AAAAgElEQVQI1x3Lyw6CMABEUf7/2wwqlhbaQOkrFkHTaEzcXYHd5MxMtSwrOc+klNDaoJQixsju4ziiuu6wEALaGIQQSClxzqN7fXRmc2stbdtSNd3EEFfm8uPWO2phODU9Fzlg3Hxklwtp/bJvr8ri8xv/LNRWcRYD4fHB3V/bf+IPjT+P/rp0fo0AAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <picture>
        <source
          srcset="/static/e54a4d12311a246318e0cd834027bfd0/cbe2e/aws-running.webp 148w,
/static/e54a4d12311a246318e0cd834027bfd0/3084c/aws-running.webp 295w,
/static/e54a4d12311a246318e0cd834027bfd0/5ca24/aws-running.webp 590w,
/static/e54a4d12311a246318e0cd834027bfd0/b2a51/aws-running.webp 830w"
          sizes="(max-width: 590px) 100vw, 590px"
          type="image/webp"
        />
        <source
          srcset="/static/e54a4d12311a246318e0cd834027bfd0/12f09/aws-running.png 148w,
/static/e54a4d12311a246318e0cd834027bfd0/e4a3f/aws-running.png 295w,
/static/e54a4d12311a246318e0cd834027bfd0/fcda8/aws-running.png 590w,
/static/e54a4d12311a246318e0cd834027bfd0/715a3/aws-running.png 830w"
          sizes="(max-width: 590px) 100vw, 590px"
          type="image/png"
        />
        <img
          class="gatsby-resp-image-image"
          src="/static/e54a4d12311a246318e0cd834027bfd0/fcda8/aws-running.png"
          alt="aws-running"
          title="aws-running"
          loading="lazy"
          style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        />
      </picture>
    </span></p>
<p>A bit later, the runner should be registered to your GitHub repo.</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; "
    >
      <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 23.64864864864865%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsSAAALEgHS3X78AAAAuklEQVQY04WO2Q6DIBRE+f9PbNKqqIkbWBd2cArEPrSJLckJuZeZcMi9oKjbLlPQBo+qRj8ySO2wSwOhrpHaYhMqd273EsPEQWjdItO0WLcdu5BQ2sA6/xNtLITUObvE3ryseSZdP2KcGIZolYJbfFRK4d+x1mFZt9hxH3tSRt1kWJQVKlpDRMMUPo4DIXJcEEI0tRY+hJwL5026IRlyjIyD8Rnz/ITzPv+Wit/nvXNWgHMGY0ye/dl5AXWEg6v9BEFYAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <picture>
        <source
          srcset="/static/3ec1d4e62a248190acdbfd9245bcd571/cbe2e/action-runners.webp 148w,
/static/3ec1d4e62a248190acdbfd9245bcd571/3084c/action-runners.webp 295w,
/static/3ec1d4e62a248190acdbfd9245bcd571/5ca24/action-runners.webp 590w,
/static/3ec1d4e62a248190acdbfd9245bcd571/bc514/action-runners.webp 720w"
          sizes="(max-width: 590px) 100vw, 590px"
          type="image/webp"
        />
        <source
          srcset="/static/3ec1d4e62a248190acdbfd9245bcd571/12f09/action-runners.png 148w,
/static/3ec1d4e62a248190acdbfd9245bcd571/e4a3f/action-runners.png 295w,
/static/3ec1d4e62a248190acdbfd9245bcd571/fcda8/action-runners.png 590w,
/static/3ec1d4e62a248190acdbfd9245bcd571/37523/action-runners.png 720w"
          sizes="(max-width: 590px) 100vw, 590px"
          type="image/png"
        />
        <img
          class="gatsby-resp-image-image"
          src="/static/3ec1d4e62a248190acdbfd9245bcd571/fcda8/action-runners.png"
          alt="spot-runner"
          title="spot-runner"
          loading="lazy"
          style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        />
      </picture>
    </span></p>
<p>And once registered it should only be a matter of seconds before the build starts.</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; "
    >
      <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 70.94594594594594%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsSAAALEgHS3X78AAACQ0lEQVQ4y5WSWWtTQRiGz58oRUqa5aTZt56kJ3tOtmYhRkpBvVDwP+hNYippe+FfES9cQSjdKAreCSISLCKIS22KF41t9iav30ybgCUldeA9M4dhnvne7x3hbfUddqtf8fNHFbuVCprNFnq9Htjo9/v43yFUfn/Bt9oh9g+O8fn9B9SOm6gd1dHunIDhPlY+YW19Azuv32Brewfrm1vY2Ny+UALHtg7p0xl54+rqCjQGOyKJDJweP1Q6E6bFiyWUnu2j9HQP5ee/aGbrKtf9J3tYWWsgfacIjSjC7vbD4vRAb3bAYHVhxuIcKeHeY4K9qOLhqwOw9UB3H31H8eURkrcL0MyISGTziKdzcPvCHMo0gAz+mU4t826dD6A7tDyh0sIbjMIfjiMYTcLjj0BntNFFFi62ZhJNdgiNVhdc7bOZVCf9qbc4sLC0jEm1DqHYPJRkBuFYCvFUDoFIgsPD8RQkbwhG2yxvhdDudDFKjeYpsEjAiSkNZKowmswioCShUEC+cIxC8kGSg9SGEA/MbJcgdLonOK9RQHZADiqYCyjcstHm+sfu0PI4YGGpjEmVDmaHmx9g1rQG6zAQtd5Mz8pKe2ehjAWWyrii1nMgq4IdckheWF0eyFTtfPYatSHB4Wz/UpantEbYZmXoqEI5FKMg0vQm57j1EIW0eOMWEpk8r3I88MEyVKIZNskHk92N3MJ1AikwOTxkX6KkU4hR6vnFm3DTBZezPK0nmES2JaSvLsAuydweezYRqtZgdfKwWHB/AaR56wXRFIVKAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <picture>
        <source
          srcset="/static/7c0fdbabe3af9a95f5eee3f8c2078e6b/cbe2e/run-workflow.webp 148w,
/static/7c0fdbabe3af9a95f5eee3f8c2078e6b/3084c/run-workflow.webp 295w,
/static/7c0fdbabe3af9a95f5eee3f8c2078e6b/5ca24/run-workflow.webp 590w,
/static/7c0fdbabe3af9a95f5eee3f8c2078e6b/2b269/run-workflow.webp 808w"
          sizes="(max-width: 590px) 100vw, 590px"
          type="image/webp"
        />
        <source
          srcset="/static/7c0fdbabe3af9a95f5eee3f8c2078e6b/12f09/run-workflow.png 148w,
/static/7c0fdbabe3af9a95f5eee3f8c2078e6b/e4a3f/run-workflow.png 295w,
/static/7c0fdbabe3af9a95f5eee3f8c2078e6b/fcda8/run-workflow.png 590w,
/static/7c0fdbabe3af9a95f5eee3f8c2078e6b/3534c/run-workflow.png 808w"
          sizes="(max-width: 590px) 100vw, 590px"
          type="image/png"
        />
        <img
          class="gatsby-resp-image-image"
          src="/static/7c0fdbabe3af9a95f5eee3f8c2078e6b/fcda8/run-workflow.png"
          alt="workflow-run"
          title="Workflow run"
          loading="lazy"
          style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        />
      </picture>
    </span></p>
<p>Every 5 minutes the scale down lambda is executed, and if you not running any job you should see the runner is terminated.</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; "
    >
      <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 10.135135135135135%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAAAsSAAALEgHS3X78AAAAfElEQVQI1yWKwQ7CIBQE+/9/Zozahir0pRRpaEugetHocSR42GR3ZxoRIYRAzpkYY+3GmJpt20gpYa1Fa12/Px9QStXt57kwU7lzjqbTE5erRQ0etz5ZHx/a28S5Hzl2hl482i6clLDsb0J+FX8s/p2wf4k5IaPh0AriIz+G+I/FpGIZMgAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <picture>
        <source
          srcset="/static/5653a9ceeeff9f6e1e86d6326130a3e9/cbe2e/aws-shutting-down.webp 148w,
/static/5653a9ceeeff9f6e1e86d6326130a3e9/3084c/aws-shutting-down.webp 295w,
/static/5653a9ceeeff9f6e1e86d6326130a3e9/5ca24/aws-shutting-down.webp 590w,
/static/5653a9ceeeff9f6e1e86d6326130a3e9/038cb/aws-shutting-down.webp 696w"
          sizes="(max-width: 590px) 100vw, 590px"
          type="image/webp"
        />
        <source
          srcset="/static/5653a9ceeeff9f6e1e86d6326130a3e9/12f09/aws-shutting-down.png 148w,
/static/5653a9ceeeff9f6e1e86d6326130a3e9/e4a3f/aws-shutting-down.png 295w,
/static/5653a9ceeeff9f6e1e86d6326130a3e9/fcda8/aws-shutting-down.png 590w,
/static/5653a9ceeeff9f6e1e86d6326130a3e9/82158/aws-shutting-down.png 696w"
          sizes="(max-width: 590px) 100vw, 590px"
          type="image/png"
        />
        <img
          class="gatsby-resp-image-image"
          src="/static/5653a9ceeeff9f6e1e86d6326130a3e9/fcda8/aws-shutting-down.png"
          alt="aws-shutting-down"
          title="aws-shutting-down"
          loading="lazy"
          style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        />
      </picture>
    </span></p>
<p>In case you build runners are not starting or registering. The best you can do is follow the trace. In the GitHub app on there is an advanced settings page where you can see the events sent to the webhook. When the event is not accepted double check the endpoint and secret. Next you can check the logs for the webhook and scale up lambda in cloud watch. Finally you can inspect the EC2 user data logging. Access via SSM (MP: should this be ssh?) is by default enabled. Just select connect to the instance and inspect the log <code class="language-text">/var/log/user_data.log</code>.</p>
<h2 id="final-thoughts" style="position:relative;"><a href="#final-thoughts" aria-label="final thoughts permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Final thoughts</h2>
<p>The abilities of GitHub self-hosted runners are already quite neat. But creating the setup as discussed requires some hacks and shortcuts. First of all it would be much easier once GitHub delivers the orchestration component, which will reduce the whole setup to only managing a bit of cloud resources. For example having runners on a Kubernetes cluster including scaling can make it a lot easier to use.</p>
<p>By delivery an API for actions GitHub gives you the option to build your own setup, the fact that we always need to have a runner registered is quite an hack. Also, the way for scaling down will not win a beauty contest but is necessary because the API does not provide an option to verify whether a runner is still active. Furthermore, the cache of the distribution is bit of a hack to work around some crazy slow downloads that we had experienced.</p>
<p>But given all those hacks we are still quite happy with this setup. Until GitHub releases the components need to orchestrate the life cycle of an action runner, we will happily use this setup.</p>
<h2 id="acknowledgements" style="position:relative;"><a href="#acknowledgements" aria-label="acknowledgements permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Acknowledgements</h2>
<p>The module discussed in this article was developed together with <a href="https://github.com/gertjanmaas">Gertjan Maas</a>.</p></div></section></article></main></div><footer class="Footer__FooterWrapper-sc-1oxe0wr-0 hFicPH"><nav><div class="footer-col"><h5 class="footer-title">040 code © 2019</h5><span class="footer-item">Built with <i></i><a class="footer-link" href="https://www.gatsbyjs.org/">Gatsby</a></span></div><div class="footer-col"><h5 class="footer-title">Blog</h5><span class="footer-item"><a class="footer-link" href="/">home</a></span><span class="footer-item"><a class="footer-link" href="/about">about</a></span></div><div class="footer-col"><h5 class="footer-title">Source</h5><span class="footer-item"><i></i><a class="footer-link" href="https://github.com/040code/">Github</a></span></div></nav></footer></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script>
  
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-97020149-1', 'auto', {});
      
      
      
      }
      </script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/2020/05/25/scaling-selfhosted-action-runners";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-2e259087cf0f884cb471.js"],"component---node-modules-gatsby-plugin-offline-app-shell-js":["/component---node-modules-gatsby-plugin-offline-app-shell-js-700ae45cacd4fc163ade.js"],"component---src-pages-404-js":["/component---src-pages-404-js-60240c15c159e413014a.js"],"component---src-templates-authors-js":["/component---src-templates-authors-js-d25abe56734e460bf2b3.js"],"component---src-templates-blog-list-template-js":["/component---src-templates-blog-list-template-js-f4d4d74a632731031b6a.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-8ba9e14f49a230982ddd.js"],"component---src-templates-page-js":["/component---src-templates-page-js-8586b4308cc4a2f267a8.js"],"component---src-templates-tags-js":["/component---src-templates-tags-js-1edd1605c6525b7ca700.js"]};/*]]>*/</script><script src="/webpack-runtime-88371d95a4ecc8f25203.js" async=""></script><script src="/styles-503b3015a8b38c118cb7.js" async=""></script><script src="/777cf710-f81af635b8297329d6d2.js" async=""></script><script src="/6b89ea6005f9c555c01b9da0decab7e9d6623b3d-acf9dd694899c0988cea.js" async=""></script><script src="/component---src-templates-blog-post-js-8ba9e14f49a230982ddd.js" async=""></script><script src="/app-2e259087cf0f884cb471.js" async=""></script><script src="/framework-d9760d5f29a556096c12.js" async=""></script><script src="/6dae301c9709e8c5899acc3516b7dd8f43382179-3a8e428404b3ed412f4e.js" async=""></script></body></html>