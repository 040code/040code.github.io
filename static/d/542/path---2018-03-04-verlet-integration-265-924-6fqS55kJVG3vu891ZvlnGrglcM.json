{"data":{"markdownRemark":{"id":"05c64e6c-4f78-593f-8822-21c019bbd107","excerpt":"IntroductionIn this post we’re going to dive into physics simulation with Clojure. The\nideas in this post were mostly inspired by this paper…","html":"<h2 id=\"introduction\"><a href=\"#introduction\" aria-label=\"introduction permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Introduction</h2>\n<p>In this post we’re going to dive into physics simulation with Clojure. The\nideas in this post were mostly inspired by <a href=\"http://graphics.cs.cmu.edu/nsp/course/15-869/2006/papers/jakobsen.htm\">this paper by Thomas\nJakobsen</a>.</p>\n<p>My motivations for working on this toy project were:</p>\n<ul>\n<li>Experimenting with a very mutable domain in a language with immutability at\nits core</li>\n<li>Having some fun by making a lot happen on screen without writing lots of code</li>\n<li>Coding using emacs &#x26; <a href=\"https://github.com/clojure-emacs/cider\">CIDER</a> (The\n<code class=\"language-text\">C</code>lojure <code class=\"language-text\">I</code>nteractive <code class=\"language-text\">D</code>evelopment <code class=\"language-text\">E</code>nvironment that <code class=\"language-text\">R</code>ocks)</li>\n</ul>\n<p>The source code can be found <a href=\"https://github.com/mmzsource/verlet\">here</a>.\nThe result:</p>\n\n          <div\n            class=\"gatsby-resp-iframe-wrapper\"\n            style=\"padding-bottom: 114.375%; position: relative; height: 0; overflow: hidden;margin-bottom: 1.0725rem\"\n          >\n            <iframe src=\"https://player.vimeo.com/video/258632942\" frameborder=\"0\" webkitallowfullscreen mozallowfullscreen allowfullscreen style=\"\n            position: absolute;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n          \"></iframe>\n          </div>\n          \n<h2 id=\"one-code-classlanguage-textmain-code-to-bind-them-all\"><a href=\"#one-code-classlanguage-textmain-code-to-bind-them-all\" aria-label=\"one code classlanguage textmain code to bind them all permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>One <code class=\"language-text\">main-</code> to bind them all</h2>\n<p>This code uses the <a href=\"https://github.com/quil/quil\">Quil library</a> to render points\nand lines. In the <code class=\"language-text\">main-</code> function, the <code class=\"language-text\">sketch</code> macro from the Quil library is\nused to bind the physics domain to the UI.</p>\n<div class=\"gatsby-highlight\" data-language=\"clojure\"><pre class=\"language-clojure\"><code class=\"language-clojure\"><span class=\"token punctuation\">(</span><span class=\"token keyword\">defn</span> -main <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">(</span>quil/sketch\n    <span class=\"token operator\">:host</span>           -main\n    <span class=\"token operator\">:title</span>          <span class=\"token string\">\"Verlet Integration\"</span>\n    <span class=\"token operator\">:size</span>           <span class=\"token punctuation\">[</span>width height<span class=\"token punctuation\">]</span>\n    <span class=\"token operator\">:setup</span>          setup\n    <span class=\"token operator\">:update</span>         update-state\n    <span class=\"token operator\">:draw</span>           draw\n    <span class=\"token operator\">:key-pressed</span>    key-pressed\n    <span class=\"token operator\">:mouse-pressed</span>  mouse-pressed\n    <span class=\"token operator\">:mouse-dragged</span>  mouse-dragged\n    <span class=\"token operator\">:mouse-released</span> mouse-released\n    <span class=\"token operator\">:features</span>       <span class=\"token punctuation\">[</span><span class=\"token operator\">:exit-on-close</span><span class=\"token punctuation\">]</span>\n    <span class=\"token operator\">:middleware</span>     <span class=\"token punctuation\">[</span>quil-mw/fun-mode<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>The sketch macro basically asks the developer to configure which ‘handler\nfunctions’ it should call when certain events occur. For instance:</p>\n<ul>\n<li>a key is pressed -> call <code class=\"language-text\">key-pressed</code></li>\n<li>the mouse is pressed -> call <code class=\"language-text\">mouse-pressed</code></li>\n<li>the state of your program has to be updated -> call <code class=\"language-text\">update-state</code></li>\n<li>it’s time to draw the new state -> call <code class=\"language-text\">draw</code></li>\n<li>etc.</li>\n</ul>\n<p>Because I configured Quil to run in functional mode <code class=\"language-text\">(quil-mw/fun-mode)</code>, Quil:</p>\n<ul>\n<li>Uses the return value from the <code class=\"language-text\">:setup</code> function as the initial <code class=\"language-text\">state</code></li>\n<li>Passes the <code class=\"language-text\">state</code> to each handler function to update it</li>\n<li>Additionally passes a keyboard- and mouse <code class=\"language-text\">event</code> argument to keyboard - and\nmouse handler functions.</li>\n</ul>\n<p>The handler function signatures therefore look like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"clojure\"><pre class=\"language-clojure\"><code class=\"language-clojure\"><span class=\"token punctuation\">(</span><span class=\"token keyword\">defn</span> draw          <span class=\"token punctuation\">[</span>state<span class=\"token punctuation\">]</span>       <span class=\"token keyword\">..</span>.<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">(</span><span class=\"token keyword\">defn</span> update-state  <span class=\"token punctuation\">[</span>state<span class=\"token punctuation\">]</span>       <span class=\"token keyword\">..</span>.<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">(</span><span class=\"token keyword\">defn</span> key-pressed   <span class=\"token punctuation\">[</span>state event<span class=\"token punctuation\">]</span> <span class=\"token keyword\">..</span>.<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">(</span><span class=\"token keyword\">defn</span> mouse-pressed <span class=\"token punctuation\">[</span>state event<span class=\"token punctuation\">]</span> <span class=\"token keyword\">..</span>.<span class=\"token punctuation\">)</span></code></pre></div>\n<h2 id=\"world-state\"><a href=\"#world-state\" aria-label=\"world state permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>World state</h2>\n<p>What does a snapshot of this world state look like? <code class=\"language-text\">key-pressed</code> gives some\nhints:</p>\n<div class=\"gatsby-highlight\" data-language=\"clojure\"><pre class=\"language-clojure\"><code class=\"language-clojure\"><span class=\"token punctuation\">(</span><span class=\"token keyword\">defn</span> key-pressed\n  <span class=\"token punctuation\">[</span>state event<span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> <span class=\"token punctuation\">[</span>raw-key   <span class=\"token punctuation\">(</span><span class=\"token operator\">:raw-key</span> event<span class=\"token punctuation\">)</span>\n        new-state <span class=\"token punctuation\">(</span><span class=\"token keyword\">cond</span>\n                   <span class=\"token punctuation\">(</span><span class=\"token keyword\">=</span> \\<span class=\"token number\">b</span> raw-key<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>load-world <span class=\"token punctuation\">(</span>load-<span class=\"token number\">a</span>-file <span class=\"token string\">\"blocks.edn\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                   <span class=\"token punctuation\">(</span><span class=\"token keyword\">=</span> \\<span class=\"token number\">c</span> raw-key<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>load-world <span class=\"token punctuation\">(</span>load-<span class=\"token number\">a</span>-file <span class=\"token string\">\"cloth.edn\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                   <span class=\"token punctuation\">(</span><span class=\"token keyword\">=</span> \\p raw-key<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>load-world <span class=\"token punctuation\">(</span>load-<span class=\"token number\">a</span>-file <span class=\"token string\">\"points.edn\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                   <span class=\"token punctuation\">(</span><span class=\"token keyword\">=</span> \\s raw-key<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>load-world <span class=\"token punctuation\">(</span>load-<span class=\"token number\">a</span>-file <span class=\"token string\">\"sticks.edn\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                   <span class=\"token punctuation\">(</span><span class=\"token keyword\">=</span> \\i raw-key<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>show-info-message<span class=\"token punctuation\">)</span>\n                   <span class=\"token punctuation\">(</span><span class=\"token keyword\">=</span> \\q raw-key<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>quil/exit<span class=\"token punctuation\">)</span>\n                   <span class=\"token operator\">:else</span> state<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n    new-state<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>So on pressing a key, a certain world is loaded. Let’s look into the ‘sticks’\nworld:</p>\n<div class=\"gatsby-highlight\" data-language=\"clojure\"><pre class=\"language-clojure\"><code class=\"language-clojure\"><span class=\"token punctuation\">{</span><span class=\"token operator\">:points</span> <span class=\"token punctuation\">{</span><span class=\"token operator\">:p0</span> <span class=\"token punctuation\">{</span><span class=\"token operator\">:x</span>  <span class=\"token number\">10</span> <span class=\"token operator\">:y</span>   <span class=\"token number\">1</span> <span class=\"token operator\">:oldx</span>   <span class=\"token number\">0</span> <span class=\"token operator\">:oldy</span>   <span class=\"token number\">0</span><span class=\"token punctuation\">}</span>\n          <span class=\"token operator\">:p1</span> <span class=\"token punctuation\">{</span><span class=\"token operator\">:x</span> <span class=\"token number\">100</span> <span class=\"token operator\">:y</span> <span class=\"token number\">100</span> <span class=\"token operator\">:oldx</span> <span class=\"token number\">100</span> <span class=\"token operator\">:oldy</span> <span class=\"token number\">100</span><span class=\"token punctuation\">}</span>\n          <span class=\"token operator\">:p2</span> <span class=\"token punctuation\">{</span><span class=\"token operator\">:x</span>   <span class=\"token number\">0</span> <span class=\"token operator\">:y</span> <span class=\"token number\">500</span> <span class=\"token operator\">:oldx</span>   <span class=\"token number\">0</span> <span class=\"token operator\">:oldy</span> <span class=\"token number\">525</span><span class=\"token punctuation\">}</span>\n          <span class=\"token operator\">:p3</span> <span class=\"token punctuation\">{</span><span class=\"token operator\">:x</span>  <span class=\"token number\">25</span> <span class=\"token operator\">:y</span> <span class=\"token number\">475</span> <span class=\"token operator\">:oldx</span>   <span class=\"token number\">0</span> <span class=\"token operator\">:oldy</span> <span class=\"token number\">525</span><span class=\"token punctuation\">}</span>\n          <span class=\"token operator\">:p4</span> <span class=\"token punctuation\">{</span><span class=\"token operator\">:x</span> <span class=\"token number\">250</span> <span class=\"token operator\">:y</span> <span class=\"token number\">200</span> <span class=\"token operator\">:oldx</span> <span class=\"token number\">250</span> <span class=\"token operator\">:oldy</span> <span class=\"token number\">200</span> <span class=\"token operator\">:pinned</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">}</span>\n          <span class=\"token operator\">:p5</span> <span class=\"token punctuation\">{</span><span class=\"token operator\">:x</span> <span class=\"token number\">350</span> <span class=\"token operator\">:y</span> <span class=\"token number\">100</span> <span class=\"token operator\">:oldx</span> <span class=\"token number\">350</span> <span class=\"token operator\">:oldy</span> <span class=\"token number\">100</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n <span class=\"token operator\">:sticks</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span><span class=\"token operator\">:links</span>  <span class=\"token punctuation\">[</span><span class=\"token operator\">:p0</span> <span class=\"token operator\">:p1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">:length</span> <span class=\"token number\">138</span><span class=\"token punctuation\">}</span>\n          <span class=\"token punctuation\">{</span><span class=\"token operator\">:links</span>  <span class=\"token punctuation\">[</span><span class=\"token operator\">:p2</span> <span class=\"token operator\">:p3</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">:length</span>  <span class=\"token number\">40</span><span class=\"token punctuation\">}</span>\n          <span class=\"token punctuation\">{</span><span class=\"token operator\">:links</span>  <span class=\"token punctuation\">[</span><span class=\"token operator\">:p4</span> <span class=\"token operator\">:p5</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">:length</span> <span class=\"token number\">140</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span></code></pre></div>\n<p>Nothing special here. Just a map containing <code class=\"language-text\">:points</code> and <code class=\"language-text\">:sticks</code>. We’ll dive\ninto the particulars of points and sticks soon.</p>\n<h2 id=\"physics-simulation\"><a href=\"#physics-simulation\" aria-label=\"physics simulation permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Physics Simulation</h2>\n<p>This physics simulation deals with Points, and Sticks connecting Points. The\nPoints are the things that seem to have direction and speed, are influenced by\ngravity and lose speed because of friction or because of bouncing against world\nborders. The Sticks try to keep their 2 Points apart according to the configured\nStick length. The simulation loop boils down to:</p>\n<ul>\n<li>Update Points</li>\n<li>Apply Stick constraints</li>\n<li>Apply world constraints</li>\n</ul>\n<p>In code:</p>\n<div class=\"gatsby-highlight\" data-language=\"clojure\"><pre class=\"language-clojure\"><code class=\"language-clojure\"><span class=\"token punctuation\">(</span><span class=\"token keyword\">defn</span> update-state\n  <span class=\"token punctuation\">[</span>state<span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">(</span><span class=\"token keyword\">->></span> state\n       <span class=\"token punctuation\">(</span>update-points<span class=\"token punctuation\">)</span>\n       <span class=\"token punctuation\">(</span>apply-stick-constraints<span class=\"token punctuation\">)</span>\n       <span class=\"token punctuation\">(</span>apply-world-constraints<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>This code can be read like this: ‘with <code class=\"language-text\">state</code>, first <code class=\"language-text\">update-points</code>, then\n<code class=\"language-text\">apply-stick-constraints</code>, and finally <code class=\"language-text\">apply-world-constrains</code>‘.</p>\n<h3 id=\"points\"><a href=\"#points\" aria-label=\"points permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Points</h3>\n<p>Points are the main abstraction in this code. I decided to use a record to name\nthem:</p>\n<div class=\"gatsby-highlight\" data-language=\"clojure\"><pre class=\"language-clojure\"><code class=\"language-clojure\"><span class=\"token punctuation\">(</span><span class=\"token keyword\">defrecord</span> Point <span class=\"token punctuation\">[</span>x y oldx oldy pinned<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>A Point stores its current coordinates and the coordinates it had in the\nprevious world state. On top of that it has a <code class=\"language-text\">pinned</code> property which indicates\nif a Point is pinned in space and - as a result - stays on the same coordinate.\nA pinned Point can be unpinned by clicking it with the mouse pointer.</p>\n<p>The <code class=\"language-text\">update-point</code> function calculates the velocity of the Point and adds some\ngravity in the mix:</p>\n<div class=\"gatsby-highlight\" data-language=\"clojure\"><pre class=\"language-clojure\"><code class=\"language-clojure\"><span class=\"token punctuation\">(</span><span class=\"token keyword\">defn</span> update-point\n  <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span><span class=\"token operator\">:keys</span> <span class=\"token punctuation\">[</span>x y oldx oldy pinned<span class=\"token punctuation\">]</span> <span class=\"token operator\">:as</span> point<span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">(</span><span class=\"token keyword\">if</span> pinned\n    point\n    <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> <span class=\"token punctuation\">[</span>vx <span class=\"token punctuation\">(</span>velocity x oldx<span class=\"token punctuation\">)</span>\n          vy <span class=\"token punctuation\">(</span>velocity y oldy<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n      <span class=\"token punctuation\">(</span><span class=\"token keyword\">-</span>>Point <span class=\"token punctuation\">(</span><span class=\"token keyword\">+</span> x vx<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">+</span> y vy gravity<span class=\"token punctuation\">)</span> x y pinned<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Reading superficially, this code says: if the Point is pinned then return the\nsame Point. Otherwise, calculate it’s velocity (based on the current - and\nprevious x &#x26; y coordinates), add some gravity in the y direction and return the\nnewly calculated Point.</p>\n<p>The function uses\n<a href=\"https://gist.github.com/john2x/e1dca953548bfdfb9844\">destructuring</a> to name all\nthe arguments of the incoming Point. With destructuring, you can bind the\nvalues in a data structure without explicitly querying the data structure. So\ninstead of getting each and every value out of Point and binding it to a ‘new’\nname…</p>\n<div class=\"gatsby-highlight\" data-language=\"clojure\"><pre class=\"language-clojure\"><code class=\"language-clojure\"><span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> <span class=\"token punctuation\">[</span>x      <span class=\"token punctuation\">(</span><span class=\"token operator\">:x</span>      point<span class=\"token punctuation\">)</span>\n      y      <span class=\"token punctuation\">(</span><span class=\"token operator\">:y</span>      point<span class=\"token punctuation\">)</span>\n      oldx   <span class=\"token punctuation\">(</span><span class=\"token operator\">:oldx</span>   point<span class=\"token punctuation\">)</span>\n      oldy   <span class=\"token punctuation\">(</span><span class=\"token operator\">:oldy</span>   point<span class=\"token punctuation\">)</span>\n      pinned <span class=\"token punctuation\">(</span><span class=\"token operator\">:pinned</span> point<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n  <span class=\"token keyword\">..</span>.<span class=\"token punctuation\">)</span></code></pre></div>\n<p>… you can very effectively tell the function that it will receive a map <code class=\"language-text\">{}</code>\nwith keys <code class=\"language-text\">x y oldx oldy pinned</code> and that this function should have those\nvariables available under the same name:</p>\n<div class=\"gatsby-highlight\" data-language=\"clojure\"><pre class=\"language-clojure\"><code class=\"language-clojure\"><span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span><span class=\"token operator\">:keys</span> <span class=\"token punctuation\">[</span>x y oldx oldy pinned<span class=\"token punctuation\">]</span> <span class=\"token operator\">:as</span> point<span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span></code></pre></div>\n<p>The code in my repository has some additional type hints, because I wanted the\nsimulation to run smooth on my laptop and wanted to learn a bit more about type\nhinting and compiler optimizations.</p>\n<p>And that’s it with regard to Points. In a couple of lines of code Points are\nalready moving and reacting to gravity in the simulation.</p>\n<h3 id=\"world-constraints\"><a href=\"#world-constraints\" aria-label=\"world constraints permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>World constraints</h3>\n<p>It’s time for Points to meet the harsh reality of life. Walls are harder than\nPoints and therefore Points should bounce off of them:</p>\n<div class=\"gatsby-highlight\" data-language=\"clojure\"><pre class=\"language-clojure\"><code class=\"language-clojure\"><span class=\"token punctuation\">(</span><span class=\"token keyword\">defn</span> hit-floor?       <span class=\"token punctuation\">[</span>y<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">></span> y height<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">(</span><span class=\"token keyword\">defn</span> hit-ceiling?     <span class=\"token punctuation\">[</span>y<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">&lt;</span> y <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">(</span><span class=\"token keyword\">defn</span> hit-left-wall?   <span class=\"token punctuation\">[</span>x<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">&lt;</span> x <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">(</span><span class=\"token keyword\">defn</span> hit-right-wall?  <span class=\"token punctuation\">[</span>x<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">></span> x width<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token punctuation\">(</span><span class=\"token keyword\">defn</span> apply-world-constraint\n  <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span><span class=\"token operator\">:keys</span> <span class=\"token punctuation\">[</span>x y oldx oldy pinned<span class=\"token punctuation\">]</span> <span class=\"token operator\">:as</span> point<span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> <span class=\"token punctuation\">[</span>vxb <span class=\"token punctuation\">(</span><span class=\"token keyword\">*</span> <span class=\"token punctuation\">(</span>velocity x oldx<span class=\"token punctuation\">)</span> bounce<span class=\"token punctuation\">)</span>\n        vyb <span class=\"token punctuation\">(</span><span class=\"token keyword\">*</span> <span class=\"token punctuation\">(</span>velocity y oldy<span class=\"token punctuation\">)</span> bounce<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">(</span><span class=\"token keyword\">cond</span>\n      <span class=\"token punctuation\">(</span>hit-ceiling?    y<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> <span class=\"token punctuation\">[</span>miry <span class=\"token punctuation\">(</span><span class=\"token keyword\">-</span> oldy<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n                             <span class=\"token punctuation\">(</span><span class=\"token keyword\">-</span>>Point <span class=\"token punctuation\">(</span><span class=\"token keyword\">+</span> oldx vxb<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">+</span> miry <span class=\"token punctuation\">(</span><span class=\"token keyword\">-</span> vyb<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> oldx miry pinned<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">(</span>hit-floor?      y<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> <span class=\"token punctuation\">[</span>miry <span class=\"token punctuation\">(</span><span class=\"token keyword\">+</span> height height <span class=\"token punctuation\">(</span><span class=\"token keyword\">-</span> oldy<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n                             <span class=\"token punctuation\">(</span><span class=\"token keyword\">-</span>>Point  <span class=\"token punctuation\">(</span><span class=\"token keyword\">+</span> oldx vxb<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">-</span> miry vyb<span class=\"token punctuation\">)</span> oldx miry pinned<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">(</span>hit-left-wall?  x<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> <span class=\"token punctuation\">[</span>mirx <span class=\"token punctuation\">(</span><span class=\"token keyword\">-</span> oldx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n                             <span class=\"token punctuation\">(</span><span class=\"token keyword\">-</span>>Point <span class=\"token punctuation\">(</span><span class=\"token keyword\">+</span> mirx <span class=\"token punctuation\">(</span><span class=\"token keyword\">-</span> vxb<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">+</span> oldy vyb<span class=\"token punctuation\">)</span> mirx oldy pinned<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">(</span>hit-right-wall? x<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> <span class=\"token punctuation\">[</span>mirx <span class=\"token punctuation\">(</span><span class=\"token keyword\">+</span> width width <span class=\"token punctuation\">(</span><span class=\"token keyword\">-</span> oldx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n                             <span class=\"token punctuation\">(</span><span class=\"token keyword\">-</span>>Point <span class=\"token punctuation\">(</span><span class=\"token keyword\">-</span> mirx vxb<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">+</span> oldy vyb<span class=\"token punctuation\">)</span> mirx oldy pinned<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n      <span class=\"token comment\">;; else: free movement</span>\n      <span class=\"token operator\">:else</span> point<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>To explain what happens here, a picture might help.</p>\n<a href=\"#\">\n    <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 366px;\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 83.33333333333334%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAAsSAAALEgHS3X78AAAB/ElEQVQ4y41UTW/aQBD1303/SVqpOXFsLkhtOXBBSIQeUKFVP6RUnCCIEBA24BpjvkEuCF78Joy7pm5aS09e74zfzJuZXWs2m2E6nf4Tph/XislkguFwKPtBEMB6ckg6nhOkEfPn9XqN1t0d3lxfYxWtuW8lHWf/RUqsViv0ej28uLiAbTuYz+fiby2XS4lGmFJMYhP8UWUOBgO0Wq2YTAir1So8b4z9fh85Bqm1Mtee5wmZ7/tYLBYi+8n/RMi08/k8isUiwvCXRDfl8s0MuCaR67p/KDCTsJhZpVJBqVQS2SSkg5aATiTRrJRcQT9TkTQlDEPsdjuMxz5Go1H0HkvR6cBvlUeQUGHuxYSMTtn9fl+KTLTbbdTrdTSbTTiOI6Ddtu1U0K4NsyiRhWYWzIxGEjKIvmlTu8L85johebPZiERm1Ol0xMBxYkTWjqT8kfK0GTIqRtO03tbhcEA2m0Umk4lHwOweSbhuNBoSUAkYgIkQv2c4kvzj9hY35Q/odrvx8TkfC3NsHh66cKI68/n+7Qs+ff6KXTQp8WCTyHV/JiKlHTstA2vORl5dvcb7d29xf99B7WMV/ulQyNHTWyMInr9d9Hu73aJQKKBWq+HVy0uUb8pCmLgc0kj+dttQyfF4lBLkcjkJEDfl/Kw+dzGYflTE2vJAiO20/whuQ/HZDumZpwAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;\"></span>\n    <picture>\n        <source srcset=\"/static/011bd2ac37ea96e5e9f8fb6aace495b0/cc182/world-constraints.webp 148w,\n/static/011bd2ac37ea96e5e9f8fb6aace495b0/f7e40/world-constraints.webp 295w,\n/static/011bd2ac37ea96e5e9f8fb6aace495b0/26f56/world-constraints.webp 366w\" sizes=\"(max-width: 366px) 100vw, 366px\" type=\"image/webp\">\n        <source srcset=\"/static/011bd2ac37ea96e5e9f8fb6aace495b0/cf440/world-constraints.png 148w,\n/static/011bd2ac37ea96e5e9f8fb6aace495b0/d2d38/world-constraints.png 295w,\n/static/011bd2ac37ea96e5e9f8fb6aace495b0/a038c/world-constraints.png 366w\" sizes=\"(max-width: 366px) 100vw, 366px\" type=\"image/png\">\n        <img class=\"gatsby-resp-image-image\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\" src=\"/static/011bd2ac37ea96e5e9f8fb6aace495b0/a038c/world-constraints.png\" alt=\"apply world constraints diagram\" title>\n      </picture>\n  </span>\n</a>\n<p>Imagine a Point moved from A to B in the last Point update. This means a Point\nrecord is persisted with its <code class=\"language-text\">x</code> and <code class=\"language-text\">y</code> being the coordinates of B and <code class=\"language-text\">oldx</code>\nand <code class=\"language-text\">oldy</code> being the coordinates of A. If a wall line crossed the imaginary line\nA-B, the Point history should be rewritten. In essence, line A-B is mirrored in\nthe wall it hits, giving rise to another imaginary line C-D where C mirrors A\nand D mirrors B. The <code class=\"language-text\">miry</code> (mirror-y) and <code class=\"language-text\">mirx</code> (mirror-x) variables in the\ncode contain C coordinates mirroring A coordinates.</p>\n<p>The simulation will take a little velocity loss into account when bouncing at\nwalls. Therefore, D’ is calculated by using the x and y velocities (vx and vy)\nmultiplied by a bounce factor (leading to the <code class=\"language-text\">vxb</code> and <code class=\"language-text\">vyb</code> variables in the\ncode).</p>\n<p>When the world state is drawn, the Point will fly off in exactly the right\ndirection. Additionally, because of the history rewrite, subsequent Point\nupdates will keep moving the Point in the right direction.</p>\n<p>The picture shows the situation when hitting the ceiling. Hitting the floor and\nthe walls works similar. And that’s all the math and code you need to simulate\nPoints moving in a bounded space. Now let’s add Sticks to the simulation.</p>\n<h3 id=\"stick-constraints\"><a href=\"#stick-constraints\" aria-label=\"stick constraints permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Stick constraints</h3>\n<p>Not only walls are restricting Points from free movement; Sticks also constrain\nthem. A Stick connects 2 Points and has a configured length. The goal of the\nStick constraint is to move the Points at the end of the Stick to the configured\nlength of the Stick.</p>\n<a href=\"#\">\n    <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 44.18316831683168%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsSAAALEgHS3X78AAABB0lEQVQoz3WSV47DMAxEc//jGQZc5LJx7+0CjB+zNLzB5mNgURGHT6M81nWVeZ5lHEeZpukSdd/30ratahgG4eyyLNf3U5x52I/WhLquU7MsyyRJElVRFH8MP8U+EGoIUV3XSmq0VVXpPsaI9TcyG6KE+75L0zTieZ4amRl1WZaSpqm4kxDq4zi0cdu2f6WGENkUNu/4rKEbR2Lo1dTU3tYIM72yc06boLQMqYmAA5CSJcpzlIuLnZKz9/x5/mZcaixXhjTbY9iLv6dOmuv9H8AN5lttMVyvTANG0Pi+L0EQyHSaQhFFkRJEUShxHEsYhu9cz5uZLJ7L0Ex5IMQ06m/hf8o8MH4BFASfEpTgswAAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;\"></span>\n    <picture>\n        <source srcset=\"/static/6dd99e14345c35fe8d067418c788338b/cc182/stick-constraints.webp 148w,\n/static/6dd99e14345c35fe8d067418c788338b/f7e40/stick-constraints.webp 295w,\n/static/6dd99e14345c35fe8d067418c788338b/1a2f4/stick-constraints.webp 590w,\n/static/6dd99e14345c35fe8d067418c788338b/37d0a/stick-constraints.webp 808w\" sizes=\"(max-width: 590px) 100vw, 590px\" type=\"image/webp\">\n        <source srcset=\"/static/6dd99e14345c35fe8d067418c788338b/cf440/stick-constraints.png 148w,\n/static/6dd99e14345c35fe8d067418c788338b/d2d38/stick-constraints.png 295w,\n/static/6dd99e14345c35fe8d067418c788338b/b9e4f/stick-constraints.png 590w,\n/static/6dd99e14345c35fe8d067418c788338b/4fa70/stick-constraints.png 808w\" sizes=\"(max-width: 590px) 100vw, 590px\" type=\"image/png\">\n        <img class=\"gatsby-resp-image-image\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\" src=\"/static/6dd99e14345c35fe8d067418c788338b/b9e4f/stick-constraints.png\" alt=\"apply stick constraints diagram\" title>\n      </picture>\n  </span>\n</a>\n<p>Instead of trying to calculate the solution that satisfies all Stick constraints\nat once, this code simply looks at one Stick at a time and ‘solves’ the\nconstraint problem by repeatedly solving Stick constraints in isolation.</p>\n<div class=\"gatsby-highlight\" data-language=\"clojure\"><pre class=\"language-clojure\"><code class=\"language-clojure\"><span class=\"token punctuation\">(</span><span class=\"token keyword\">defn</span> apply-stick-constraint\n  <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span>length <span class=\"token operator\">:length</span> <span class=\"token operator\">:as</span> stick<span class=\"token punctuation\">}</span>\n   <span class=\"token punctuation\">{</span>p0x <span class=\"token operator\">:x</span> p0y <span class=\"token operator\">:y</span> oldp0x <span class=\"token operator\">:oldx</span> oldp0y <span class=\"token operator\">:oldy</span> pinp0 <span class=\"token operator\">:pinned</span> <span class=\"token operator\">:as</span> p0<span class=\"token punctuation\">}</span>\n   <span class=\"token punctuation\">{</span>p1x <span class=\"token operator\">:x</span> p1y <span class=\"token operator\">:y</span> oldp1x <span class=\"token operator\">:oldx</span> oldp1y <span class=\"token operator\">:oldy</span> pinp1 <span class=\"token operator\">:pinned</span> <span class=\"token operator\">:as</span> p1<span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span><span class=\"token operator\">:keys</span> <span class=\"token punctuation\">[</span>dx dy distance<span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span> <span class=\"token punctuation\">(</span>distance-map p0 p1<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">difference</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">-</span> length distance<span class=\"token punctuation\">)</span>\n        fraction   <span class=\"token punctuation\">(</span><span class=\"token keyword\">/</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">/</span> <span class=\"token keyword\">difference</span> distance<span class=\"token punctuation\">)</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\n        offsetX    <span class=\"token punctuation\">(</span><span class=\"token keyword\">*</span> dx fraction<span class=\"token punctuation\">)</span>\n        offsetY    <span class=\"token punctuation\">(</span><span class=\"token keyword\">*</span> dy fraction<span class=\"token punctuation\">)</span>\n        p0-new     <span class=\"token punctuation\">(</span><span class=\"token keyword\">-</span>>Point <span class=\"token punctuation\">(</span><span class=\"token keyword\">-</span> p0x offsetX<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">-</span> p0y offsetY<span class=\"token punctuation\">)</span> oldp0x oldp0y pinp0<span class=\"token punctuation\">)</span>\n        p1-new     <span class=\"token punctuation\">(</span><span class=\"token keyword\">-</span>>Point <span class=\"token punctuation\">(</span><span class=\"token keyword\">+</span> p1x offsetX<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">+</span> p1y offsetY<span class=\"token punctuation\">)</span> oldp1x oldp1y pinp1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">if</span> pinp0 p0 p0-new<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">if</span> pinp1 p1 p1-new<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p><code class=\"language-text\">apply-stick-constraint</code> takes a Stick and 2 Points (P0 and P1) as arguments.\nThese arguments are heavily destructured. To understand what happens precisely,\nthe next picture might be helpful:</p>\n<a href=\"#\">\n    <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 468px;\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 88.24786324786325%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAAAsSAAALEgHS3X78AAACgUlEQVQ4y3VU2XLaQBDk/z/AeXU+wSlcrrxQkJjDwgHHQHFDuBFCKxBHHjvdi0SJIw9TWq1me7tnepQyxiBg+KsVms0mhoMBut0u+r0eegzf9xEEAZSXjOSe1ooVMVL2ADe94RBfHx9R+fWOt5KD93IZjlOG666w2WxuAK/BFJ7nIWW2WwQKoofrtd08HA7Y7/c2YibJg3Ek942JGO6fnhDmfsAsFjDLJdYEnM/nWBNc8T+p15L1tICB61p2CgEGlOdqzSQxlNwwDG0kpd8DPElmkuq4YCPE0ucFfwn0/eUFz+lnFAtF5At5ZDIZ9NkwAV9KNZc1VMJut8OQTfG5Ychuz0s+Pz5QLBat/NFohPF4bCXdY3bR5UG/j1arxUNj+ErUx4j1kiWYTCb2wq0ax2/aV9zrtAVs0Xv1Wg1/CGiiRB0WM0lYsAzT6dTWM66l1sqJPXojWQmSFd+s4s9mMwuqtQzebrdtWfpU1Ol0bP61Py1DSfRpjxmTglhyRF+HxLDRaODLwwNqVFKtVPCaz+P356dleQso2qS6kX0ElqiLGCi2Kj6/e7xY9ZQiPe/WMEynEf58pQfdEzubcGVgXcpkjeFS1uJ7bPpkg04MmRCwm0aWuTMFJgIUQ43onPlidzwezw3Su+I0KbKDDtAeMnkQ/X1knXMH9U5A+fRAkG8c12w2i2q1ilw2h7LjoMABUElSZ2mSJaZ6520eO2zlRSPlssNiGpLAWy5nf3XyqByg7itOoxdLE6PlApsau8cpMf0B6vW6tYuYzOmCHfc37PJRsvlHUpdjb2p9knxuRGCbEZYdhJSzH0/Q1k+220Ot3sCajHelEkKGLY9KddVlMfwHnW86ADx5H2oAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;\"></span>\n    <picture>\n        <source srcset=\"/static/da387eeec0b28916536105175d5acc1b/cc182/stick-math.webp 148w,\n/static/da387eeec0b28916536105175d5acc1b/f7e40/stick-math.webp 295w,\n/static/da387eeec0b28916536105175d5acc1b/a57bd/stick-math.webp 468w\" sizes=\"(max-width: 468px) 100vw, 468px\" type=\"image/webp\">\n        <source srcset=\"/static/da387eeec0b28916536105175d5acc1b/cf440/stick-math.png 148w,\n/static/da387eeec0b28916536105175d5acc1b/d2d38/stick-math.png 295w,\n/static/da387eeec0b28916536105175d5acc1b/bb106/stick-math.png 468w\" sizes=\"(max-width: 468px) 100vw, 468px\" type=\"image/png\">\n        <img class=\"gatsby-resp-image-image\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\" src=\"/static/da387eeec0b28916536105175d5acc1b/bb106/stick-math.png\" alt=\"stick math diagram\" title>\n      </picture>\n  </span>\n</a>\n<p>Let P0 and P1 be two Points with a Stick S between them. P0 and P1 have already\nbeen updated by the <code class=\"language-text\">update-point</code> function and their new (x,y) coordinates are\n(40,50) and (70,90) respectively. This means:</p>\n<ul>\n<li>dx = 30</li>\n<li>dy = 40</li>\n<li>distance = 50</li>\n</ul>\n<p>Since the Stick between P0 and P1 was configured to have a <code class=\"language-text\">length</code> of 150, and\nwe want P0 and P1 to be adjusted by the same amount, P0 <em>should</em> be located at\nPoint S0 (10,10) and P1 <em>should</em> be located at Point S1 (100,130). This is\nexactly what <code class=\"language-text\">apply-stick-constraint</code> achieves:</p>\n<ul>\n<li>The <code class=\"language-text\">difference</code> in the configured <code class=\"language-text\">length</code> of the Stick and the <code class=\"language-text\">distance</code> of P0\nand P1 is 100</li>\n<li>The <code class=\"language-text\">fraction</code> of the <code class=\"language-text\">distance</code> between P0 and P1 that needs to be added to\nP0 AND to P1 is 1. So by extending the <code class=\"language-text\">distance</code> P0 and P1 with exactly 50\n(<code class=\"language-text\">distance</code> times <code class=\"language-text\">fraction</code>) in both directions, we’ll solve the Stick\nconstraint.</li>\n<li>This is done by using <code class=\"language-text\">offsetX</code> on P0x and P1x and using <code class=\"language-text\">offsetY</code> on P0y and\nP1y</li>\n</ul>\n<p>Conceptually a scaled helper triangle is used to move P0 and an identical scaled\nhelper triangle is used to move P1. The scale of this triangle is determined by\nthe <code class=\"language-text\">fraction</code> which in this case is 1. These triangles are depicted in red.</p>\n<p>Each Stick in the world is updated before a new world frame is drawn. It is very\nwell possible that the neatly placed P0 and P1 are moved to different\ncoordinates by another Stick constraint before the complete update is over. This\nsometimes results in wiggly behavior, although in most cases, the simulation\nis perceived to behave naturally.</p>\n<h2 id=\"drawing\"><a href=\"#drawing\" aria-label=\"drawing permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Drawing</h2>\n<p>Finally, the Points and Sticks have to be drawn on screen:</p>\n<div class=\"gatsby-highlight\" data-language=\"clojure\"><pre class=\"language-clojure\"><code class=\"language-clojure\"><span class=\"token punctuation\">(</span><span class=\"token keyword\">defn</span> draw\n  <span class=\"token punctuation\">[</span>state<span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">(</span>quil/background <span class=\"token number\">255</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">(</span><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">:info-message</span> state<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">(</span>quil/text info-message <span class=\"token number\">20</span> <span class=\"token number\">20</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">(</span><span class=\"token keyword\">do</span>\n      <span class=\"token punctuation\">(</span><span class=\"token keyword\">doseq</span> <span class=\"token punctuation\">[</span>point <span class=\"token punctuation\">(</span><span class=\"token keyword\">vals</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">:points</span> state<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n        <span class=\"token punctuation\">(</span>quil/ellipse <span class=\"token punctuation\">(</span><span class=\"token operator\">:x</span> point<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">:y</span> point<span class=\"token punctuation\">)</span> <span class=\"token number\">7</span> <span class=\"token number\">7</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">(</span><span class=\"token keyword\">doseq</span> <span class=\"token punctuation\">[</span>stick <span class=\"token punctuation\">(</span><span class=\"token operator\">:sticks</span> state<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n        <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> <span class=\"token punctuation\">[</span>points <span class=\"token punctuation\">(</span><span class=\"token operator\">:points</span> state<span class=\"token punctuation\">)</span>\n              p0     <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">first</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">:links</span> stick<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> points<span class=\"token punctuation\">)</span>\n              p1     <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">last</span>  <span class=\"token punctuation\">(</span><span class=\"token operator\">:links</span> stick<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> points<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n          <span class=\"token punctuation\">(</span>quil/line <span class=\"token punctuation\">(</span><span class=\"token operator\">:x</span> p0<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">:y</span> p0<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">:x</span> p1<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">:y</span> p1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Start by clearing the screen. If there is an <code class=\"language-text\">:info-message</code> entry in the\n<code class=\"language-text\">state</code>, draw the <code class=\"language-text\">info-message</code>. Otherwise draw all Points in <code class=\"language-text\">state</code> as a\nquil/ellipse and draw all Sticks as a quil/line. And that’s all folks!</p>\n<h2 id=\"conclusion\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p>As always, it was a pleasure working with Clojure. It turns out to be easy to\nwork in a very mutable domain with mostly pure functions, also thanks to the\nexcellent Quil library.</p>\n<p>My current version of <a href=\"https://github.com/AlDanial/cloc\">cloc</a> tells me that\ncore.clj is 230 lines long, but it counts the function documentation as code.\nTherefore, I ran a new <code class=\"language-text\">cloc</code> command without the doc strings. It then counts\n159 lines of clojure, approximately half of which are dedicated to UI\ninteraction and the other half to physics simulation. Not bad at all!</p>\n<p>I’m glad I decided to ‘bite the bullet’ and learn Emacs and CIDER. I now use\nEmacs for all my Clojure(script) development. In addition, I use Emacs for most\nof my text editing these days including writing and planning.</p>\n<p>I’d like to thank Michiel Borkent a.k.a.\n<a href=\"https://twitter.com/borkdude\">@borkdude</a> for reviewing an earlier version of\nthe code and giving me very helpful feedback. Faults and not-so-idiomatic\nClojure code remaining are my own.</p>\n<p>Please share your comments, suggestions and thoughts about this blog post on\n<a href=\"https://twitter.com/mmz_\">twitter.com/mmz_</a>. Thanks for reading and Happy\nCoding!</p>\n<h2 id=\"links\"><a href=\"#links\" aria-label=\"links permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Links</h2>\n<ul>\n<li><a href=\"http://graphics.cs.cmu.edu/nsp/course/15-869/2006/papers/jakobsen.htm\">Verlet integration\npaper</a></li>\n<li><a href=\"https://github.com/mmzsource/verlet\">My verlet integration code in clojure</a></li>\n<li><a href=\"https://github.com/quil/quil\">Quil library</a></li>\n<li><a href=\"https://github.com/clojure-emacs/cider\">Emacs CIDER plugin</a></li>\n<li><a href=\"https://github.com/AlDanial/cloc\">Cloc - counting lines of code</a></li>\n</ul>","frontmatter":{"title":"Verlet Integration","subtitle":"Physics Simulation in Clojure","date":"2018-03-04","slug":"2018/03/04/verlet-integration","language":null,"tags":["clojure","functional"],"authors":["maarten"],"comments":null,"cover":{"publicURL":"/static/ehv-noord-d6ba9047bcc3ffc35364d14fb5af82f9.jpg"},"coverLink":null,"coverDescription":null,"imageTw":{"publicURL":"/static/2018-03-04-verlet-integration-tw-820fb699d279aa3f0001635eaa2555d7.png"},"imageFb":{"publicURL":"/static/2018-03-04-verlet-integration-fb-1075812cbe4a640595cd6eb9bf2dcc6b.png"},"asciinema":null}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"2018/03/04/verlet-integration","previous":{"frontmatter":{"title":"Service Discovery on AWS","slug":"2018/02/14/service-discovery-on-aws","type":"post","tags":["aws","spring","docker"],"authors":["niek"]}},"next":{"frontmatter":{"title":"Immutable Infrastructure","slug":"2018/05/26/immutable-infrastructure-taipei","type":"post","tags":["terraform","aws","docker","microservices"],"authors":["niek"]}}}}