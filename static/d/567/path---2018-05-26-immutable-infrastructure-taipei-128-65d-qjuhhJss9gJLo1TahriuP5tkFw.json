{"data":{"markdownRemark":{"id":"d2ccc2a8-e659-5164-b39a-9f67aa18bade","excerpt":"The Docker slogan ‘Build, Ship, and Run’ advertises easy set up of immutable software builds, but it is not always that easy. Setting up…","html":"<p>The Docker slogan ‘Build, Ship, and Run’ advertises easy set up of immutable software builds, but it is not always that easy. Setting up immutable builds with Docker is pretty straight forward and shipping is just a matter of pushing the image to a repository. The next step is building the cloud infrastructure to run the containers. In the talk at\nthe Cloud Native Meetup in Taipei I have shown how to create an immutable infrastructure on AWS with Terraform. The example belows shows how you can run your micro services in docker containers on AWS.</p>\n<p>In this talk I briefly touch upon building immutable software. But the main focus of the talk will be on creating an immutable infrastructure. In this talk I will show you how to create an immutable infrastructure on AWS with Terraform. I will use a real world example to explain and show live how easy you can get micro services live on AWS and continuously apply changes to the same cloud environment..</p>\n<h2 id=\"slides\"><a href=\"#slides\" aria-label=\"slides permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Slides</h2>\n<p>Below the slides that I used for the talk, the slides are available as well on\n<a href=\"https://immutable-infrastructure.gitlab.io/taipei-2018/\">GitLab</a>. You can easy navigate through the slides with the spacebar.</p>\n<div style=\"position:relative; width:100%; height:0px; padding-bottom:56.25%;\">\n    <iframe style=\"position:absolute; left:0; top:0; width:100%; height:100%\"\n        src=\"https://immutable-infrastructure.gitlab.io/taipei-2018/\">\n    </iframe>\n</div>\n<p>To get started with Terraform the best starting points are:</p>\n<ul>\n<li><a href=\"https://www.terraform.io/intro/examples/\">Terraform.io</a></li>\n<li><a href=\"https://github.com/npalm/tf-helloworld-demo\">Hello World example</a></li>\n</ul>\n<h2 id=\"examples\"><a href=\"#examples\" aria-label=\"examples permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Examples</h2>\n<h3 id=\"hello-world\"><a href=\"#hello-world\" aria-label=\"hello world permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Hello World</h3>\n<p>During the talk, I demonstrated a hello world example, see the link above. This examples shows some basics of terraform by creating a ec2 instance and security group to server a simple web application. The example only works in the AWS region <code class=\"language-text\">eu-west-1</code> since the AMI used is only available in this region.</p>\n<h3 id=\"ecs-demo\"><a href=\"#ecs-demo\" aria-label=\"ecs demo permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ECS demo</h3>\n<p>The second example I have shown, is creating an immutable infrastructure to server docker containers. The picture below descibes briefly the enviroment that will be cretaed.</p>\n<a href=\"#\">\n    <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 63.55382619974059%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsSAAALEgHS3X78AAACFElEQVQ4y5VTvYsaQRRfZ2Znb9eP7O7dhUQ0RokIAbUJiGKKWKWxskgTLJLKJoVFGgurFFoIFjYiFmpE8eRQBC387LVPbyH+FebNMiNb3BU38OO9ffPeb97XSoPBwByPx39Go9FriZ9IJIJBoBfCYQVns1m92WymWq3W+9Vq9b1Wq5lgxl6vVwYpQGx4ysagCFJ2KVUqFbPX6/0ul8tv2bfb7VYJIZTfUx6gcN3+rXCfG56pRC+Xi8PlcrELqdPphBaLxTfuSIrFIjMThJDs8XhYJphD6DIncllS0zTKW2exQ9lfd7vdw2QysRzhMckwDCw9fxwcTsFBzuczmc/nH9jFcrm8A3y0OVuPwaC0XC6ng64B7kQ/eVuIvWRpv9+nDofDv3w+r02n05+PcJh9s9l8BvvfarWqRaPRV6VS6UcikWCl3W63W6Xb7TISBUhFD60EULvddvX7/U/spUwmE4DJp1hvh8NhZDab/YrFYnKhUDBgvb6IOuv1egA24x3zCwaD6FqyaZqycHI6nei5PiWTSWO9XpeOx6PKh2c0Go1blhlwIN4KK14Oh8MonU5bUwVSze/3s/RpKBSST6cT8vl8hDvfUErvQbJdNdiUZVkmfI2uPRTOmL8SBAQAPttQcDwed+i67gadEb7BGN/Dzkq2P+U6ZYUHUdsf8JSkqqqyfcS2BOwx15KpLWWVS6G/BNY+/wc2sHnDymExhQAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;\"></span>\n    <picture>\n        <source srcset=\"/static/443737e7fb3b235929b039d616df57f2/cc182/ecs-black.webp 148w,\n/static/443737e7fb3b235929b039d616df57f2/f7e40/ecs-black.webp 295w,\n/static/443737e7fb3b235929b039d616df57f2/1a2f4/ecs-black.webp 590w,\n/static/443737e7fb3b235929b039d616df57f2/fbf2e/ecs-black.webp 771w\" sizes=\"(max-width: 590px) 100vw, 590px\" type=\"image/webp\">\n        <source srcset=\"/static/443737e7fb3b235929b039d616df57f2/cf440/ecs-black.png 148w,\n/static/443737e7fb3b235929b039d616df57f2/d2d38/ecs-black.png 295w,\n/static/443737e7fb3b235929b039d616df57f2/b9e4f/ecs-black.png 590w,\n/static/443737e7fb3b235929b039d616df57f2/0fafd/ecs-black.png 771w\" sizes=\"(max-width: 590px) 100vw, 590px\" type=\"image/png\">\n        <img class=\"gatsby-resp-image-image\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\" src=\"/static/443737e7fb3b235929b039d616df57f2/b9e4f/ecs-black.png\" alt=\"ecs-diagram\" title>\n      </picture>\n  </span>\n</a>\n<p>The example also creates log groups in cloudwatch to capture the logging of the ecs agent and the running containers (services).</p>\n<h4 id=\"setup\"><a href=\"#setup\" aria-label=\"setup permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Setup</h4>\n<p>Before you can start, you need an AWS account with sufficient rights (admin), and you should create a <code class=\"language-text\">AWS_ACCESS_KEY_ID</code> and <code class=\"language-text\">AWS_SECRET_ACCESS_KEY</code> to be able to access your account programmatically.</p>\n<p>Clone the repository containing the ECS <a href=\"https://github.com/npalm/tf-ecs-demo.git\">sample</a> terraform code. To create the infrastructure step-by-step you can check out the tags <code class=\"language-text\">vpc</code> and <code class=\"language-text\">ecs</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">git clone https://github.com/npalm/tf-ecs-demo.git\ngit checkout taipei-vpc</code></pre></div>\n<p>You should also have Terraform installed (<code class=\"language-text\">home brew install terraform</code>) and\ntfenv to manage your terraform installation. Alternatively use a docker container to run the terraform commands, for example:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">docker run -it --env-file &lt;AWS_KEYS_FILE&gt; -v $(pwd):/data -w /data \\\n  hashicorp/terraform:0.10.4 &lt;terraform command&gt;</code></pre></div>\n<br>\n<p>In this example you can swithc the reqion by changing the region variable\n<code class=\"language-text\">aws_region</code> to your own choice. Or set the following environment variable: <code class=\"language-text\">export TF_VAR_aws_region=ap-northeast-1</code>\nfor Tokyo.</p>\n<h4 id=\"create-network-layers-vpc\"><a href=\"#create-network-layers-vpc\" aria-label=\"create network layers vpc permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Create network layers (VPC)</h4>\n<p>In the next steps we will create the network layers.</p>\n<p>First, we initialize and plan our changes.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">terraform init\nterraform plan</code></pre></div>\n<p>Terraform should print on the console that 19 needs to be added and 0 to change or destroyed. Next we apply the change be executing <code class=\"language-text\">terraform apply</code>.</p>\n<h4 id=\"add-ecs-cluster\"><a href=\"#add-ecs-cluster\" aria-label=\"add ecs cluster permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Add ECS cluster</h4>\n<p>Now we have the network layer created, we will add the ECS cluster. By default the bastion host is disabled, the bastion can be enabled by updating the variable <code class=\"language-text\">enable_bastion</code> in the <code class=\"language-text\">terraform.tfvars</code> file. Time to plan and apply the new resources for ECS.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">git checkout taipei-ecs-1\nterraform plan\nterraform apply</code></pre></div>\n<p>Once terraform is ready it will print the url of two applications on the console. One application, is a simple micro service that just prints the AWS availabilty zone where it is running, the other is a <a href=\"/2017/05/20/nextbuild-graphql/\">graphql micro service</a>. It will take a few minutes before the services are available.</p>\n<h4 id=\"adding-your-own-service\"><a href=\"#adding-your-own-service\" aria-label=\"adding your own service permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Adding your own service.</h4>\n<p>Time to have some more fun. Edit the <code class=\"language-text\">main.tf</code> and start making changes. Remove all the services, add your own service. By default for each service an application load balancer (ALB) is created. Add for each services that you want to deploy a configuration as below and update the variables as required.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">module &quot;your-service&quot; {\n  source = &quot;ecs-service&quot;\n\n  service_name   = &quot;&lt;service-name&gt;&quot;\n  image_url      = &quot;&lt;docker-image&gt;&quot;\n  container_port = &lt;port in the container where the service is listening&gt;\n  desired_count  = &lt;number of instances&gt;\n\n  aws_region  = &quot;${var.aws_region}&quot;\n  environment = &quot;${var.environment}&quot;\n\n  vpc_id  = &quot;${module.vpc.vpc_id}&quot;\n  subnets = &quot;${module.vpc.public_subnets}&quot;\n\n  cluster_id            = &quot;${module.ecs-cluster.cluster_id}&quot;\n  ecs_service_role_name = &quot;${module.ecs-cluster.ecs_service_role_name}&quot;\n}</code></pre></div>\n<p>Now plan and apply your changes, Terraform will inform you that a few resources will be destroyed (the removed services) and a few will be added.</p>\n<h3 id=\"clean-up\"><a href=\"#clean-up\" aria-label=\"clean up permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Clean up</h3>\n<p>Once done you can easily clean-up all created resources in AWS, just run <code class=\"language-text\">terraform destroy</code>.</p>\n<h3 id=\"serverless-containers\"><a href=\"#serverless-containers\" aria-label=\"serverless containers permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Serverless containers.</h3>\n<p>Since a few months Amazon support running containers without managing your\nec2 instances, aka Serverless Containers. This services is called Fargate. I\nhave written a <a href=\"https://040code.github.io/2018/01/30/fargate_with_terraform/\">blog\npost</a> about\nhow to run you containers serveless with terraform. Creating a mix of both\nways of running of containers is explained as well. Be aware that Fargate is\nstill only avaialable in <code class=\"language-text\">us-east-1</code>.</p>\n<p>Have fun!</p>","frontmatter":{"title":"Immutable Infrastructure","subtitle":"Cloud Native User Group Taipei","date":"2018-05-26","slug":"2018/05/26/immutable-infrastructure-taipei","language":null,"tags":["terraform","aws","docker","microservices"],"authors":["niek"],"comments":null,"cover":{"publicURL":"/static/strijp-s-ols-c51a56e06b3424b578bf1a206115fe45.png"},"coverLink":"https://goo.gl/maps/9vKN3aZ5KdT2","coverDescription":"Leidingstraat, Strijp S","imageTw":{"publicURL":"/static/2018-05-26-immutable-infrastructure-taipei-tw-b5653ef6d1c993bfe619ef8d08919073.png"},"imageFb":{"publicURL":"/static/2018-05-26-immutable-infrastructure-taipei-fb-55a1b8fe412db904f5bd90d27e076d94.png"},"asciinema":null}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"2018/05/26/immutable-infrastructure-taipei","previous":{"frontmatter":{"title":"Verlet Integration","slug":"2018/03/04/verlet-integration","type":"post","tags":["clojure","functional"],"authors":["maarten"]}},"next":{"frontmatter":{"title":"Microhack Brew your code","slug":"2018/08/08/microhack-brew-your-code","type":"post","tags":["microhack","mac","brew"],"authors":["jeroen"]}}}}