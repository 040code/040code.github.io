<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet"/><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous"/><style data-href="/styles.131b48b25a50eff60b34.css">code[class*=language-],pre[class*=language-]{color:#ccc;background:none;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.block-comment,.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#999}.token.punctuation{color:#ccc}.token.attr-name,.token.deleted,.token.namespace,.token.tag{color:#e2777a}.token.function-name{color:#6196cc}.token.boolean,.token.function,.token.number{color:#f08d49}.token.class-name,.token.constant,.token.property,.token.symbol{color:#f8c555}.token.atrule,.token.builtin,.token.important,.token.keyword,.token.selector{color:#cc99cd}.token.attr-value,.token.char,.token.regex,.token.string,.token.variable{color:#7ec699}.token.entity,.token.operator,.token.url{color:#67cdcc}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.token.inserted{color:green}</style><meta name="generator" content="Gatsby 2.4.2"/><style type="text/css">
    .anchor {
      float: left;
      padding-right: 4px;
      margin-left: -20px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var offset = element.offsetTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><link rel="preconnect dns-prefetch" href="https://www.google-analytics.com"/><link rel="alternate" type="application/rss+xml" href="/rss.xml"/><style data-styled="hTmxqc lcZENV lfoWPa hPmQYh dANmgz brBAvj hpDnww bWPqAN gEMFDS eyJpws cmRrYK hwkicN iTdcdb jRHVYT kQWgFX itRnbT efQrCa hFicPH" data-styled-version="4.2.0">
/* sc-component-id: SideMenu__StyledBurgerMenu-uekpe8-0 */
.hTmxqc .bm-burger-button{position:fixed;width:36px;height:30px;left:36px;top:36px;} .hTmxqc .bm-burger-bars{background:#ffffff;} .hTmxqc .bm-cross-button{height:24px;width:24px;} .hTmxqc .bm-cross{background:#ffffff;} .hTmxqc .bm-menu{background:rgb(0,0,0,0.5);padding:2.5em 1em 0;font-size:1.15em;} .hTmxqc .bm-morph-shape{fill:#373a47;} .hTmxqc .bm-item-list{padding-top:2em;} .hTmxqc .bm-item{display:inline-block;padding:0.5em;} .hTmxqc .bm-overlay{background:rgba(0,0,0,0.3);}
/* sc-component-id: SideMenu__MenuLink-uekpe8-1 */
.lcZENV{position:relative;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:#fff;border:0;margin:0;margin-right:0.5rem;padding-left:20px;padding-right:20px;min-width:42px;z-index:10;}
/* sc-component-id: Footer__FooterWrapper-sc-1oxe0wr-0 */
.hFicPH{text-align:left;padding-top:30px;padding-bottom:50px;background-color:rgba(32,35,42,0.85);color:#ffffff;padding-left:20px;padding-right:20px;margin:3.5em auto 0 0;} .hFicPH nav{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-flow:row wrap;-ms-flex-flow:row wrap;flex-flow:row wrap;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;max-width:900px;margin:0 auto;} .hFicPH nav .footer-col{-webkit-flex:1 auto;-ms-flex:1 auto;flex:1 auto;display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;margin-bottom:1em;padding-right:1em;} .hFicPH a{color:#ffffff;font-weight:bold;} .hFicPH a:hover{color:#e8e8e8;border-bottom:1px dotted #e8e8e8;} .hFicPH .footer-col > p{margin:0;} .hFicPH .footer-title{margin:0 0 1rem;} .hFicPH .footer-item{padding:0.25rem 0;color:#ffffff;} .hFicPH .footer-heart{color:red;} .hFicPH .footer-item-text{padding:0.1rem 0;color:#ffffff;} .hFicPH .footer-header{-webkit-order:1;-ms-flex-order:1;order:1;margin:0 0.25rem;margin-right:0.25rem;padding:0.25rem;} @media (max-width:564px){.hFicPH .footer-col:first-child{width:100%;}}
/* sc-component-id: sc-global-3886539976 */
*{box-sizing:border-box;margin:0;padding:0;} body{font-family:"Lato",sans-serif;color:#222222cc;background-color:#e8e8e8;} img{max-width:100%;height:auto;vertical-align:middle;border:0;} a{-webkit-text-decoration:none;text-decoration:none;color:rgba(34,34,34,0.8);} ul,ol{padding-left:2em;margin:1em 0 0 0;}
/* sc-component-id: Wrapper-aej7i5-0 */
.hwkicN{position:relative;border-radius:3px;width:80%;max-width:770px;border-bottom:1px solid #ebf2f6;word-wrap:break-word;background-color:#fff;margin:0px auto 30px auto;top:30px;padding:50px;box-shadow:0 0 0 0,0 6px 12px rgba(0,0,0,0.1);} @media (max-width:780px){.hwkicN{width:90%;padding:25px;}}
/* sc-component-id: Hero__HeroContainer-sc-1i1rqpz-0 */
.lfoWPa{position:relative;display:table;width:100%;height:340px;overflow:hidden;background-repeat:no-repeat;background-position:center;background-size:cover;}
/* sc-component-id: Hero__TitleContainer-sc-1i1rqpz-1 */
.hPmQYh{display:table-cell;vertical-align:middle;text-align:center;width:100%;}
/* sc-component-id: Hero__LocationContainer-sc-1i1rqpz-2 */
.gEMFDS{display:table-footer-group;vertical-align:center;text-align:right;width:100%;}
/* sc-component-id: Hero__HeroTitle-sc-1i1rqpz-3 */
.dANmgz{font-size:3.5rem;margin:10px 60px;color:#fff;text-shadow:2px 2px #222222;font-weight:800;font-family:'Open Sans','Helvetica Neue',Helvetica,Arial,sans-serif;}
/* sc-component-id: Hero__HeroSubtitle-sc-1i1rqpz-4 */
.brBAvj{font-size:1.7rem;margin:10px 60px;color:#fff;text-shadow:2px 2px #222222;font-family:'Open Sans','Helvetica Neue',Helvetica,Arial,sans-serif;}
/* sc-component-id: Hero__DateAndAuthor-sc-1i1rqpz-5 */
.hpDnww{font-weight:500;font-size:1.2rem;color:#fff;text-shadow:2px 2px #222222;}
/* sc-component-id: Hero__AuthorLink-sc-1i1rqpz-6 */
.bWPqAN{margin-left:0.3rem;font-weight:500;font-size:1.2rem;color:#fff;text-shadow:2px 2px #222222;} .bWPqAN:hover{border-bottom:1px dotted #787676;} .bWPqAN:before{content:'@';}
/* sc-component-id: Hero__LocationLink-sc-1i1rqpz-7 */
.cmRrYK{margin-right:0.7rem;font-size:0.9rem;color:#fff;text-shadow:2px 2px #222222;font-size:1rem;font-family:'Open Sans','Helvetica Neue',Helvetica,Arial,sans-serif;font-style:italic;} .cmRrYK:hover{border-bottom:1px dotted #787676;}
/* sc-component-id: Hero__LocationMarker-sc-1i1rqpz-8 */
.eyJpws{margin-right:0.4rem;font-size:0.75rem;color:#fff;text-shadow:2px 2px #222222;font-family:'Open Sans','Helvetica Neue',Helvetica,Arial,sans-serif;}
/* sc-component-id: TagList__ListContainer-sc-1uj42o2-0 */
.kQWgFX{display:inline;margin:0 0.5rem 0 0;color:#787676;}
/* sc-component-id: TagList__TagListItem-sc-1uj42o2-1 */
.itRnbT{margin-left:0.3rem;display:inline-block;min-width:10px;padding:3px 7px;font-size:12px;font-weight:700;line-height:1;color:#fff;text-align:center;white-space:nowrap;vertical-align:middle;background-color:#777;border-radius:10px;} .itRnbT:hover{border-bottom:1px dotted #787676;}
/* sc-component-id: ContentHeader__Header-sc-1uw779c-0 */
.jRHVYT{margin-bottom:2rem;color:#787676;}
/* sc-component-id: Content__ContentBody-sc-1jppj8x-0 */
.efQrCa{line-height:1.6;} .efQrCa > h1:first-of-type{padding-top:0;} .efQrCa > h1{margin-top:3rem;font-size:2em;} .efQrCa > h2:first-of-type{padding-top:0;} .efQrCa > h2{margin-top:3rem;font-size:1.5em;} .efQrCa > h3{padding-top:3rem;font-size:1.17em;} .efQrCa > p{margin:1em 0 0 0;} .efQrCa a{border-bottom:1px dotted rgba(162,162,162,0.8);} .efQrCa a:hover{border-bottom-style:solid;} .efQrCa a.anchor,.efQrCa a.gatsby-resp-image-link{border:none;} .efQrCa > blockquote{box-sizing:border-box;margin:1.75em 0 1.75em -2.2em;padding:0 0 0 1.75em;border-left:0.4em solid rgba(32,35,42,0.85);} .efQrCa > blockquote p{margin:0.8em 0;font-style:italic;} .efQrCa .gatsby-highlight{border-radius:5px;font-size:15px;line-height:1.7;background:#2d2d2d;color:#ffffff;border-radius:10px;overflow:auto;tab-size:1.5em;margin:1.5em 0em 1.5em 0;font-size:0.7em;} .efQrCa .gatsby-highlight > pre{border:0;margin:0;padding:1;} .efQrCa .gatsby-highlight-code-line{background-color:#022a4b;display:block;margin-right:-1em;margin-left:-1em;padding-right:1em;padding-left:0.75em;border-left:0.25em solid #ffa7c4;} .efQrCa p > code.language-text,.efQrCa li > code.language-text{background:rgba(255,229,100,0.2);color:#222222cc;padding:0 3px;font-size:0.94em;border-radius:0.3rem;} .efQrCa table{margin-top:1em;border-collapse:collapse;border-radius:0.5em;overflow:hidden;} .efQrCa table th,.efQrCa table td{padding:0.5em;background:#e8e8e8;border-bottom:2px solid white;}
/* sc-component-id: Article__ArticleWrapper-sc-1nyoqfc-0 */
.iTdcdb{padding:0 30px 30px;} @media only screen and (max-width:500px){.iTdcdb{padding:0;}}</style><title data-react-helmet="true">MicroHack Fargate | 040code</title><link data-react-helmet="true" rel="stylesheet" type="text/css" href="/asciinema-player.css"/><link data-react-helmet="true" rel="canonical" href="https://040code.github.io/2018/01/30/microhack-fargate"/><meta data-react-helmet="true" name="description" content="Last December at the AWS re:invent, AWS announced the new container service platform Fargate. Fargate is integrated to ECS. The key…"/><meta data-react-helmet="true" property="og:url" content="https://040code.github.io/2018/01/30/microhack-fargate"/><meta data-react-helmet="true" property="og:type" content="article"/><meta data-react-helmet="true" property="og:title" content="MicroHack Fargate | 040code"/><meta data-react-helmet="true" property="og:description" content="Last December at the AWS re:invent, AWS announced the new container service platform Fargate. Fargate is integrated to ECS. The key…"/><meta data-react-helmet="true" property="og:image" content="https://040code.github.io/static/2018-01-30-microhack-fargate-fb-b956a385493c3a547571f1e1965863ac.png"/><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"/><meta data-react-helmet="true" name="twitter:creator" content="niekos77"/><meta data-react-helmet="true" name="twitter:title" content="MicroHack Fargate | 040code"/><meta data-react-helmet="true" name="twitter:description" content="Last December at the AWS re:invent, AWS announced the new container service platform Fargate. Fargate is integrated to ECS. The key…"/><meta data-react-helmet="true" name="twitter:image" content="https://040code.github.io/static/2018-01-30-microhack-fargate-tw-225197210f0ca93bedfa6b7d64f6c671.png"/><script data-react-helmet="true" src="/asciinema-player.js"></script><link rel="shortcut icon" href="/icons/icon-48x48.png?v=008654519ce705ac7bc44303a9014606"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#222222"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=008654519ce705ac7bc44303a9014606"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=008654519ce705ac7bc44303a9014606"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=008654519ce705ac7bc44303a9014606"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=008654519ce705ac7bc44303a9014606"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=008654519ce705ac7bc44303a9014606"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=008654519ce705ac7bc44303a9014606"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=008654519ce705ac7bc44303a9014606"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=008654519ce705ac7bc44303a9014606"/><link as="script" rel="preload" href="/component---src-templates-blog-post-js-1a3cb45e2a79586236db.js"/><link as="script" rel="preload" href="/app-621948f53dbdfc1c8bad.js"/><link as="script" rel="preload" href="/3-4d73c1baf9953aba24ed.js"/><link as="script" rel="preload" href="/1-90cb61cfcc26a11cdeca.js"/><link as="script" rel="preload" href="/styles-13d2ee47eddc5325ccbc.js"/><link as="script" rel="preload" href="/webpack-runtime-5f413a8fb1a2f48d55a2.js"/><link as="fetch" rel="preload" href="/static/d/567/path---2018-01-30-microhack-fargate-b-27-c87-GS6JZ18n7LeiVx07F10hPWSg5Y.json" crossorigin="use-credentials"/></head><body><noscript>This site runs best with JavaScript enabled.</noscript><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group"><div class="SideMenu__StyledBurgerMenu-uekpe8-0 hTmxqc"><div><div class="bm-overlay" style="position:fixed;z-index:1000;width:100%;height:100%;background:rgba(0, 0, 0, 0.3);opacity:0;-moz-transform:translate3d(100%, 0, 0);-ms-transform:translate3d(100%, 0, 0);-o-transform:translate3d(100%, 0, 0);-webkit-transform:translate3d(100%, 0, 0);transform:translate3d(100%, 0, 0);transition:opacity 0.3s, transform 0s 0.3s"></div><div id="" class="bm-menu-wrap" style="position:fixed;right:inherit;z-index:1100;width:300px;height:100%;-moz-transform:translate3d(-100%, 0, 0);-ms-transform:translate3d(-100%, 0, 0);-o-transform:translate3d(-100%, 0, 0);-webkit-transform:translate3d(-100%, 0, 0);transform:translate3d(-100%, 0, 0);transition:all 0.5s"><div class="bm-menu" style="height:100%;box-sizing:border-box;overflow:auto"><nav class="bm-item-list" style="height:100%"><a class="bm-item SideMenu__MenuLink-uekpe8-1 lcZENV" style="display:block" tabindex="-1" href="/">🏡 040 blog</a><a class="bm-item SideMenu__MenuLink-uekpe8-1 lcZENV" style="display:block" tabindex="-1" href="/about">About</a><a class="bm-item SideMenu__MenuLink-uekpe8-1 lcZENV" style="display:block" tabindex="-1" href="/authors/niek">Niek Palm</a><a class="bm-item SideMenu__MenuLink-uekpe8-1 lcZENV" style="display:block" tabindex="-1" href="/authors/maarten">Maarten Metz</a><a class="bm-item SideMenu__MenuLink-uekpe8-1 lcZENV" style="display:block" tabindex="-1" href="/authors/jeroen">Jeroen Knoops</a><a class="bm-item SideMenu__MenuLink-uekpe8-1 lcZENV" style="display:block" tabindex="-1" href="/authors/stefan">Stefan van den Oord</a></nav></div><div><div class="bm-cross-button" style="position:absolute;width:24px;height:24px;right:8px;top:8px"><span style="position:absolute;top:6px;right:14px"><span class="bm-cross" style="position:absolute;width:3px;height:14px;transform:rotate(45deg)"></span><span class="bm-cross" style="position:absolute;width:3px;height:14px;transform:rotate(-45deg)"></span></span><button style="position:absolute;left:0;top:0;width:100%;height:100%;margin:0;padding:0;border:none;font-size:0;background:transparent;cursor:pointer" tabindex="-1">Close Menu</button></div></div></div><div><div class="bm-burger-button" style="z-index:1000"><span><span class="bm-burger-bars" style="position:absolute;height:20%;left:0;right:0;top:0%;opacity:1"></span><span class="bm-burger-bars" style="position:absolute;height:20%;left:0;right:0;top:40%;opacity:1"></span><span class="bm-burger-bars" style="position:absolute;height:20%;left:0;right:0;top:80%;opacity:1"></span></span><button style="position:absolute;left:0;top:0;width:100%;height:100%;margin:0;padding:0;border:none;font-size:0;background:transparent;cursor:pointer">Open Menu</button></div></div></div></div><div style="margin:0 0"><div style="background-image:url(&quot;/static/strijps-containers-5f274d2e7f9dd77747d836a11b317709.jpg&quot;)" class="Hero__HeroContainer-sc-1i1rqpz-0 lfoWPa"><div class="Hero__TitleContainer-sc-1i1rqpz-1 hPmQYh"><h1 class="Hero__HeroTitle-sc-1i1rqpz-3 dANmgz">MicroHack Fargate</h1><h2 class="Hero__HeroSubtitle-sc-1i1rqpz-4 brBAvj">Running serverless containers with Terraform</h2><span class="Hero__DateAndAuthor-sc-1i1rqpz-5 hpDnww">by:<!-- --> <a class="Hero__AuthorLink-sc-1i1rqpz-6 bWPqAN" href="/authors/niek">niek</a>  on <!-- -->2018-01-30</span></div><div class="Hero__LocationContainer-sc-1i1rqpz-2 gEMFDS"><span class="Hero__LocationMarker-sc-1i1rqpz-8 eyJpws"><span class="fa fa-map-marker-alt"></span></span><a href="https://goo.gl/maps/frNLw6shgEP2" target="_blank" class="Hero__LocationLink-sc-1i1rqpz-7 cmRrYK">Containers Leidingstraat - Strijp S</a></div></div><main role="main" class="Wrapper-aej7i5-0 hwkicN"><article class="Article__ArticleWrapper-sc-1nyoqfc-0 iTdcdb"><section><header class="ContentHeader__Header-sc-1uw779c-0 jRHVYT"><div class="TagList__ListContainer-sc-1uj42o2-0 kQWgFX"><a class="w3-round-size TagList__TagListItem-sc-1uj42o2-1 itRnbT" href="/tags/aws">aws</a> <a class="w3-round-size TagList__TagListItem-sc-1uj42o2-1 itRnbT" href="/tags/terraform">terraform</a> <a class="w3-round-size TagList__TagListItem-sc-1uj42o2-1 itRnbT" href="/tags/docker">docker</a> <a class="w3-round-size TagList__TagListItem-sc-1uj42o2-1 itRnbT" href="/tags/microhack">microhack</a></div></header><div class="Content__ContentBody-sc-1jppj8x-0 efQrCa"><p>Last December at the AWS re:invent, AWS announced the new container service platform Fargate. Fargate is integrated to ECS. The key difference is that Fargate does not require you to have EC2 instances running to host your containers, which means we have serverless containers. A drawback is that Fargate is not globally available yet, today Fargate is only available in <code class="language-text">us-east-1</code>, see also the <a href="https://aws.amazon.com/about-aws/global-infrastructure/regional-product-services/">list</a> of supported regions. Later in December Fargate also become available in <a href="https://www.terraform.io/">Terraform</a> so time to see how it works.</p>
<p>In this post I will show how to deploy containers to Fargate using Terraform. As example docker image I will use the blog itself. The complete example in available on <a href="https://github.com/npalm/blog_terraform_aws_fargate">GitHub</a>. First I show how you can deploy a container using Terraform to Fargate. In case you would like to experiment with AWS console instead of Terraform you should be able to execute the same steps direct in AWS. Only the VPC part could be a bit tricky, but even that part can be skipped and replaced with the default VPC. In that case you don’t have private subnets available.</p>
<p>Finally I will discuss how a deployment with Fargate in ECS compares to a deployment with EC2 in ECS. And show what steps have to be taken to move the deployment from Fargate to EC2 instances.</p>
<h2 id="prerequisites"><a href="#prerequisites" aria-label="prerequisites permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Prerequisites</h2>
<p>Before you start you need to have programmatically access to an AWS account and Terraform (0.11+) installed. The tool <a href="http://brewformulas.org/Tfenv">tfenv</a> let you manage multiple terraform version on your system.</p>
<h2 id="deploy-serverless-containers-on-fargate"><a href="#deploy-serverless-containers-on-fargate" aria-label="deploy serverless containers on fargate permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Deploy serverless containers on Fargate</h2>
<p>Before we can create our containers, we have to create a few infrastructural components. For this example we create an own VPC including public and private subnets. An ECS cluster for our containers, and a CloudWatch log group for centralized logging. The diagram below shows an abstract view of the deployment we are going to create, this view contains two in instead of the 3 availability zones we use.</p>
<a href="#">
    <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;">
    <span class="gatsby-resp-image-background-image" style="padding-bottom: 56.25%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAACr0lEQVQoz21ST0zTcBT+dbAEvYgxIUE0AWO86I3EePRqjF4lGk0MCScPnPRgojEe9CImaoygUTMScHEBphB0G7Cxjs12rlu3tR3buu5v11a2FQaMRXiWygig3+m9L9/78r7f+yGkwWQeR4WCuF2iwY+jqCiKTQCg9wDrrSVFfCrL0qqyVPrGLfLd2/wvOd2saQxJPokuXOpB23o+JSCUEtKotKTowxUpjQ27Uwa0gxTP907gXFpUa1D0ft5SwjiUl6ugKFIv2gOATcONvn40NvkdoUm7c4dUsYZgWcldLBRlT622Ds6QAA9HyC0nyUFeSK4EAiRMWUcYScrfyebF20dOnGpCB9GItyKnzk37YmY6KUG9tgq5glivqqXNpJCpOgj2mT8cbTd9Gn/CsCzU1pahXFFhqVTCtZSXX701tbgXCAOi6Cg2+GHYqPkZpBx/3eMn1edfaTC7tI3yeRByRXCRESkaDl1RxGw/HuJzAxOh385AfEOWFaiuroH2dmPzHt/pL9P2ZkQEQkYyQHfNuPB2fduq41hykXw06SKCVJC+NmV33YwwsQ21XIKKugyqWgGSScP7aQqisQTFcVzP44E3Lfsip7O5ZjrKdVB0pPO1aaLD5pi757NZOu2WoVaaCVuHbAw4g6l6JpvdKmumsvYN5Hz6vtvjbWt4xOMJNGKxIvQzGNk15uL8ITrCdNpn5u4Oj1q6zQ72cDbh75vzLTAvrH7wULFaLiO8s8/7zjZm1qormBP3IYcT370FYmMJFGZi+44U4eInHU73cb2vE0fzAvuApMJX92gwP0VjjlmX3nsJP8K9P5Bu5PIQOhnl4sjt/VuzLGeIsPG2QDB0xmpzd52/9dK4Gy+RxKZss3qtJdLmff/8nH0bHqiNVJDSzZhEBiNIUudFUUTz/zH6A5311DMw1KRlAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;"></span>
    <picture>
        <source srcset="/static/2701f076404b39a83e017aadc9c77c86/cc182/ecs-fargate-diagram.webp 148w,
/static/2701f076404b39a83e017aadc9c77c86/f7e40/ecs-fargate-diagram.webp 295w,
/static/2701f076404b39a83e017aadc9c77c86/1a2f4/ecs-fargate-diagram.webp 590w,
/static/2701f076404b39a83e017aadc9c77c86/4837b/ecs-fargate-diagram.webp 885w,
/static/2701f076404b39a83e017aadc9c77c86/2f819/ecs-fargate-diagram.webp 1180w,
/static/2701f076404b39a83e017aadc9c77c86/a1c21/ecs-fargate-diagram.webp 1280w" sizes="(max-width: 590px) 100vw, 590px" type="image/webp">
        <source srcset="/static/2701f076404b39a83e017aadc9c77c86/cf440/ecs-fargate-diagram.png 148w,
/static/2701f076404b39a83e017aadc9c77c86/d2d38/ecs-fargate-diagram.png 295w,
/static/2701f076404b39a83e017aadc9c77c86/b9e4f/ecs-fargate-diagram.png 590w,
/static/2701f076404b39a83e017aadc9c77c86/f9b6a/ecs-fargate-diagram.png 885w,
/static/2701f076404b39a83e017aadc9c77c86/2d849/ecs-fargate-diagram.png 1180w,
/static/2701f076404b39a83e017aadc9c77c86/0309e/ecs-fargate-diagram.png 1280w" sizes="(max-width: 590px) 100vw, 590px" type="image/png">
        <img class="gatsby-resp-image-image" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;" src="/static/2701f076404b39a83e017aadc9c77c86/b9e4f/ecs-fargate-diagram.png" alt="Fargate" title>
      </picture>
  </span>
</a>
<p>We start with defining the VPC, we choose <code class="language-text">us-east-1</code> since Fargate is only available in this region. In the blog post <a href="/2017/06/18/terraform-aws-vpc/">Coding a VPC in Terraform</a> you find more details about how this VPC module is structured.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">provider &quot;aws&quot; {
  region  = &quot;us-east-1&quot;
  version = &quot;1.7.1&quot;
}

provider &quot;template&quot; {
  version = &quot;1.0&quot;
}

module &quot;vpc&quot; {
  source  = &quot;npalm/vpc/aws&quot; // https://registry.terraform.io/modules/npalm/vpc/aws
  version = &quot;1.1.0&quot;

  environment = &quot;blog&quot;
  aws_region  = &quot;us-east-1&quot;

  create_private_hosted_zone = &quot;false&quot;

  // us-east-1 is the only region that supports Fargate
  availability_zones = {
    us-east-1 = [&quot;us-east-1a&quot;, &quot;us-east-1b&quot;, &quot;us-east-1c&quot;]
  }
}</code></pre></div>
<p>Next we define the ECS cluster, and CloudWatch log group. Since we will deploy to Fargate we don’t have to attache EC2 instances to our cluster.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">resource &quot;aws_ecs_cluster&quot; &quot;cluster&quot; {
  name = &quot;blog-ecs-cluster&quot;
}

resource &quot;aws_cloudwatch_log_group&quot; &quot;log_group&quot; {
  name = &quot;blog&quot;
}</code></pre></div>
<p>Now the first part is defined we execute a <code class="language-text">terraform apply</code> and inpect the results.</p>
<p><asciinema-player src="/2018/01/30/microhack-fargate/fargate-terraform-1.json"
  cols="166" rows="15" autoplay="true" loop="true" speed="1.5">
</asciinema-player></p>
<p>The next step is to deploy the docker image with the blog. In ECS you deploy a docker container with a task. And your task will be managed by a service. First we create the task definition which contains the container deployment definition as well. Fargate is using <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task-networking.html">awsvpc as networking mode</a>, in this mode each task definiton gets its own private ip address. This network mode requires a role for the task execution. In case you create your definition through the Amazon console a service linked role will be created for you. We will create this role also via code.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">data &quot;aws_iam_policy_document&quot; &quot;ecs_tasks_execution_role&quot; {
  statement {
    actions = [&quot;sts:AssumeRole&quot;]

    principals {
      type        = &quot;Service&quot;
      identifiers = [&quot;ecs-tasks.amazonaws.com&quot;]
    }
  }
}

resource &quot;aws_iam_role&quot; &quot;ecs_tasks_execution_role&quot; {
  name               = &quot;blog-ecs-task-execution-role&quot;
  assume_role_policy = &quot;${data.aws_iam_policy_document.ecs_tasks_execution_role.json}&quot;
}

resource &quot;aws_iam_role_policy_attachment&quot; &quot;ecs_tasks_execution_role&quot; {
  role       = &quot;${aws_iam_role.ecs_tasks_execution_role.name}&quot;
  policy_arn = &quot;arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy&quot;
}</code></pre></div>
<p>We have defined the execution rol for the task, next we define the task definion. This task definition consist of two parts. First we define a container definition via a <code class="language-text">template_file</code>. In this container definition you see container port 80 is mapped to host port 80, the task will get its own private IP. And after that we define the task definition self. The following settings are required for a task that will run in Fargate: requires<em>compatibilities, network</em>mode, cpu and memory.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">data &quot;template_file&quot; &quot;blog&quot; {
  template = &lt;&lt;EOF
  [
    {
      &quot;essential&quot;: true,
      &quot;image&quot;: &quot;npalm/040code.github.io:latest&quot;,
      &quot;name&quot;: &quot;blog&quot;,
      &quot;portMappings&quot;: [
        {
          &quot;hostPort&quot;: 80,
          &quot;protocol&quot;: &quot;tcp&quot;,
          &quot;containerPort&quot;: 80
        }
      ],
      &quot;logConfiguration&quot;: {
        &quot;logDriver&quot;: &quot;awslogs&quot;,
        &quot;options&quot;: {
          &quot;awslogs-group&quot;: &quot;blog&quot;,
          &quot;awslogs-region&quot;: &quot;us-east-1&quot;,
          &quot;awslogs-stream-prefix&quot;: &quot;040code&quot;
        }
      }
    }
  ]

  EOF
}

resource &quot;aws_ecs_task_definition&quot; &quot;task&quot; {
  family                   = &quot;blog-blog&quot;
  container_definitions    = &quot;${data.template_file.blog.rendered}&quot;
  network_mode             = &quot;awsvpc&quot;
  cpu                      = &quot;256&quot;
  memory                   = &quot;512&quot;
  requires_compatibilities = [&quot;FARGATE&quot;]
  execution_role_arn       = &quot;${aws_iam_role.ecs_tasks_execution_role.arn}&quot;
}</code></pre></div>
<p>Time to verify the code is working by executing a <code class="language-text">terraform apply</code></p>
<p><asciinema-player src="/2018/01/30/microhack-fargate/fargate-terraform-2.json"
  cols="166" rows="15" autoplay="true" loop="true" speed="1.0">
</asciinema-player></p>
<a href="#">
    <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;">
    <span class="gatsby-resp-image-background-image" style="padding-bottom: 67.29678638941398%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAAsSAAALEgHS3X78AAABzElEQVQoz1VR2Y6cMBDk/78s76usZncAcZrDJ7bBNgM4xTDZZFCphdyuqm5XwoaeNHVTV0ZPzi0huOD9jM8a7xa3zEZrawzwc4IftyxrCMlnw359pEUzEKo+btktK/O6SytyLwlhU93zr6y+F+T2rB3XaUm+8rqlikqT5NQUfNFb5A446LzReRchqjUKH4l0rVi43/Uepy3KNarH2eI+6hCTUdmiZ5205hGnEPV6QvpD+n1aIxH2My2rUTZsytqxU3PR82FalI9mPRJmQ07oMDnUTi24RISBinK7CrEV9l73nZyVP/iyCbfz+YEqA8gxodqXowStHATag/aj9qABcG65+a66miqoN3TCRDhES7rjJDMTGm6KXvRqBg3CZ9sfAPzhmRPWCAPd0a6X6En2l7Pxecey9pwZttSES/uvs+7VwueN2ZXND3Qv3ZfzqN21M5aXbpvC9VonwIdcMYgeM3ODFVDfnEHICG24xoTjf7YXykHeq77o+BQO/Yg/G72ce2mRBJvXs/HOBOBZUby/xSCDduIZwT9nLPM7qxqmq3FChpfwC7gUIqJCwiCnzUDt+nrti4w8ET21QYXXnj/AvdH49EmGRzkKPr+R/wAMI99xYR5OmgAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;"></span>
    <picture>
        <source srcset="/static/97f5936174c67199672f40abfcc13a0d/cc182/container-definition.webp 148w,
/static/97f5936174c67199672f40abfcc13a0d/f7e40/container-definition.webp 295w,
/static/97f5936174c67199672f40abfcc13a0d/1a2f4/container-definition.webp 590w,
/static/97f5936174c67199672f40abfcc13a0d/4837b/container-definition.webp 885w,
/static/97f5936174c67199672f40abfcc13a0d/2f819/container-definition.webp 1180w,
/static/97f5936174c67199672f40abfcc13a0d/799b2/container-definition.webp 1770w,
/static/97f5936174c67199672f40abfcc13a0d/cb54e/container-definition.webp 2116w" sizes="(max-width: 590px) 100vw, 590px" type="image/webp">
        <source srcset="/static/97f5936174c67199672f40abfcc13a0d/cf440/container-definition.png 148w,
/static/97f5936174c67199672f40abfcc13a0d/d2d38/container-definition.png 295w,
/static/97f5936174c67199672f40abfcc13a0d/b9e4f/container-definition.png 590w,
/static/97f5936174c67199672f40abfcc13a0d/f9b6a/container-definition.png 885w,
/static/97f5936174c67199672f40abfcc13a0d/2d849/container-definition.png 1180w,
/static/97f5936174c67199672f40abfcc13a0d/bbefa/container-definition.png 1770w,
/static/97f5936174c67199672f40abfcc13a0d/86e91/container-definition.png 2116w" sizes="(max-width: 590px) 100vw, 590px" type="image/png">
        <img class="gatsby-resp-image-image" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;" src="/static/97f5936174c67199672f40abfcc13a0d/b9e4f/container-definition.png" alt="Fargate" title>
      </picture>
  </span>
</a>
<p>We have still nothing running but you can already see the different parts in de AWS console. We have now a VPC, CloudWatch log group, ECS cluster and task definition available. The next logical step in de AWS console would be to create the service, and find out at the latest step that you need to create a load balancer first. So in code we will define the load balancer first. The load balancer will route traffic via HTTP to the container.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">resource &quot;aws_security_group&quot; &quot;alb_sg&quot; {
  name   = &quot;blog-blog-alb-sg&quot;
  vpc_id = &quot;${module.vpc.vpc_id}&quot;

  ingress {
    protocol    = &quot;tcp&quot;
    from_port   = 80
    to_port     = 80
    cidr_blocks = [&quot;0.0.0.0/0&quot;]
  }

  egress {
    from_port = 0
    to_port   = 0
    protocol  = &quot;-1&quot;

    cidr_blocks = [&quot;0.0.0.0/0&quot;]
  }
}

resource &quot;aws_alb&quot; &quot;main&quot; {
  internal        = &quot;false&quot;
  subnets         = [&quot;${module.vpc.public_subnets}&quot;]
  security_groups = [&quot;${aws_security_group.alb_sg.id}&quot;]
}

resource &quot;aws_alb_listener&quot; &quot;main&quot; {
  load_balancer_arn = &quot;${aws_alb.main.id}&quot;
  port              = 80
  protocol          = &quot;HTTP&quot;

  default_action {
    target_group_arn = &quot;${aws_alb_target_group.main.id}&quot;
    type             = &quot;forward&quot;
  }
}</code></pre></div>
<p>We connect a target group to the load balancer. The same target group will be used later in the service, the service can register itself to the target group with the actual IP address once up and running. For the target group we have to specify the target type <code class="language-text">ip</code> and not <code class="language-text">instance</code> since containers running in Fargate will get their own IP. Actually this not Fargate but <code class="language-text">awsvpc</code> behavior.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">resource &quot;aws_alb_target_group&quot; &quot;main&quot; {
  port        = &quot;80&quot;
  protocol    = &quot;HTTP&quot;
  vpc_id      = &quot;${module.vpc.vpc_id}&quot;
  target_type = &quot;ip&quot;
}

output &quot;blog_url&quot; {
  value = &quot;http://${aws_alb.main.dns_name}&quot;
}</code></pre></div>
<p>Again we verify our new code by executing a <code class="language-text">terraform apply</code>.</p>
<p><asciinema-player src="/2018/01/30/microhack-fargate/fargate-terraform-3.json"
  cols="166" rows="15" autoplay="true" loop="true" speed="1.5">
</asciinema-player></p>
<p>We are almost there, next we define the service. A task running in in network mode <code class="language-text">awsvpc</code>, requires a service that defines a network configuration. In the networking configuration we define a security group to control access to our containers, and we define the subnets in which the containers are hosted.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">resource &quot;aws_security_group&quot; &quot;awsvpc_sg&quot; {
  name   = &quot;blog-awsvpc-cluster-sg&quot;
  vpc_id = &quot;${module.vpc.vpc_id}&quot;

  ingress {
    protocol  = &quot;tcp&quot;
    from_port = 0
    to_port   = 65535

    cidr_blocks = [
      &quot;${module.vpc.vpc_cidr}&quot;,
    ]
  }

  egress {
    from_port   = 0
    to_port     = 65535
    protocol    = &quot;tcp&quot;
    cidr_blocks = [&quot;0.0.0.0/0&quot;]
  }

  tags {
    Name        = &quot;blog-ecs-cluster-sg&quot;
    Environment = &quot;blog&quot;
  }
}</code></pre></div>
<p>The last resource to create is the service. In the service we connect the task, load balancer and security group together. By setting the launch type to <code class="language-text">FARGATE</code> we tell Amazon to deploy the container to Fargate.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">resource &quot;aws_ecs_service&quot; &quot;service&quot; {
  name            = &quot;blog&quot;
  cluster         = &quot;${aws_ecs_cluster.cluster.id}&quot;
  task_definition = &quot;${aws_ecs_task_definition.task.arn}&quot;
  desired_count   = 1

  load_balancer = {
    target_group_arn = &quot;${aws_alb_target_group.main.arn}&quot;
    container_name   = &quot;blog&quot;
    container_port   = 80
  }

  launch_type = &quot;FARGATE&quot;

  network_configuration {
    security_groups = [&quot;${aws_security_group.awsvpc_sg.id}&quot;]
    subnets         = [&quot;${module.vpc.private_subnets}&quot;]
  }

  depends_on = [&quot;aws_alb_listener.main&quot;]
}</code></pre></div>
<p>That is the last part of coding, run <code class="language-text">terraform apply</code> and inspect the result.</p>
<p><asciinema-player src="/2018/01/30/microhack-fargate/fargate-terraform-4.json"
  cols="166" rows="15" autoplay="true" loop="true" speed="1.5">
</asciinema-player></p>
<p>That is all, we have now our blog running as serverless container in AWS Fargate.</p>
<a href="#">
    <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;">
    <span class="gatsby-resp-image-background-image" style="padding-bottom: 51.61290322580645%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsSAAALEgHS3X78AAABD0lEQVQoz42Ra27DIBCEuf9BepNKvUNSVyG8zCsmxhjsOO4E1P5rk+/HCsme2dldoqSSUva95lwopTjnt9vt/jf7vuecIbHWkjQ9SCldK+EaIN7/BRZLhWzbVpaCCr9xinlb9pch67qioRSCMXa5XOIYEeS+318StxhnSruuwxhSSK11m+25eCvjkgJk0KCz934YhpRmgFmeiJVxX9w654wxfd+HECDWFUzUcmGFMGq1sVbI+yG8fWiMPc+p1vlXgwcEpZQpxnYR0B7WGMQkOUWreNsWmh8PR5zaOyfr2Rk7CynxVf5UUaGnE8KSnAtXMDK4cYyxmifjLdNiCNdPqqyDlcMuHtV5Sil+ZpwjwjfzCD7rxWEvrwAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;"></span>
    <picture>
        <source srcset="/static/05b2cf60a35d313afb24fcc3ffa029f7/cc182/ecs-fargate.webp 148w,
/static/05b2cf60a35d313afb24fcc3ffa029f7/f7e40/ecs-fargate.webp 295w,
/static/05b2cf60a35d313afb24fcc3ffa029f7/1a2f4/ecs-fargate.webp 590w,
/static/05b2cf60a35d313afb24fcc3ffa029f7/4837b/ecs-fargate.webp 885w,
/static/05b2cf60a35d313afb24fcc3ffa029f7/1da3d/ecs-fargate.webp 1085w" sizes="(max-width: 590px) 100vw, 590px" type="image/webp">
        <source srcset="/static/05b2cf60a35d313afb24fcc3ffa029f7/cf440/ecs-fargate.png 148w,
/static/05b2cf60a35d313afb24fcc3ffa029f7/d2d38/ecs-fargate.png 295w,
/static/05b2cf60a35d313afb24fcc3ffa029f7/b9e4f/ecs-fargate.png 590w,
/static/05b2cf60a35d313afb24fcc3ffa029f7/f9b6a/ecs-fargate.png 885w,
/static/05b2cf60a35d313afb24fcc3ffa029f7/89595/ecs-fargate.png 1085w" sizes="(max-width: 590px) 100vw, 590px" type="image/png">
        <img class="gatsby-resp-image-image" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;" src="/static/05b2cf60a35d313afb24fcc3ffa029f7/b9e4f/ecs-fargate.png" alt="Fargate" title>
      </picture>
  </span>
</a>
<h2 id="mixing-ec2-and-fargate-on-ecs"><a href="#mixing-ec2-and-fargate-on-ecs" aria-label="mixing ec2 and fargate on ecs permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Mixing EC2 and Fargate on ECS</h2>
<p>Great we have now our container running in ECS with Fargate but what if we would like to move the container to a dedicated EC2 instances in ECS. Or what if we need that are not available in in Fargate, such as a volume mount? How difficult would it be to move our containers to an ECS cluster with dedicated EC2 instances? Time to do an experiment to see how difficult is is.</p>
<p>First we refactor the above code to some <a href="https://github.com/npalm/terraform-aws-ecs-service">generic ecs service modules</a> to be able to define our services with just a few lines of code. This module replaces all code of defining the load balancer, service and task. It still requires a VPC, ECS cluster, CloudWatch logging group, awsvpc security group and execution role. In the code you see a similar deployment of the blog but now with a generic ECS service module.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">locals {
  fg_container_name = &quot;blog&quot;
  fg_container_port = &quot;80&quot;
}

data &quot;template_file&quot; &quot;blog&quot; {
  template = &quot;${file(&quot;${path.root}/task-definition/blog.json&quot;)}&quot;

  vars {
    container_name   = &quot;${local.fg_container_name}&quot;
    container_port   = &quot;${local.fg_container_port}&quot;
    log_group_name   = &quot;${aws_cloudwatch_log_group.log_group.name}&quot;
    log_group_region = &quot;${var.aws_region}&quot;
    log_group_prefix = &quot;blog&quot;
  }
}

module &quot;blog-fg&quot; {
  source = &quot;npalm/ecs-service/aws&quot; // https://registry.terraform.io/modules/npalm/ecs-service/aws

  service_launch_type  = &quot;FARGATE&quot;
  service_name          = &quot;${local.fg_container_name}&quot;

  vpc_id       = &quot;${module.vpc.vpc_id}&quot;
  vpc_cidr     = &quot;${module.vpc.vpc_cidr}&quot;
  lb_subnetids = &quot;${module.vpc.public_subnets}&quot;
  ecs_cluster_id = &quot;${aws_ecs_cluster.cluster.id}&quot;
  lb_internal = false

  task_definition = &quot;${data.template_file.blog.rendered}&quot;
  task_cpu        = &quot;256&quot;
  task_memory     = &quot;512&quot;

  awsvpc_task_execution_role_arn = &quot;${aws_iam_role.ecs_tasks_execution_role.arn}&quot;
  awsvpc_service_security_groups = [&quot;${aws_security_group.awsvpc_sg.id}&quot;]
  awsvpc_service_subnetids       = &quot;${module.vpc.private_subnets}&quot;

  lb_target_group = {
    container_name = &quot;${local.fg_container_name}&quot;
    container_port = &quot;${local.fg_container_port}&quot;
  }

  lb_listener = {
    port     = 80
    protocol = &quot;HTTP&quot;
  }
}</code></pre></div>
<p>We still have our container not running in ECS on EC2 instances. For that we first have to create EC2 instances that will be attached to the same ECS cluster. For more details about create the EC2 instances see the <a href="https://github.com/npalm/terraform-aws-ecs-instances">ecs instance repo</a> on GitHub.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">locals {
  key_name = &quot;blog&quot;
  environment = &quot;dev&quot;
}

resource &quot;aws_key_pair&quot; &quot;key&quot; {
  key_name   = &quot;${local.key_name}&quot;
  public_key = &quot;${file(&quot;id_rsa&quot;)}&quot;
}

module &quot;ecs_instances&quot; {
  source  = &quot;npalm/ecs-instances/aws&quot; // https://registry.terraform.io/modules/npalm/ecs-instances/aws

  ecs_cluster_name = &quot;${aws_ecs_cluster.cluster.name}&quot;
  aws_region       = &quot;${local.aws_region}&quot;
  environment      = &quot;${local.environment}&quot;
  key_name         = &quot;${local.key_name}&quot;
  vpc_id           = &quot;${module.vpc.vpc_id}&quot;
  vpc_cidr         = &quot;${module.vpc.vpc_cidr}&quot;
  subnets          = &quot;${module.vpc.private_subnets}&quot;
}</code></pre></div>
<p>Now we have our EC2 instances available we only have to copy the the blog module above and change the launch type to <code class="language-text">EC2</code>, and our container will be deployed to a dedicated EC2 instance.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">module &quot;blog-ec&quot; {
  source = &quot;npalm/ecs-service/aws&quot; // https://registry.terraform.io/modules/npalm/ecs-service/aws

  service_launch_type  = &quot;FARGATE&quot;
  service_name          = &quot;blog-ec2&quot;

  ... SAME AS ABOVE ...
}</code></pre></div>
<p>That is all, all sample code is available at <a href="https://github.com/npalm/blog_terraform_aws_fargate">GitHub</a> see subdir <code class="language-text">fargate-ec2</code>. Time to run a <code class="language-text">terraform apply</code> to see if it works.</p>
<p><asciinema-player src="/2018/01/30/microhack-fargate/fargate-ec2.json"
  cols="166" rows="15" autoplay="true" loop="true" speed="1.5">
</asciinema-player></p>
<p>In the output you will find the two endpoint links to the blogs. After a few minutes both links will be active. You can also see the service running on the Amazon console, simply navigate to the ECS console and select the cluster. You should see now one service on Fargate and the second one on EC2.</p>
<a href="#">
    <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;">
    <span class="gatsby-resp-image-background-image" style="padding-bottom: 53.57142857142857%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsSAAALEgHS3X78AAABHUlEQVQoz5VSW3KEIBDk/nfIZXIPk1peykNU2IJVYUkvJPlKJZuuckqEHrubIZyLaZoopUopRllKqdZ6/xVGGyllCIHEGEG4NvirP8+z/oVSSs4ZXchxHOX+WHgfbnmv/wFZ15VROgwDZHvvt21D42fJ+DtolDHn3GytMQYqniWX/WoMOHb5Qmp4pgUZmLJ21lojc9dgrR3H8cfY4ajX/kJeXicfQooJ0e/7/m24b+dcYoodKfV6Q7RaKRwmapKcs7kBsXEh3OKgQmkthYAEDAJuVYhH7eCcYy5wTYRJNVwkrCJn3wDyu7ws6/pGpRiV0RpGECq6gzNKtONYYiLIFg8bjnuTCp14zpLd7nMpxh/h9jkzj61aEUTzkvuXD/s6ejsZi8g0AAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;"></span>
    <picture>
        <source srcset="/static/9bf9eac181171c2eb608b40db7953d4c/cc182/ecs-fargate-2.webp 148w,
/static/9bf9eac181171c2eb608b40db7953d4c/f7e40/ecs-fargate-2.webp 295w,
/static/9bf9eac181171c2eb608b40db7953d4c/1a2f4/ecs-fargate-2.webp 590w,
/static/9bf9eac181171c2eb608b40db7953d4c/4837b/ecs-fargate-2.webp 885w,
/static/9bf9eac181171c2eb608b40db7953d4c/fde25/ecs-fargate-2.webp 1092w" sizes="(max-width: 590px) 100vw, 590px" type="image/webp">
        <source srcset="/static/9bf9eac181171c2eb608b40db7953d4c/cf440/ecs-fargate-2.png 148w,
/static/9bf9eac181171c2eb608b40db7953d4c/d2d38/ecs-fargate-2.png 295w,
/static/9bf9eac181171c2eb608b40db7953d4c/b9e4f/ecs-fargate-2.png 590w,
/static/9bf9eac181171c2eb608b40db7953d4c/f9b6a/ecs-fargate-2.png 885w,
/static/9bf9eac181171c2eb608b40db7953d4c/a7b2a/ecs-fargate-2.png 1092w" sizes="(max-width: 590px) 100vw, 590px" type="image/png">
        <img class="gatsby-resp-image-image" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;" src="/static/9bf9eac181171c2eb608b40db7953d4c/b9e4f/ecs-fargate-2.png" alt="Fargate" title>
      </picture>
  </span>
</a></div></section></article></main></div><footer class="Footer__FooterWrapper-sc-1oxe0wr-0 hFicPH"><nav><div class="footer-col"><h5 class="footer-title">040 code © 2019</h5><span class="footer-item">Build with <i></i><a class="footer-link" href="https://www.gatsbyjs.org/">Gatsby</a></span></div><div class="footer-col"><h5 class="footer-title">Blog</h5><span class="footer-item"><a class="footer-link" href="/">home</a></span><span class="footer-item"><a class="footer-link" href="/about">about</a></span></div><div class="footer-col"><h5 class="footer-title">Source</h5><span class="footer-item"><i></i><a class="footer-link" href="https://github.com/040code/">Github</a></span></div></nav></footer></div></div><script>
  
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-97020149-1', 'auto', {});
      
      
      
      }
      </script><script id="gatsby-script-loader">/*<![CDATA[*/window.page={"componentChunkName":"component---src-templates-blog-post-js","jsonName":"2018-01-30-microhack-fargate-b27","path":"/2018/01/30/microhack-fargate"};window.dataPath="567/path---2018-01-30-microhack-fargate-b-27-c87-GS6JZ18n7LeiVx07F10hPWSg5Y";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-621948f53dbdfc1c8bad.js"],"component---node-modules-gatsby-plugin-offline-app-shell-js":["/component---node-modules-gatsby-plugin-offline-app-shell-js-e7d83f3aca32b19d7eca.js"],"component---src-templates-blog-list-template-js":["/component---src-templates-blog-list-template-js-4244168454bdd7b6ce63.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-1a3cb45e2a79586236db.js"],"component---src-templates-page-js":["/component---src-templates-page-js-402521215a074fde38f6.js"],"component---src-templates-tags-js":["/component---src-templates-tags-js-246b5f3ef84605384230.js"],"component---src-templates-authors-js":["/component---src-templates-authors-js-37440d40e7e7fdb64d34.js"],"component---src-pages-404-js":["/component---src-pages-404-js-11c3986ca33f38cfb2b8.js"],"pages-manifest":["/pages-manifest-d100a743a9d601d09545.js"]};/*]]>*/</script><script src="/webpack-runtime-5f413a8fb1a2f48d55a2.js" async=""></script><script src="/styles-13d2ee47eddc5325ccbc.js" async=""></script><script src="/1-90cb61cfcc26a11cdeca.js" async=""></script><script src="/3-4d73c1baf9953aba24ed.js" async=""></script><script src="/app-621948f53dbdfc1c8bad.js" async=""></script><script src="/component---src-templates-blog-post-js-1a3cb45e2a79586236db.js" async=""></script></body></html>